<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>?êÏú†?òÏ? ?àÏ∏° - ÏßëÌïÑ ?úÏä§??/title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* ÏßÑÌñâÎ•??ÅÌÉú Î∞?*/
        .progress-bar-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .progress-info h2 {
            font-size: 18px;
            margin: 0;
            font-weight: 600;
        }

        .progress-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .progress-stat {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 500;
        }

        .progress-bar-wrapper {
            flex: 1;
            max-width: 400px;
            margin: 0 30px;
        }

        .progress-bar-bg {
            background: rgba(255,255,255,0.3);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .progress-percentage {
            font-size: 20px;
            font-weight: 700;
            min-width: 60px;
            text-align: right;
        }

        .container {
            display: flex;
            height: calc(100vh - 54px);
        }

        /* ?¨Ïù¥?úÎ∞î - Î™©Ï∞® */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            flex-shrink: 0;
        }

        .sidebar h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .chapter-tree {
            list-style: none;
        }

        .chapter-item {
            margin: 5px 0;
        }

        .chapter-item-header {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            background: transparent;
            border: 1px solid #ccc;
            border-radius: 3px;
            transition: all 0.2s;
            flex-shrink: 0;
            user-select: none;
        }

        .toggle-btn:hover {
            background: #e0e0e0;
            color: #333;
            border-color: #999;
        }

        .toggle-btn.collapsed::before {
            content: '+';
        }

        .toggle-btn.expanded::before {
            content: '??;
        }

        .chapter-link {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #333;
            border-radius: 5px;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }

        .chapter-link:hover {
            background: #f0f0f0;
        }

        .chapter-link.active {
            background: #4CAF50;
            color: white;
        }

        .chapter-link.has-content {
            font-weight: 600;
            color: #4CAF50;
        }

        .chapter-link.has-content.active {
            color: white;
        }

        .sub-chapter {
            margin-left: 25px;
            overflow: hidden;
            max-height: 5000px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .sub-chapter.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        .sub-sub-chapter {
            margin-left: 25px;
            font-size: 13px;
            overflow: hidden;
            max-height: 5000px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .sub-sub-chapter.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏?*/
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
            min-width: 0;
        }

        /* Í∏Ä?∞Í∏∞ Í∞Ä?¥Îìú ?®ÎÑê */
        .guide-panel {
            width: 350px;
            background: #f9f9f9;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            flex-shrink: 0;
            display: none;
        }

        .guide-panel.active {
            display: block;
        }

        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }

        .guide-header h3 {
            font-size: 18px;
            color: #333;
            margin: 0;
        }

        .guide-content {
            line-height: 1.8;
            font-size: 14px;
            color: #555;
        }

        .guide-content h4 {
            font-size: 16px;
            color: #4CAF50;
            margin: 20px 0 10px 0;
        }

        .guide-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .guide-content li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .guide-loading {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .guide-loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .btn-guide {
            background: #9C27B0;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-guide:hover {
            background: #7B1FA2;
        }

        .content-header {
            padding: 20px 30px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-header h2 {
            font-size: 22px;
            color: #333;
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-small {
            padding: 5px 12px;
            font-size: 12px;
            background: #607D8B;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: #546E7A;
        }

        /* ?∏ÏßëÍ∏??ÅÏó≠ */
        .editor-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .view-mode {
            line-height: 1.8;
            font-size: 15px;
            color: #333;
        }

        .view-mode h1 {
            font-size: 28px;
            margin: 30px 0 20px 0;
            color: #222;
        }

        .view-mode h2 {
            font-size: 24px;
            margin: 25px 0 15px 0;
            color: #333;
        }

        .view-mode h3 {
            font-size: 20px;
            margin: 20px 0 10px 0;
            color: #444;
        }

        .view-mode p {
            margin: 15px 0;
        }

        .view-mode hr {
            margin: 30px 0;
            border: none;
            border-top: 2px solid #ddd;
        }

        .view-mode img {
            width: 80%;
            height: auto;
            margin: 20px auto;
            display: block;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .view-mode table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .view-mode table th,
        .view-mode table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .view-mode table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .toolbar {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .toolbar button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .toolbar button:hover {
            background: #f0f0f0;
        }

        #contentEditor {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
            line-height: 1.8;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            resize: vertical;
        }

        .content-editor-editable {
            background: white;
            overflow-y: auto;
            max-height: 600px;
        }

        .content-editor-editable:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .content-editor-editable img {
            width: 80%;
            height: auto;
            margin: 20px auto;
            display: block;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .content-editor-editable p {
            margin: 10px 0;
        }

        .content-editor-editable h1,
        .content-editor-editable h2,
        .content-editor-editable h3 {
            margin: 20px 0 10px 0;
        }

        .content-editor-editable table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .content-editor-editable table th,
        .content-editor-editable table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .content-editor-editable table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        #editorWrapper {
            position: relative;
        }

        #dropOverlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(76, 175, 80, 0.1);
            border: 3px dashed #4CAF50;
            border-radius: 5px;
            z-index: 100;
            pointer-events: none;
        }

        .attachments {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .attachments h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .attachment-list {
            list-style: none;
        }

        .attachment-item {
            padding: 10px;
            background: #f9f9f9;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attachment-item a {
            color: #2196F3;
            text-decoration: none;
        }

        .attachment-item a:hover {
            text-decoration: underline;
        }

        .file-upload-area {
            margin-top: 15px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: #4CAF50;
            background: #f9f9f9;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #999;
        }

        /* ?§ÌÅ¨Î°§Î∞î ?§Ì???*/
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .status-message.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- ÏßÑÌñâÎ•??ÅÌÉú Î∞?-->
    <div class="progress-bar-container">
        <div class="progress-info">
            <h2>?ìö ?êÏú†?òÏ? ?àÏ∏°</h2>
            <div class="progress-stats">
                <span class="progress-stat" id="pagesWritten">0 / 500 ?òÏù¥ÏßÄ</span>
                <span class="progress-stat" id="chaptersCompleted">0 / 0 Ï±ïÌÑ∞</span>
                <span class="progress-stat" id="totalChars">0 / 337,500 ??/span>
            </div>
        </div>
        <div class="progress-bar-wrapper">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;">
                    <span id="progressBarText"></span>
                </div>
            </div>
        </div>
        <div class="progress-percentage" id="progressPercentage">0%</div>
    </div>

    <div class="container">
        <!-- ?¨Ïù¥?úÎ∞î - Î™©Ï∞® -->
        <div class="sidebar">
            <h1>?ìñ ?êÏú†?òÏ? ?àÏ∏°</h1>
            <div style="margin-bottom: 15px; text-align: right;">
                <button id="collapseAllBtn" class="btn btn-small" style="font-size: 12px; padding: 5px 12px;">
                    ??Î™®Îëê ?ëÍ∏∞
                </button>
            </div>
            <ul class="chapter-tree" id="chapterTree">
                <!-- JavaScriptÎ°??ôÏ†Å ?ùÏÑ± -->
            </ul>
        </div>

        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏?-->
        <div class="main-content">
            <div class="content-header">
                <h2 id="contentTitle">Ï±ïÌÑ∞Î•??†ÌÉù?¥Ï£º?∏Ïöî</h2>
                <div class="content-actions" id="contentActions" style="display: none;">
                    <button class="btn btn-secondary" id="editBtn" style="display: none;">?òÏ†ï</button>
                    <button class="btn btn-primary" id="saveBtn" style="display: none;">?Ä??/button>
                    <button class="btn btn-danger" id="cancelBtn" style="display: none;">Ï∑®ÏÜå</button>
                </div>
            </div>

            <div class="editor-area" id="editorArea">
                <div class="empty-state">
                    <h3>?ìù ÏßëÌïÑ???úÏûë?òÏÑ∏??/h3>
                    <p>?ºÏ™Ω Î™©Ï∞®?êÏÑú Ï±ïÌÑ∞Î•??†ÌÉù?òÎ©¥ ?¥Ïö©???ëÏÑ±?òÍ±∞???òÏ†ï?????àÏäµ?àÎã§.</p>
                </div>
            </div>
        </div>

        <!-- Í∏Ä?∞Í∏∞ Í∞Ä?¥Îìú ?®ÎÑê -->
        <div class="guide-panel" id="guidePanel">
            <div class="guide-header">
                <h3>?çÔ∏è Í∏Ä?∞Í∏∞ Í∞Ä?¥Îìú</h3>
                <button class="btn-guide" id="regenerateGuideBtn" onclick="regenerateGuide()">?îÑ ?¨Í??¥Îìú ?ùÏÑ±</button>
            </div>
            <div class="guide-content" id="guideContent">
                <p style="color: #999; text-align: center; padding: 40px 20px;">Ï±ïÌÑ∞Î•??†ÌÉù?òÎ©¥ Í∏Ä?∞Í∏∞ Í∞Ä?¥ÎìúÍ∞Ä ?úÏãú?©Îãà??</p>
            </div>
        </div>
    </div>

    <script>
        // API Base URL ?§Ï†ï (Î°úÏª¨/?ÑÎ°ú?ïÏÖò ?êÎèô Í∞êÏ?)
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : window.location.origin;
        
        console.log('?îó API Base URL:', API_BASE_URL);
        
        // Î™©Ï∞® ?∞Ïù¥??        const tableOfContents = {
            "bookInfo": {
                title: "?ìã Ï±?Í∏∞Î≥∏ ?ïÎ≥¥",
                isSpecial: true
            },
            "prologue": {
                title: "?ÑÎ°§Î°úÍ∑∏: ?∏Î•ò???ôÎ™Ö, ?àÏ∏°???Ä??Í∞àÎßù",
                children: {
                    "p1": { title: "???∞Î¶¨???àÏ∏°?òÎ†§ ?òÎäîÍ∞Ä?" },
                    "p2": { title: "?àÏ∏°??Î≥∏Îä•: ?ùÏ°¥Í≥?Î≤àÏòÅ???ÑÌïú ?∏Î•ò????Ç¨" },
                    "p3": { title: "?àÏ∏°???±Í≥µ?àÏùÑ ?åÏùò Î≥¥ÏÉÅ: ??Ç¨ ???¨Î??Ä ?ÑÎ? ?¨Ìöå??Í∞ÄÏπ? },
                    "p4": { title: "Í∞ôÏ? ?§ÏàòÎ•?Î∞òÎ≥µ?òÎäî ?¥Ïú†: ?àÏ∏° Î∂àÍ??•ÏÑ±??Ï£ºÎäî Ï¢åÏ†àÍ≥??ºÎ?" },
                    "p5": { title: "?àÏ∏°???πÏúÑ?? ???òÏ? ?∂ÏùÑ ?ÑÌïú ?ÑÏàò?ÅÏù∏ ÏßÄ?? },
                    "p6": { title: "?àÏ∏°???ÑÌïú ?∏Î•ò???ÑÍµ¨?? Í≥ºÌïôÍ∏∞Ïà†?êÏÑú ?ôÏñë??ÏßÄ?úÍπåÏßÄ" },
                    "p7": { title: "?úÍ∞ÑÍ≥?Í≥µÍ∞Ñ???ΩÏñ¥?¥Îäî ?ÑÍµ¨: ?úÍ≥Ñ, ?¨Î†•, Ï≤úÎ¨∏?? },
                    "p8": { title: "?êÏó∞ ?ÑÏÉÅ ?àÏ∏°: ?†Ïî® ?àÏ∏°????Ç¨?Ä Î∞úÏ†Ñ" },
                    "p9": { title: "?¨Ìöå ?ÑÏÉÅ ?àÏ∏°: ??Ç¨??Î∞òÎ≥µ, ?†Ìñâ???úÌôò (?®ÏÖò, ?åÏïÖ)" },
                    "p10": { title: "ÎπÖÎç∞?¥ÌÑ∞?Ä AI: Î™®Îì† Í≥ºÌïôÍ∏∞Ïà†?Ä ?àÏ∏°???•Ìïú?? },
                    "p11": { title: "?àÏ∏°ÎßåÏùÑ ?ÑÌïú ?ôÎ¨∏: ?ôÏñë???êÏà†Í≥??¨Ï£ºÎ™ÖÎ¶¨" },
                    "p12": { title: "Í≥ºÌïôÍ∏∞Ïà†Î°??§Î™Ö?????ÜÎäî Í∏∞Ìò∏?Ä ?òÏ???Î¨∏Ï†ú" },
                    "p13": { title: "Í≤∞Í≥º?Ä Í≥ºÏ†ï: ?êÏà†/?¨Ï£ºÎ™ÖÎ¶¨Í∞Ä Í∞ÄÏß??ÖÌäπ???§Îìù?? },
                    "p14": { title: "'?êÎ£®Î≠âÏà†?? ?àÏ∏°???§Ìï¥?Ä 'Íµ¨Ï≤¥?îÎêú' ?àÏ∏°???ïÌôï?? },
                    "p15": { title: "?úÍµ≠, ?àÏ∏°???πÏù¥?? ?êÏà† ?úÏû•??ÎπÑÎ?" },
                    "p16": { title: "???∏Í≥Ñ ?∏Íµ¨ ?ÄÎπ??ïÎèÑ?ÅÏù∏ ?úÍµ≠???êÏà† ?úÏû•" },
                    "p17": { title: "?úÍµ≠ ?êÏà†???πÏù¥?? 'Í≥ºÍ±∞ ?¥ÏÜå'Î≥¥Îã§ 'ÎØ∏Îûò ?àÏ∏°'??ÏßëÏ§ë?òÎäî Î¨∏Ìôî" },
                    "p18": { title: "'?†Îì§???òÎùº' ?úÍµ≠???êÏà†???¥Í¥ë?òÎäî ?¥Ïú†" },
                    "p19": { title: "?êÏà†Í≥??¨Ï£ºÎ™ÖÎ¶¨??Í≤ΩÍ≥Ñ, Í∑∏Î¶¨Í≥?'??Ç¨Ï£????±Ïû•" },
                    "p20": { title: "?àÏ∏° ?¥Î°ú?úÏùò ?êÏà†Í≥??¨Ï£ºÎ™ÖÎ¶¨??Í≥µÌÜµ?êÍ≥º Ï∞®Ïù¥?? },
                    "p21": { title: "?¨Ï£ºÎ™ÖÎ¶¨: ?¨Î†•???êÎ¶¨??Í∏∞Î∞ò????ïô" },
                    "p22": { title: "?êÏà†????Í∞àÎûò: ?¨Ï£ºÎ™ÖÎ¶¨??ÎØ∏Î∂Ñ(?∏Î∂Ñ?? Í∞úÎÖêÍ≥??†Ï†ë(Á•ûÊé•)???∏Í≥Ñ" },
                    "p23": { title: "ÎπÑÍ≥º?ôÏ†Å Í∑ºÍ±∞???Ä??ÎπÑÌåêÍ≥?Í∑∏Îüº?êÎèÑ Î∂àÍµ¨?òÍ≥† ÎØøÎäî ?¥Ïú†" },
                    "p24": { title: "?àÏ∏°Î•†Ïùò ?úÍ≥Ñ: 70%?Ä 55%, ÎØøÏùÑ ???ÜÎäî ?àÏ∏°Í≥??åÎ¶Ñ ?ãÎäî ?àÏ∏°" },
                    "p25": { title: "?¨Ï£ºÎ™ÖÎ¶¨, ?§Îûò??Í∏∞Ïà†?????¥Ïú†" },
                    "p26": { title: "Î∞òÎßå????Ç¨ ?çÏóê??'?êÎ¶¨'Î≥¥Îã§ 'Í∏∞Ïà†'Î°??ÑÏàò??ÏßÄ?? },
                    "p27": { title: "?¥ÏÑ§?ÑÍ≤å ÎßûÏ?Îß? ??ÎßûÎäîÏßÄ??Î™∞Îûê??Í≥ºÍ±∞???úÍ≥Ñ" },
                    "p28": { title: "'ÎπÑÍ∏â'Í≥?'ÎπÑÎ?': ?àÏ∏°??Í∞ÄÏπòÍ? ÎßåÎì§?¥ÎÇ∏ ?êÏáÑ?? },
                    "p29": { title: "?àÎ°ú???àÏ∏°???úÎ?: '??Ç¨Ï£????ÑÏÉù Î∞∞Í≤Ω" },
                    "p30": { title: "Í≥ºÍ±∞???§Îßù???òÏñ¥???àÎ°ú???úÎèÑ" },
                    "p31": { title: "'?§Ìñâ???ïÏ≤¥'?Ä '?? Í∏????ÑÎ????¨Ìï¥?? },
                    "p32": { title: "?úÍ∞ÑÍ≥??êÎÑàÏßÄ: '??Ç¨Ï£?Í∞Ä ?àÏ∏°???àÎ°ú??ÏßÄ?âÏùÑ ?¥Îã§" }
                }
            },
            "part1": {
                title: "??Î∂Ä. '??Ç¨Ï£???Í∑ºÍ∞Ñ: ?åÏñë?§Ìñâ, Î≥Ä?îÌïò???êÎÑàÏßÄ",
                children: {
                    "1-1": {
                        title: "Î¨¥Í∑π?êÏÑú ?åÏñë?ºÎ°ú: Î™®Îì† Í≤ÉÏùò ?úÏûë",
                        children: {
                            "1-1-1": { title: "Î¨¥Í∑π???ÅÌÉú?Ä ?úÍ∞Ñ??Î∞úÏÉù" },
                            "1-1-2": { title: "?êÎÑàÏßÄ?Ä ?úÍ∞Ñ: ?ÑÏù∏?àÌ??∏Ïùò Î∞©Ï†ï?ùÏúºÎ°?Î≥?Í¥ÄÍ≥? },
                            "1-1-3": { title: "?åÏñë??Î∞úÏÉù: ?êÎÑàÏßÄ Ï∞®Ïù¥???òÌïú ?∏Ï∞®" },
                            "1-1-4": { title: "?åÏñë?êÏÑú ?§Ìñâ?ºÎ°ú: ?êÎÑàÏßÄ???êÎ¶ÑÍ≥?Í∑†Ìòï" },
                            "1-1-5": { title: "?§Ìñâ??Î∂ÑÌôî?Ä ?êÎÑàÏßÄ Ï§Ä?? },
                            "1-1-6": { title: "?§Ìñâ???πÏÑ±: Î™? ?? ?? Í∏? ?? }
                        }
                    },
                    "1-2": {
                        title: "Í≥†Ï†ï?ÅÏù¥ÏßÄ ?äÏ? ?§Ìñâ: Î∂àÎ??òÏ? ?äÍ≥† Î≥Ä?îÌïòÎ©??ÅÎ??ÅÏù∏ ?§Ìñâ",
                        children: {
                            "1-2-1": { title: "??∞Ñ(?ÅÂπ≤): Î≥Ä?îÌïò???§Ìñâ???úÌòÑ" },
                            "1-2-2": { title: "Ï≤úÍ∞Ñ???åÏñëÍ≥??§Ìñâ Î∂ÑÎ•ò" },
                            "1-2-3": { title: "??∞Ñ??Î¨ºÎ¶¨???êÏó∞???πÏßïÍ≥??Ä??Î¨ºÏÉÅ" }
                        }
                    },
                    "1-3": {
                        title: "?§Ìñâ???ÅÌò∏?ëÏö©: ????, Í∑???, Ï∂?Ê≤?, ????",
                        children: {
                            "1-3-1": { title: "Ï∂©Í≥º ?©Ïùò ?åÎèô??Ï¶ùÎ™Ö: Î≥¥Í∞ï Í∞ÑÏÑ≠Í≥??ÅÏáÑ Í∞ÑÏÑ≠" },
                            "1-3-2": { title: "?§Ìñâ???©Ìôî ?ÑÏÉÅ (Íµ¥Ï†à, ??ôî)" }
                        }
                    },
                    "1-4": {
                        title: "??Ñ±(?ÅÊòü): ?∏Í∞Ñ Î≥∏Ïó∞???ïÍµ¨?Ä ?êÎÑàÏßÄ",
                        children: {
                            "1-4-1": { title: "??Ñ±?¥Î? Î¨¥Ïóá?¥Î©∞, ???òÌ??òÎäîÍ∞Ä" },
                            "1-4-2": { title: "Î≥∏Ïõê(Í∏∞Ï? ?§Ìñâ)Í≥???Ñ±: ?òÏ? ?§Ìñâ??Í¥ÄÍ≥?(?°Ïπú)" },
                            "1-4-3": { title: "??Ñ±???êÎ¶¨: ?êÎÑàÏßÄ Ï§Ä?ÑÏ? ?¨Î¶¨???âÎèô???πÏÑ±" }
                        }
                    },
                    "1-5": { title: "?†Ï≤¥(ÏßàÎüâÏ≤?Î•?ÏßÄ?òÎäî ??∞Ñ??ÏßÄ???ÑÏÉÅ: 12ÏßÄÏßÄ???ÑÏÉù ?êÎ¶¨" }
                }
            },
            "part2": {
                title: "??Î∂Ä. ?¥Í≥º Í∏? ?úÍ∞ÑÍ≥??êÎÑàÏßÄ???§Ï≤¥??Î∞úÌòÑ",
                children: {
                    "2-1": {
                        title: "????Í≥?Í∏?Ê∞???Î™ÖÎ™Ö: Ï≤úÍ∞ÑÍ≥?ÏßÄÏßÄ",
                        children: {
                            "2-1-1": { title: "??Ï≤úÍ∞Ñ): ?? ?úÏ†ê, Ï£ºÍ∏∞??Î≥Ä?? },
                            "2-1-2": { title: "Í∏?ÏßÄÏßÄ): Í∏∞ÏÑ∏, ?êÎÑàÏßÄ, ?? Ï£ºÎ? ?òÍ≤Ω???ÅÌñ•" },
                            "2-1-3": { title: "?¥Í∏∞(?ãÊ∞£)???§Ï†ú: Ï≤úÍ∞Ñ?Ä Í∏∞Î? ?¥Îäî Í∑∏Î¶á" }
                        }
                    },
                    "2-2": {
                        title: "?¥Í∏∞???êÏó∞ ?ÑÏÉÅ: Í≥ºÌïô???∞Í≤∞Í≥†Î¶¨",
                        children: {
                            "2-2-1": { title: "?êÏûê???ÑÏûê ?§ÎπÑ?àÍ≥º Ï±ÑÏ? ?úÏÑú" },
                            "2-2-2": { title: "?ÑÌååÎØºÍ≥º ?ÑÌååÎØ??òÏö©Ï≤? },
                            "2-2-3": { title: "?∏Î•¥Î™¨Í≥º ?∏Î•¥Î™??òÏö©Ï≤? },
                            "2-2-4": { title: "Í∞ÅÏ¢Ö Î∞îÏù¥?¨Ïä§?Ä ?ëÏ¥â ?òÏö©Ï≤? },
                            "2-2-5": { title: "?®Ïûê?Ä ?¨Ïûê???±Í∏∞ Î™®Ïäµ Ï∞®Ïù¥: ?¥Í∏∞?Ä ÏßàÎüâÏ≤¥Ïùò Í¥ÄÍ≥? }
                        }
                    },
                    "2-3": {
                        title: "60Í∞ëÏûê: ?¥Í∏∞??Í∏∞Î≥∏ Íµ¨ÏÑ± ?êÎ¶¨",
                        children: {
                            "2-3-1": { title: "60Í∞ëÏûê??Ï¢ÖÎ•ò?Ä ?êÏ≤¥ ?¨Í∞Ñ" }
                        }
                    },
                    "2-4": {
                        title: "ÏßÄÏßÄ(?∞ÊîØ)?Ä ÏßÄ?•Í∞Ñ(?∞ËóèÂπ?: ?¥Í∏∞ Î∞úÌòÑ??ÍπäÏù¥",
                        children: {
                            "2-4-1": { title: "12ÏßÄÏßÄ??Íµ¨ÏÑ±Í≥?ÏßÄ?•Í∞Ñ??Î∞úÌòÑ ?úÏÑú" },
                            "2-4-2": { title: "ÏßÄ?•Í∞Ñ???òÏπò: Í∏∞Ïùò ?¨Í∏∞" }
                        }
                    },
                    "2-5": {
                        title: "?¨Í∞Ñ(?èÂπ≤): ÏßÄ?•Í∞Ñ???êÎÑàÏßÄÍ∞Ä Ï≤úÍ∞Ñ?ºÎ°ú Î∞úÌòÑ?òÎäî ?ÑÏÉÅ",
                        children: {
                            "2-5-1": { title: "?†Í∞ï(Ë∫´Âº∫)Í≥??†ÏïΩ(Ë∫´Âº±)???¨Ìï¥?? }
                        }
                    },
                    "2-6": {
                        title: "?¨Ï£º?îÏûê: ?∂Ïùò ?¥Í∏∞ Íµ¨Ï°∞",
                        children: {
                            "2-6-1": { title: "?ÑÏõî?ºÏãú ?¨Ï£º??Íµ¨ÏÑ±Í≥??òÎ?" },
                            "2-6-2": { title: "?¨Ï£º??Í∏∞Ï†ê: Ï∂úÏÉù ?úÏ†ê???ïÌï¥ÏßÄ???¥Í∏∞" },
                            "2-6-3": { title: "?ºÏÉÅ?ùÌôú?êÏÑú ?¨Ï£º???ëÎèô ?êÎ¶¨ Í≤ΩÌóò" }
                        }
                    },
                    "2-7": {
                        title: "?ÑÏö¥(?æÈÅã): ?§Îäò???¥ÏÑ∏?Ä ?¨Ï£º???ÅÌò∏?ëÏö©",
                        children: {
                            "2-7-1": { title: "?¨Îü¨ ?¥Í∏∞???ôÏãú ?ëÏö© Í≥ÑÏÇ∞: ?åÏñë ?ºÌï©Î°? },
                            "2-7-2": { title: "?¥Í∏∞???ëÎèô Î™®Îç∏: ?Ä??Í≤åÏûÑ ÎπÑÏú†" }
                        }
                    }
                }
            },
            "part3": {
                title: "??Î∂Ä. '??Ç¨Ï£? ?µÏã¨ ?¥Î°†: Î≥∏Ïõê ?¥Îèô, ?òÏö©?? ?©Ìôî",
                children: {
                    "3-1": {
                        title: "Î≥∏Ïõê(?¨Ê∫ê) ?¥ÎèôÎ°? ?∂Ïùò Î≥Ä?îÎ? ?ΩÎäî ?àÎ°ú??Í∏∞Ï???,
                        children: {
                            "3-1-1": { title: "Í∑ºÎ¨ò?îÏã§(?πËãó?±Â?) ?êÎ¶¨Î∂Ä???úÏûë?òÎäî Î≥∏Ïõê??Î≥Ä?? },
                            "3-1-2": { title: "Î≥∏Ïõê?¥Îèô???úÍ∏∞: 18??Ï£ºÍ∏∞?Ä Í∑?Ï¶ùÍ±∞" },
                            "3-1-3": { title: "?òÏù¥Í∞Ä ?§ÏàòÎ°?Ï£ΩÏùå???¥Î•¥??Í≥ºÏ†ï: ?ùÎ™Ö?Ä ?åÏö©?åÏù¥?Ä Í∞ôÎã§" }
                        }
                    },
                    "3-2": {
                        title: "?òÏö©???óÂ???Î°? ??∞Ñ ?ÄÏßÅÏûÑ???êÎ¶¨",
                        children: {
                            "3-2-1": { title: "?åÏñë?§Ìñâ ?êÎ¶¨???∏Î∂Ñ?? },
                            "3-2-2": { title: "?†Ï≤¥(ÏßàÎüâÏ≤????Ä??ÏßÄÏ≤?Î∞?Î≥µÏÇ¨ ?ÑÏÉÅ" },
                            "3-2-3": { title: "?¥ÏÑ±ÏßàÏ≤¥(ÏßùÏàò): ?§Î•∏Ï™??òÏÑ†Îß?Ï°¥Ïû¨?òÎäî ?∏ÏÉÅ" },
                            "3-2-4": { title: "Ï≤úÍ∞Ñ??Í∞úÏàò Ï¶ùÍ?Í∞Ä ?¥Ïùò Í∞êÏÜåÎ•??òÎ??òÎäî ?¥Ïú†" },
                            "3-2-5": { title: "ÏßÄ?•Í∞Ñ???¨Í∏∞?Ä ?¥Ïùò ?¨Í∏∞ Î∞??•Î†•" }
                        }
                    },
                    "3-3": {
                        title: "?©Ìôî(?àÂåñ)Î°? ?¥Í∏∞??Î°úÎ†åÏ∏??òÎπÑ Í≥°ÏÑ†",
                        children: {
                            "3-3-1": { title: "?§Ìñâ???©Ìôî: Î≥∏Îûò???§Ìñâ??Î≤ÑÎ¶¨Í≥??§Î•∏ ?§Ìñâ?ºÎ°ú Î∞îÎÄåÎäî ?ÑÏÉÅ" },
                            "3-3-2": { title: "ÏßÄ?•Í∞Ñ???¨Í∏∞?Ä ?©Ìôî: ?§Ïö¥???òÎπÑ" },
                            "3-3-3": { title: "Î°úÎ†åÏ∏†Ïùò ?òÎπÑ Í≥°ÏÑ†Í≥??©Ìôî ?ÑÏÉÅ???†ÏÇ¨?? }
                        }
                    }
                }
            },
            "part4": {
                title: "??Î∂Ä. '??Ç¨Ï£????§Ïñë???? ?∂Ïùò ?êÎÑàÏßÄÎ•??ΩÎã§",
                children: {
                    "4-1": {
                        title: "?∏Ï≤¥???¥Í∏∞: Ï§ëÏö¥(‰∏?Åã)",
                        children: {
                            "4-1-1": { title: "?∏Î•ò Î≥¥Ìé∏???†Ï≤¥???πÏßïÍ≥??¥Í∏∞ Î≥Ä?îÏùò Í¥ÄÍ≥? },
                            "4-1-2": { title: "5??Ï£ºÍ∏∞ Ï≤¥Ï§ë?¥Ïùò ?úÏûëÍ≥?Î≥Ä?? },
                            "4-1-3": { title: "Í≤ΩÎùΩ???µÌïú ?¥Í∏∞???êÎÇå" },
                            "4-1-4": { title: "Í≤ΩÎùΩ???ùÏÑ±Í≥??§Ìñâ Î∞òÏùë" },
                            "4-1-5": { title: "?§ÌñâÎ≥?Ï≤¥ÏßàÍ≥??πÏßï" },
                            "4-1-6": { title: "?§ÌñâÍ≥??úÏ†ï: ?¥Í∏∞Í∞Ä Í∞êÏ†ï??ÎØ∏Ïπò???ÅÌñ•" }
                        }
                    },
                    "4-2": {
                        title: "?∂Ïùò ???êÎ¶Ñ: Ï≤¥Ïû•?¥Í≥º ?Ä??,
                        children: {
                            "4-2-1": { title: "?Ä?? ?îÏö¥??10??Ï£ºÍ∏∞ Î≥Ä?? },
                            "4-2-2": { title: "Ï≤¥Î??? Í∑ºÎ¨ò?îÏã§???êÎ¶¨???òÌïú 18??Ï£ºÍ∏∞ Î≥Ä?? },
                            "4-2-3": { title: "?êÎÑàÏßÄ ?êÎ¶Ñ???∞Î•∏ Ï∞®Ïù¥ ?∏Ïãù" }
                        }
                    },
                    "4-3": {
                        title: "?ÑÏû¨???? ?ÑÏö¥(?æÈÅã)",
                        children: {
                            "4-3-1": { title: "?ÑÏö¥: ?ÑÏû¨???ÑÏõî?ºÏãú ?¥Í∏∞" },
                            "4-3-2": { title: "?ÑÏö¥???§Ïñë?±Í≥º Í≥µÌÜµ ?ÅÏö©" },
                            "4-3-3": { title: "?¨Ï£º?Ä ?ÑÏö¥???©Ï≥êÏß??¥ÏÑù??Ï§ëÏöî?? }
                        }
                    },
                    "4-4": {
                        title: "?•ÏÜå???¥Í∏∞: ÏßÄ?¥Í≥º ?•Ïö¥",
                        children: {
                            "4-4-1": { title: "ÏßÄ?? ÏßÄÍµ¨Ïùò Í≤ΩÎèÑÎ≥??ÑÎèÑÎ≥??§Ìñâ ?§Ï†ïÍ≥??ëÏö©" },
                            "4-4-2": { title: "ÏßÄ?¥Ïùò ?úÍ∏∞Î≥?Î≥Ä?? ?úÏñë??Í≥†ÎèÑ?Ä ?êÎÑàÏßÄ Î≥¥Ï†ï" },
                            "4-4-3": { title: "?•Ïö¥: 20??Ï£ºÍ∏∞???? ?çÏàòÏßÄÎ¶¨Ï? ?ÑÏüÅ/?ïÎ≥µ????Ç¨" },
                            "4-4-4": { title: "ÏßÄ?¥Ïùò ?πÏßï Î∞?Í∞úÏö¥Î≤??úÏö©" }
                        }
                    }
                }
            },
            "part5": {
                title: "??Î∂Ä. '??Ç¨Ï£? ?àÏ∏°???ÑÏÑ±: ?∏ÏÉù Í∑∏Îûò?ÑÏ? Í∞úÏö¥ ?ÑÎûµ",
                children: {
                    "5-1": {
                        title: "?∏ÏÉù Í∑∏Îûò?ÑÏùò ?ÑÏ∂úÍ≥?Í∏∞Î≥∏ ?¥ÏÑù",
                        children: {
                            "5-1-1": { title: "'??Ç¨Ï£? ?∏ÏÉù Í∑∏Îûò?ÑÏùò ??ï†" },
                            "5-1-2": { title: "Ï∂©Ïùò ?ÅÏö©Í≥?Í∑∏Îûò???¥ÏÑù" },
                            "5-1-3": { title: "??Ñ±Í≥??©ÌôîÎ°?Í∑∏Îûò??Î≥¥Îäî Î∞©Î≤ï" }
                        }
                    },
                    "5-2": {
                        title: "?àÏ∏°???ïÌôï?±ÏùÑ ?íÏù¥???§Ï∞® ?òÏ†ï",
                        children: {
                            "5-2-1": { title: "Í∑†ÏãúÏ∞®Ï? ?úÏñë?? },
                            "5-2-2": { title: "?¨Î†• ?§Ï∞®: ÏßÄÍµ?Í≥µÏ†Ñ?ºÍ≥º ?§ÎÖÑ???ÅÌñ•" },
                            "5-2-3": { title: "?? ?? ?ÑÏù¥ Î∞îÎÄåÎäî ?¨Ïù∏?? },
                            "5-2-4": { title: "?¥Í∏∞??Î∂àÌôï?§ÏÑ±: ÎØ∏Î∞úÍ≤??¥Í∏∞ Î∞??àÏ∏°???úÍ≥Ñ" }
                        }
                    },
                    "5-3": {
                        title: "'??Ç¨Ï£? ?§Ï†Ñ ?¥ÏÑù ?¨Î?",
                        children: {
                            "5-3-1": { title: "?§Ï†ú ?∏ÏÉù Í∑∏Îûò?ÑÏ? ?¨Î?Î•??µÌïú ?¥ÏÑù Î∞©Î≤ï" },
                            "5-3-2": { title: "?¨Í≥† ?¨Î? Î∂ÑÏÑù: ?¥Í∏∞ ?ëÏö© Í≥ºÏ†ï" },
                            "5-3-3": { title: "Í∂ÅÌï© ?¨Î? Î∂ÑÏÑù" }
                        }
                    },
                    "5-4": {
                        title: "'??Ç¨Ï£?Î•??µÌïú Í∞úÏö¥ ?ÑÎûµ",
                        children: {
                            "5-4-1": { title: "?¥Í∏∞???ëÎèô Í≥ºÏ†ï: ?∏Î? ?? Í≥†Ïú† ?? ?†ÌÉùÍ≥??òÏ?" },
                            "5-4-2": { title: "?¥ÏÑ∏??Î≥Ä??Ï°∞Ï†ï" },
                            "5-4-3": { title: "Ï¢ãÏ? ?¥Ïùò Í∑πÎ??îÏ? ?òÏÅú ?¥Ïùò ?åÌîº ?ÑÎûµ" },
                            "5-4-4": { title: "Í≤∞Ìòº, ?¨ÏóÖ, Ï∑®ÏóÖ ?±Ïóê ?¥Í∏∞Í∞Ä ÎØ∏Ïπò???ÅÌñ•Í≥??úÏö©" }
                        }
                    }
                }
            },
            "epilogue": {
                title: "?êÌïÑÎ°úÍ∑∏: AI ?úÎ?, '??Ç¨Ï£??Ä ?ÅÏÉù?òÎã§",
                children: {
                    "e1": { title: "AI?Ä??Í≤ΩÏüÅÍ≥??ÅÏÉù: ?∏Í∞Ñ ?àÏ∏°??Í∞ÄÏπ? },
                    "e2": { title: "'??Ç¨Ï£?Í∞Ä ?úÏãú?òÎäî ?∂Ïùò ?àÎ°ú??ÏßÄ?ÑÏ? ?µÏ∞∞" },
                    "e3": { title: "'??Ç¨Ï£? Í≥µÎ????òÎ??Ä ?úÏö© Î∞©Ïïà" },
                    "e4": { title: "'??Ç¨Ï£????úÍ≥Ñ?Ä Í∞úÏö¥??Í∞Ä?•ÏÑ±" }
                }
            }
        };

        let currentChapterId = null;
        let isEditMode = false;
        let originalContent = '';
        let chapterData = {};

        const TOTAL_PAGES = 500;
        const CHARS_PER_PAGE = 675; // A5 Í∏∞Ï?, 25??√ó 27??= 675??
        // ?òÏù¥ÏßÄ Î°úÎìú ??Ï¥àÍ∏∞??        document.addEventListener('DOMContentLoaded', async () => {
            await loadChapterData();
            renderChapterTree();
            updateProgress();
            
            // Î™®Îëê ?ëÍ∏∞/?ºÏπòÍ∏?Î≤ÑÌäº ?¥Î≤§??            const collapseBtn = document.getElementById('collapseAllBtn');
            let isAllCollapsed = false;
            
            collapseBtn.addEventListener('click', () => {
                const allToggles = document.querySelectorAll('.toggle-btn');
                const allSubLists = document.querySelectorAll('.sub-chapter, .sub-sub-chapter');
                
                if (isAllCollapsed) {
                    // Î™®Îëê ?ºÏπòÍ∏?                    allToggles.forEach(btn => {
                        btn.classList.remove('collapsed');
                        btn.classList.add('expanded');
                    });
                    allSubLists.forEach(ul => {
                        ul.classList.remove('collapsed');
                    });
                    collapseBtn.textContent = '??Î™®Îëê ?ëÍ∏∞';
                    isAllCollapsed = false;
                } else {
                    // Î™®Îëê ?ëÍ∏∞
                    allToggles.forEach(btn => {
                        btn.classList.remove('expanded');
                        btn.classList.add('collapsed');
                    });
                    allSubLists.forEach(ul => {
                        ul.classList.add('collapsed');
                    });
                    collapseBtn.textContent = '+ Î™®Îëê ?ºÏπòÍ∏?;
                    isAllCollapsed = true;
                }
            });
        });

        // ÏßÑÌñâÎ•?Í≥ÑÏÇ∞
        function calculateProgress() {
            let totalChars = 0;
            let completedChapters = 0;
            let totalChapters = 0;

            // Î™®Îì† Ï±ïÌÑ∞ ?úÌöå
            function countChapters(obj, prefix = '') {
                Object.keys(obj).forEach(key => {
                    if (key === 'bookInfo') return; // Ï±?Í∏∞Î≥∏ ?ïÎ≥¥???úÏô∏
                    
                    const fullKey = prefix ? `${prefix}-${key}` : key;
                    const item = obj[key];

                    if (item.children) {
                        countChapters(item.children, fullKey);
                    } else {
                        totalChapters++;
                        const data = chapterData[fullKey];
                        if (data && data.content) {
                            // HTML ?úÍ∑∏ ?úÍ±∞?òÍ≥† ?çÏä§?∏Îßå Ïπ¥Ïö¥??                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = data.content;
                            const textContent = tempDiv.textContent || tempDiv.innerText || '';
                            const chars = textContent.trim().length;
                            
                            if (chars > 0) {
                                totalChars += chars;
                                if (chars >= 100) { // ÏµúÏÜå 100???¥ÏÉÅ?¥Î©¥ ?ÑÎ£åÎ°?Í∞ÑÏ£º
                                    completedChapters++;
                                }
                            }
                        }
                    }
                });
            }

            countChapters(tableOfContents);

            const pagesWritten = Math.floor(totalChars / CHARS_PER_PAGE);
            const percentage = Math.min(100, (pagesWritten / TOTAL_PAGES) * 100);

            return {
                pagesWritten,
                totalPages: TOTAL_PAGES,
                percentage: percentage.toFixed(1),
                completedChapters,
                totalChapters,
                totalChars
            };
        }

        // ÏßÑÌñâÎ•?UI ?ÖÎç∞?¥Ìä∏
        function updateProgress() {
            const progress = calculateProgress();

            document.getElementById('pagesWritten').textContent = 
                `${progress.pagesWritten} / ${progress.totalPages} ?òÏù¥ÏßÄ`;
            
            document.getElementById('chaptersCompleted').textContent = 
                `${progress.completedChapters} / ${progress.totalChapters} Ï±ïÌÑ∞`;
            
            // Ï¥?Í∏Ä?êÏàò ?úÏãú (Ï≤??®ÏúÑ ?ºÌëú Ï∂îÍ?)
            document.getElementById('totalChars').textContent = 
                `${progress.totalChars.toLocaleString()} / 337,500 ??;
            
            document.getElementById('progressPercentage').textContent = 
                `${progress.percentage}%`;
            
            const fillElement = document.getElementById('progressBarFill');
            fillElement.style.width = `${progress.percentage}%`;
            
            // ÏßÑÌñâÎ•†Ïóê ?∞Î•∏ ?âÏÉÅ Î≥ÄÍ≤?            const percentage = parseFloat(progress.percentage);
            let gradientColor;
            if (percentage < 30) {
                gradientColor = 'linear-gradient(90deg, #f44336 0%, #e91e63 100%)'; // Îπ®Í∞ï
            } else if (percentage < 70) {
                gradientColor = 'linear-gradient(90deg, #FF9800 0%, #FFC107 100%)'; // ?∏Îûë
            } else {
                gradientColor = 'linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%)'; // Ï¥àÎ°ù
            }
            fillElement.style.background = gradientColor;
            
            if (progress.percentage > 5) {
                document.getElementById('progressBarText').textContent = 
                    `${progress.percentage}%`;
            } else {
                document.getElementById('progressBarText').textContent = '';
            }
        }

        // Ï±ïÌÑ∞ ?∞Ïù¥??Î°úÎìú
        async function loadChapterData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/chapters`);
                chapterData = await response.json();
            } catch (error) {
                console.error('?∞Ïù¥??Î°úÎìú ?§Ìå®:', error);
                showMessage('?∞Ïù¥?∞Î? Î∂àÎü¨?§Îäî???§Ìå®?àÏäµ?àÎã§.', true);
            }
        }

        // Î™©Ï∞® ?∏Î¶¨ ?åÎçîÎß?        function renderChapterTree() {
            const treeElement = document.getElementById('chapterTree');
            treeElement.innerHTML = '';

            Object.keys(tableOfContents).forEach(key => {
                const chapter = tableOfContents[key];
                const li = document.createElement('li');
                li.className = 'chapter-item';

                // ?§Îçî Ïª®ÌÖå?¥ÎÑà ?ùÏÑ±
                const header = document.createElement('div');
                header.className = 'chapter-item-header';

                // ?êÏãù???àÏúºÎ©??†Í? Î≤ÑÌäº Ï∂îÍ?
                if (chapter.children) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn expanded';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleChapter(toggleBtn);
                    };
                    header.appendChild(toggleBtn);
                }

                const link = document.createElement('a');
                link.className = 'chapter-link' + (chapterData[key]?.content ? ' has-content' : '');
                link.textContent = chapter.title;
                link.onclick = () => selectChapter(key);

                header.appendChild(link);
                li.appendChild(header);

                if (chapter.children) {
                    const subUl = document.createElement('ul');
                    subUl.className = 'chapter-tree sub-chapter';
                    renderSubChapters(chapter.children, subUl, key);
                    li.appendChild(subUl);
                }

                treeElement.appendChild(li);
            });
        }

        // ?òÏúÑ Ï±ïÌÑ∞ ?åÎçîÎß?        function renderSubChapters(children, parentElement, prefix) {
            Object.keys(children).forEach(key => {
                const child = children[key];
                const fullKey = prefix + '-' + key;
                
                const li = document.createElement('li');
                li.className = 'chapter-item';

                // ?§Îçî Ïª®ÌÖå?¥ÎÑà ?ùÏÑ±
                const header = document.createElement('div');
                header.className = 'chapter-item-header';

                // ?êÏãù???àÏúºÎ©??†Í? Î≤ÑÌäº Ï∂îÍ?
                if (child.children) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn expanded';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleChapter(toggleBtn);
                    };
                    header.appendChild(toggleBtn);
                }

                const link = document.createElement('a');
                link.className = 'chapter-link' + (chapterData[fullKey]?.content ? ' has-content' : '');
                link.textContent = child.title;
                link.onclick = () => selectChapter(fullKey);

                header.appendChild(link);
                li.appendChild(header);

                if (child.children) {
                    const subUl = document.createElement('ul');
                    subUl.className = 'chapter-tree sub-sub-chapter';
                    renderSubChapters(child.children, subUl, fullKey);
                    li.appendChild(subUl);
                }

                parentElement.appendChild(li);
            });
        }

        // Ï±ïÌÑ∞ ?†Í? (?ëÍ∏∞/?ºÏπòÍ∏?
        function toggleChapter(button) {
            const li = button.closest('.chapter-item');
            const subList = li.querySelector('ul');
            
            if (!subList) return;

            if (button.classList.contains('expanded')) {
                // ?ëÍ∏∞
                button.classList.remove('expanded');
                button.classList.add('collapsed');
                subList.classList.add('collapsed');
            } else {
                // ?ºÏπòÍ∏?                button.classList.remove('collapsed');
                button.classList.add('expanded');
                subList.classList.remove('collapsed');
            }
        }

        // Ï±ïÌÑ∞ ?†ÌÉù
        async function selectChapter(chapterId) {
            if (isEditMode && currentChapterId !== chapterId) {
                if (!confirm('?Ä?•ÌïòÏßÄ ?äÏ? ?¥Ïö©???àÏäµ?àÎã§. Í≥ÑÏÜç?òÏãúÍ≤†Ïäµ?àÍπå?')) {
                    return;
                }
            }

            currentChapterId = chapterId;
            
            // Î™®Îì† ÎßÅÌÅ¨?êÏÑú active ?úÍ±∞
            document.querySelectorAll('.chapter-link').forEach(link => {
                link.classList.remove('active');
            });

            // ?ÑÏû¨ ÎßÅÌÅ¨??active Ï∂îÍ?
            event.target.classList.add('active');

            // Ï±ïÌÑ∞ ?∞Ïù¥??Î°úÎìú
            await loadChapterContent(chapterId);
            
            // Í∞Ä?¥Îìú ?®ÎÑê ?úÏãú Î∞?Í∞Ä?¥Îìú ?ùÏÑ±
            showGuidePanel();
            await generateGuide(chapterId);
        }

        // Ï±ïÌÑ∞ ?¥Ïö© Î°úÎìú
        async function loadChapterContent(chapterId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/chapters/${chapterId}`);
                const data = await response.json();

                const title = getChapterTitle(chapterId);
                document.getElementById('contentTitle').textContent = title;
                document.getElementById('contentActions').style.display = 'flex';

                if (data.content) {
                    // ?¥Ïö©???àÏúºÎ©?Î∑?Î™®ÎìúÎ°??úÏãú
                    renderViewMode(data);
                } else {
                    // ?¥Ïö©???ÜÏúºÎ©?Î∞îÎ°ú ?∏Ïßë Î™®Îìú
                    enterEditMode({ content: '', attachments: [] });
                }
            } catch (error) {
                console.error('Ï±ïÌÑ∞ Î°úÎìú ?§Ìå®:', error);
                showMessage('Ï±ïÌÑ∞Î•?Î∂àÎü¨?§Îäî???§Ìå®?àÏäµ?àÎã§.', true);
            }
        }

        // Ï±ïÌÑ∞ ?úÎ™© Í∞Ä?∏Ïò§Í∏?        function getChapterTitle(chapterId) {
            const parts = chapterId.split('-');
            
            if (parts.length === 1) {
                return tableOfContents[parts[0]]?.title || '';
            } else if (parts.length === 2) {
                return tableOfContents[parts[0]]?.children[parts[1]]?.title || '';
            } else if (parts.length === 3) {
                return tableOfContents[parts[0]]?.children[parts[1]]?.children[parts[2]]?.title || '';
            }
            
            return '';
        }

        // Î∑?Î™®Îìú ?åÎçîÎß?        function renderViewMode(data) {
            isEditMode = false;
            document.getElementById('editBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';

            const editorArea = document.getElementById('editorArea');
            editorArea.innerHTML = `
                <div class="view-mode">
                    ${data.content}
                </div>
                ${renderAttachments(data.attachments || [], false)}
            `;
        }

        // ?∏Ïßë Î™®Îìú ÏßÑÏûÖ
        function enterEditMode(data) {
            isEditMode = true;
            originalContent = data.content;
            
            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'inline-block';

            const editorArea = document.getElementById('editorArea');
            editorArea.innerHTML = `
                <div class="toolbar">
                    <button onclick="insertFormat('h1')">?úÎ™© 1</button>
                    <button onclick="insertFormat('h2')">?úÎ™© 2</button>
                    <button onclick="insertFormat('h3')">?úÎ™© 3</button>
                    <button onclick="insertFormat('hr')">Íµ¨Î∂Ñ??/button>
                    <button onclick="insertFormat('table')">???ΩÏûÖ</button>
                    <button onclick="insertFormat('bold')">ÍµµÍ≤å</button>
                    <button onclick="insertFormat('italic')">Í∏∞Ïö∏??/button>
                    <button onclick="document.getElementById('imageInput').click()" style="background: #FF9800; color: white;">?ñºÔ∏??¥Î?ÏßÄ</button>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="insertImage(this)">
                </div>
                <div id="editorWrapper" style="position: relative;">
                    <div id="contentEditor" contenteditable="true" class="content-editor-editable">${data.content || '<p>?¥Ïö©???ÖÎ†•?òÏÑ∏??..</p>'}</div>
                    <div id="dropOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(76, 175, 80, 0.1); border: 3px dashed #4CAF50; border-radius: 5px; display: flex; align-items: center; justify-content: center; pointer-events: none;">
                        <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h3 style="color: #4CAF50; margin: 0;">?ñºÔ∏??¥Î?ÏßÄÎ•??¨Í∏∞???úÎ°≠?òÏÑ∏??/h3>
                        </div>
                    </div>
                </div>
                ${renderAttachments(data.attachments || [], true)}
            `;

            // ?úÎûòÍ∑????úÎ°≠ ?¥Î≤§???§Ï†ï
            setupDragAndDrop();
        }

        // ?úÎûòÍ∑????úÎ°≠ ?§Ï†ï
        function setupDragAndDrop() {
            const editor = document.getElementById('contentEditor');
            const overlay = document.getElementById('dropOverlay');
            let dragCounter = 0;

            editor.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter++;
                if (overlay) {
                    overlay.style.display = 'flex';
                }
            });

            editor.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter--;
                if (dragCounter === 0 && overlay) {
                    overlay.style.display = 'none';
                }
            });

            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            editor.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter = 0;
                if (overlay) {
                    overlay.style.display = 'none';
                }

                const files = e.dataTransfer.files;
                if (files.length === 0) return;

                // ?¥Î?ÏßÄ ?åÏùºÎß??ÑÌÑ∞Îß?                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                
                if (imageFiles.length === 0) {
                    showMessage('?¥Î?ÏßÄ ?åÏùºÎß??úÎ°≠?????àÏäµ?àÎã§.', true);
                    return;
                }

                // Í∞??¥Î?ÏßÄ ?ÖÎ°ú??Î∞??ΩÏûÖ
                for (const file of imageFiles) {
                    await uploadAndInsertImageAtCursor(file);
                }
            });
        }

        // Ïª§ÏÑú ?ÑÏπò???¥Î?ÏßÄ ?ΩÏûÖ
        async function uploadAndInsertImageAtCursor(file) {
            showMessage('?¥Î?ÏßÄÎ•??ÖÎ°ú??Ï§ëÏûÖ?àÎã§...');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const editor = document.getElementById('contentEditor');
                    const imageHTML = `<br><br><img src="${result.path}" alt="${result.originalname}" style="width: 80%; height: auto; margin: 20px auto; display: block;"><br><br>`;
                    
                    if (editor.contentEditable === 'true') {
                        // contenteditable??Í≤ΩÏö∞ ?ÑÏû¨ Ïª§ÏÑú ?ÑÏπò???ΩÏûÖ
                        editor.focus();
                        document.execCommand('insertHTML', false, imageHTML);
                    } else {
                        // textarea??Í≤ΩÏö∞ (?òÏúÑ ?∏Ìôò??
                        const cursorPos = editor.selectionStart;
                        editor.value = editor.value.substring(0, cursorPos) + imageHTML + editor.value.substring(cursorPos);
                        editor.focus();
                        editor.selectionStart = editor.selectionEnd = cursorPos + imageHTML.length;
                    }
                    
                    showMessage('?¥Î?ÏßÄÍ∞Ä ?ΩÏûÖ?òÏóà?µÎãà??');
                    return true;
                } else {
                    showMessage('?¥Î?ÏßÄ ?ÖÎ°ú?úÏóê ?§Ìå®?àÏäµ?àÎã§.', true);
                    return false;
                }
            } catch (error) {
                console.error('?¥Î?ÏßÄ ?ÖÎ°ú???§Ìå®:', error);
                showMessage('?¥Î?ÏßÄ ?ÖÎ°ú?úÏóê ?§Ìå®?àÏäµ?àÎã§.', true);
                return false;
            }
        }

        // ?¥Î?ÏßÄ ?ÖÎ°ú??Î∞??ΩÏûÖ (Í≥µÌÜµ ?®Ïàò)
        async function uploadAndInsertImage(file, cursorPos) {
            showMessage('?¥Î?ÏßÄÎ•??ÖÎ°ú??Ï§ëÏûÖ?àÎã§...');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const editor = document.getElementById('contentEditor');
                    // Ï§ÑÎ∞îÍø?2Í∞úÏî© Ï∂îÍ??òÏó¨ ?¥Î?ÏßÄ ?ûÎí§Î°??¨Î∞± ?ùÏÑ±, Í∞ÄÎ°?80%Î°??§Ï†ï
                    const imageTag = `<br><br><img src="${result.path}" alt="${result.originalname}" style="width: 80%; height: auto; margin: 20px auto; display: block;"><br><br>`;
                    
                    // contenteditable div??Í≤ΩÏö∞
                    if (editor.contentEditable === 'true') {
                        const imgElement = document.createElement('div');
                        imgElement.innerHTML = imageTag;
                        
                        // ?ÑÏû¨ ?†ÌÉù ?ÅÏó≠???ΩÏûÖ
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            range.deleteContents();
                            range.insertNode(imgElement.firstChild);
                        }
                    } else {
                        // textarea??Í≤ΩÏö∞ (?òÏúÑ ?∏Ìôò??
                        editor.value = editor.value.substring(0, cursorPos) + imageTag + editor.value.substring(cursorPos);
                        editor.focus();
                        editor.selectionStart = editor.selectionEnd = cursorPos + imageTag.length;
                    }
                    
                    showMessage('?¥Î?ÏßÄÍ∞Ä ?ΩÏûÖ?òÏóà?µÎãà??');
                    return true;
                } else {
                    showMessage('?¥Î?ÏßÄ ?ÖÎ°ú?úÏóê ?§Ìå®?àÏäµ?àÎã§.', true);
                    return false;
                }
            } catch (error) {
                console.error('?¥Î?ÏßÄ ?ÖÎ°ú???§Ìå®:', error);
                showMessage('?¥Î?ÏßÄ ?ÖÎ°ú?úÏóê ?§Ìå®?àÏäµ?àÎã§.', true);
                return false;
            }
        }

        // ?úÏãù ?ΩÏûÖ
        function insertFormat(type) {
            const editor = document.getElementById('contentEditor');
            
            // contenteditable div??Í≤ΩÏö∞
            if (editor.contentEditable === 'true') {
                editor.focus();
                
                switch(type) {
                    case 'h1':
                        document.execCommand('formatBlock', false, '<h1>');
                        break;
                    case 'h2':
                        document.execCommand('formatBlock', false, '<h2>');
                        break;
                    case 'h3':
                        document.execCommand('formatBlock', false, '<h3>');
                        break;
                    case 'hr':
                        document.execCommand('insertHTML', false, '<hr>');
                        break;
                    case 'table':
                        const tableHTML = `<table>
    <tr>
        <th>?§Îçî1</th>
        <th>?§Îçî2</th>
        <th>?§Îçî3</th>
    </tr>
    <tr>
        <td>?∞Ïù¥??</td>
        <td>?∞Ïù¥??</td>
        <td>?∞Ïù¥??</td>
    </tr>
</table><br>`;
                        document.execCommand('insertHTML', false, tableHTML);
                        break;
                    case 'bold':
                        document.execCommand('bold', false, null);
                        break;
                    case 'italic':
                        document.execCommand('italic', false, null);
                        break;
                }
            } else {
                // textarea??Í≤ΩÏö∞ (?òÏúÑ ?∏Ìôò??
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const selectedText = editor.value.substring(start, end);
                let insertText = '';

                switch(type) {
                    case 'h1':
                        insertText = `<h1>${selectedText || '?úÎ™©???ÖÎ†•?òÏÑ∏??}</h1>\n`;
                        break;
                    case 'h2':
                        insertText = `<h2>${selectedText || '?úÎ™©???ÖÎ†•?òÏÑ∏??}</h2>\n`;
                        break;
                    case 'h3':
                        insertText = `<h3>${selectedText || '?úÎ™©???ÖÎ†•?òÏÑ∏??}</h3>\n`;
                        break;
                    case 'hr':
                        insertText = '<hr>\n';
                        break;
                    case 'table':
                        insertText = `<table>
    <tr>
        <th>?§Îçî1</th>
        <th>?§Îçî2</th>
        <th>?§Îçî3</th>
    </tr>
    <tr>
        <td>?∞Ïù¥??</td>
        <td>?∞Ïù¥??</td>
        <td>?∞Ïù¥??</td>
    </tr>
</table>\n`;
                        break;
                    case 'bold':
                        insertText = `<strong>${selectedText || 'ÍµµÍ≤å'}</strong>`;
                        break;
                    case 'italic':
                        insertText = `<em>${selectedText || 'Í∏∞Ïö∏??}</em>`;
                        break;
                }

                editor.value = editor.value.substring(0, start) + insertText + editor.value.substring(end);
                editor.focus();
            }
        }

        // Ï≤®Î??åÏùº ?åÎçîÎß?        function renderAttachments(attachments, editMode) {
            if (!attachments || attachments.length === 0) {
                if (!editMode) return '';
            }

            let html = '<div class="attachments"><h3>?ìé Ï≤®Î??åÏùº</h3>';
            
            if (attachments.length > 0) {
                html += '<ul class="attachment-list">';
                attachments.forEach((file, index) => {
                    html += `
                        <li class="attachment-item">
                            <a href="${file.path}" target="_blank">${file.originalname}</a>
                            ${editMode ? `<button class="btn btn-danger" onclick="removeAttachment(${index})">??†ú</button>` : ''}
                        </li>
                    `;
                });
                html += '</ul>';
            }

            if (editMode) {
                html += `
                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" onchange="uploadFile(this)" multiple>
                        <p>?ìÅ ?åÏùº???†ÌÉù?òÍ±∞???¨Í∏∞???úÎ°≠?òÏÑ∏??/p>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // ?¥Î?ÏßÄ ?ΩÏûÖ (Î≤ÑÌäº ?¥Î¶≠)
        async function insertImage(input) {
            if (!input.files || input.files.length === 0) return;

            const file = input.files[0];
            
            // ?¥Î?ÏßÄ ?åÏùº?∏Ï? ?ïÏù∏
            if (!file.type.startsWith('image/')) {
                showMessage('?¥Î?ÏßÄ ?åÏùºÎß??ΩÏûÖ?????àÏäµ?àÎã§.', true);
                input.value = '';
                return;
            }

            await uploadAndInsertImageAtCursor(file);
            input.value = '';
        }

        // ?åÏùº ?ÖÎ°ú??(Ï≤®Î??åÏùº??
        async function uploadFile(input) {
            if (!input.files || input.files.length === 0) return;

            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const response = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('?åÏùº???ÖÎ°ú?úÎêò?àÏäµ?àÎã§.');
                    
                    // ?ÑÏû¨ Ï±ïÌÑ∞ ?∞Ïù¥?∞Ïóê Ï≤®Î??åÏùº Ï∂îÍ?
                    const data = await fetch(`${API_BASE_URL}/api/chapters/${currentChapterId}`).then(r => r.json());
                    if (!data.attachments) data.attachments = [];
                    data.attachments.push({
                        filename: result.filename,
                        originalname: result.originalname,
                        path: result.path
                    });

                    // UI ?ÖÎç∞?¥Ìä∏
                    enterEditMode(data);
                } else {
                    showMessage('?åÏùº ?ÖÎ°ú?úÏóê ?§Ìå®?àÏäµ?àÎã§.', true);
                }
            } catch (error) {
                console.error('?åÏùº ?ÖÎ°ú???§Ìå®:', error);
                showMessage('?åÏùº ?ÖÎ°ú?úÏóê ?§Ìå®?àÏäµ?àÎã§.', true);
            }

            input.value = '';
        }

        // Ï≤®Î??åÏùº ??†ú
        function removeAttachment(index) {
            if (!confirm('???åÏùº????†ú?òÏãúÍ≤†Ïäµ?àÍπå?')) return;

            // ?ÑÏû¨ ?∞Ïù¥?∞Ïóê??Ï≤®Î??åÏùº ?úÍ±∞
            fetch(`${API_BASE_URL}/api/chapters/${currentChapterId}`)
                .then(r => r.json())
                .then(data => {
                    data.attachments.splice(index, 1);
                    enterEditMode(data);
                    showMessage('?åÏùº????†ú?òÏóà?µÎãà??');
                });
        }

        // ?Ä??        async function saveContent() {
            const editor = document.getElementById('contentEditor');
            // contenteditable div??Í≤ΩÏö∞ innerHTML, textarea??Í≤ΩÏö∞ value ?¨Ïö©
            const content = editor.contentEditable === 'true' ? editor.innerHTML : editor.value;
            
            const response = await fetch(`${API_BASE_URL}/api/chapters/${currentChapterId}`);
            const currentData = await response.json();

            try {
                const saveResponse = await fetch(`${API_BASE_URL}/api/chapters/${currentChapterId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        attachments: currentData.attachments || []
                    })
                });

                const result = await saveResponse.json();
                
                if (result.success) {
                    showMessage('?Ä?•Îêò?àÏäµ?àÎã§.');
                    await loadChapterData();
                    renderChapterTree();
                    await loadChapterContent(currentChapterId);
                } else {
                    showMessage('?Ä?•Ïóê ?§Ìå®?àÏäµ?àÎã§.', true);
                }
            } catch (error) {
                console.error('?Ä???§Ìå®:', error);
                showMessage('?Ä?•Ïóê ?§Ìå®?àÏäµ?àÎã§.', true);
            }
        }

        // Ï∑®ÏÜå
        function cancelEdit() {
            if (confirm('Î≥ÄÍ≤ΩÏÇ¨??ùÑ Ï∑®ÏÜå?òÏãúÍ≤†Ïäµ?àÍπå?')) {
                loadChapterContent(currentChapterId);
            }
        }

        // Î©îÏãúÏßÄ ?úÏãú
        function showMessage(message, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'status-message' + (isError ? ' error' : '');
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Í∞Ä?¥Îìú ?®ÎÑê ?úÏãú
        function showGuidePanel() {
            document.getElementById('guidePanel').classList.add('active');
        }

        // Í∞Ä?¥Îìú ?ùÏÑ±
        async function generateGuide(chapterId, existingContent = '') {
            const guideContent = document.getElementById('guideContent');
            guideContent.innerHTML = '<div class="guide-loading">AIÍ∞Ä Í∏Ä?∞Í∏∞ Í∞Ä?¥ÎìúÎ•??ùÏÑ±?òÍ≥† ?àÏäµ?àÎã§</div>';

            try {
                const title = getChapterTitle(chapterId);
                const bookContext = `
?ÑÏÑú ?úÎ™©: ?êÏú†?òÏ? ?àÏ∏°
?ÑÏÑú Ï£ºÏ†ú: Î™ÖÎ¶¨ ?¥Î°†???Ä???àÎ°ú???ëÍ∑º Î∞©Î≤ï (??Ç¨Ï£?
?ÄÍ≤??ÖÏûê: 45-60?? 25-30???ÖÏûê
Î¨∏Ï≤¥: ?ÑÎ¨∏?±Í≥º ÏßÑÏ§ë?®ÏùÑ ?†Ï??òÎ©¥?úÎèÑ ?¥Ìï¥?òÍ∏∞ ?¨Ïö¥ ÎπÑÎ¨∏???§Ì???`;

                // ?ÑÏ≤¥ Î™©Ï∞®Î•??ΩÍ∏∞ ?¨Ïö¥ ?çÏä§?∏Î°ú Î≥Ä??                const tocText = generateTableOfContentsText();

                const response = await fetch('${API_BASE_URL}/api/generate-guide', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        existingContent: existingContent,
                        bookContext: bookContext,
                        tableOfContents: tocText,
                        currentChapterId: chapterId
                    })
                });

                const data = await response.json();
                
                if (data.success && data.guide) {
                    guideContent.innerHTML = data.guide;
                } else {
                    guideContent.innerHTML = `<p style="color: #f44336;">Í∞Ä?¥Îìú ?ùÏÑ±???§Ìå®?àÏäµ?àÎã§.</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">
                        ??AI Í∞Ä?¥Îìú Í∏∞Îä•???¨Ïö©?òÎ†§Î©?Anthropic API ?§Í? ?ÑÏöî?©Îãà??<br>
                        ?úÎ≤Ñ ?§Ìñâ ???òÍ≤ΩÎ≥Ä??ANTHROPIC_API_KEYÎ•??§Ï†ï?¥Ï£º?∏Ïöî.<br>
                        ?êÏÑ∏???¥Ïö©?Ä API_KEY_SETUP.md ?åÏùº??Ï∞∏Í≥†?òÏÑ∏??
                    </p>`;
                }
            } catch (error) {
                console.error('Í∞Ä?¥Îìú ?ùÏÑ± ?§Ìå®:', error);
                guideContent.innerHTML = `<p style="color: #f44336;">Í∞Ä?¥Îìú ?ùÏÑ± Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§.</p>
                <p style="font-size: 12px; color: #999; margin-top: 10px;">
                    ?úÎ≤Ñ ?∞Í≤∞???ïÏù∏?¥Ï£º?∏Ïöî.
                </p>`;
            }
        }

        // ?ÑÏ≤¥ Î™©Ï∞®Î•??çÏä§?∏Î°ú Î≥Ä??        function generateTableOfContentsText() {
            let text = '';
            
            Object.keys(tableOfContents).forEach(key => {
                const chapter = tableOfContents[key];
                text += `\n${chapter.title}\n`;
                
                if (chapter.children) {
                    Object.keys(chapter.children).forEach(subKey => {
                        const subChapter = chapter.children[subKey];
                        text += `  - ${subChapter.title}\n`;
                        
                        if (subChapter.children) {
                            Object.keys(subChapter.children).forEach(subSubKey => {
                                const subSubChapter = subChapter.children[subSubKey];
                                text += `    ??${subSubChapter.title}\n`;
                            });
                        }
                    });
                }
            });
            
            return text;
        }

        // ?¨Í??¥Îìú ?ùÏÑ±
        async function regenerateGuide() {
            if (!currentChapterId) {
                showMessage('Ï±ïÌÑ∞Î•?Î®ºÏ? ?†ÌÉù?¥Ï£º?∏Ïöî.', true);
                return;
            }

            const editor = document.getElementById('contentEditor');
            let currentContent = '';
            
            if (editor) {
                // ?∏Ïßë Î™®Îìú??Í≤ΩÏö∞
                currentContent = editor.contentEditable === 'true' ? editor.innerHTML : editor.value;
            } else {
                // Î∑?Î™®Îìú??Í≤ΩÏö∞ - ?Ä?•Îêú ?¥Ïö© Í∞Ä?∏Ïò§Í∏?                try {
                    const response = await fetch(`${API_BASE_URL}/api/chapters/${currentChapterId}`);
                    const data = await response.json();
                    currentContent = data.content || '';
                } catch (error) {
                    console.error('?¥Ïö© Î°úÎìú ?§Ìå®:', error);
                }
            }

            // HTML ?úÍ∑∏ ?úÍ±∞?òÏó¨ ?úÏàò ?çÏä§?∏Îßå Ï∂îÏ∂ú (Î∂ÑÏÑù??
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentContent;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';

            // ?¥Ïö©???àÎì† ?ÜÎì† Í∞Ä?¥Îìú ?ùÏÑ±
            // ?¥Ïö©???àÏúºÎ©? ?¥Ïö© Î∂ÑÏÑù + Î≥¥Ï∂©/?òÏ†ï ?úÏïà
            // ?¥Ïö©???ÜÏúºÎ©? Î™©Ï∞® Í∏∞Î∞ò ?ëÏÑ± Í∞Ä?¥Îìú
            if (textContent.trim().length > 0) {
                showMessage('?ëÏÑ±???¥Ïö©??Î∂ÑÏÑù?òÏó¨ ?¨Í??¥ÎìúÎ•??ùÏÑ±?òÍ≥† ?àÏäµ?àÎã§...');
            } else {
                showMessage('Ï±ïÌÑ∞ ?úÎ™©Í≥?Î™©Ï∞®Î•?Í∏∞Î∞ò?ºÎ°ú Í∞Ä?¥ÎìúÎ•??ùÏÑ±?òÍ≥† ?àÏäµ?àÎã§...');
            }
            
            await generateGuide(currentChapterId, textContent.trim());
        }

        // Î≤ÑÌäº ?¥Î≤§??Î¶¨Ïä§??        document.getElementById('editBtn').addEventListener('click', async () => {
            const response = await fetch(`${API_BASE_URL}/api/chapters/${currentChapterId}`);
            const data = await response.json();
            enterEditMode(data);
        });

        document.getElementById('saveBtn').addEventListener('click', saveContent);
        document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
    </script>
</body>
</html>
