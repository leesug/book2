<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ììœ ì˜ì§€ ì˜ˆì¸¡ - ì§‘í•„ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* ì§„í–‰ë¥  ìƒíƒœ ë°” */
        .progress-bar-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .progress-info h2 {
            font-size: 18px;
            margin: 0;
            font-weight: 600;
        }

        .progress-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .progress-stat {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 500;
        }

        .progress-bar-wrapper {
            flex: 1;
            max-width: 400px;
            margin: 0 30px;
        }

        .progress-bar-bg {
            background: rgba(255,255,255,0.3);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .progress-percentage {
            font-size: 20px;
            font-weight: 700;
            min-width: 60px;
            text-align: right;
        }

        .container {
            display: flex;
            height: calc(100vh - 54px);
        }

        /* ì‚¬ì´ë“œë°” - ëª©ì°¨ */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            flex-shrink: 0;
        }

        .sidebar h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .chapter-tree {
            list-style: none;
        }

        .chapter-item {
            margin: 5px 0;
            position: relative;
        }

        .chapter-item-header {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            background: transparent;
            border: 1px solid #ccc;
            border-radius: 3px;
            transition: all 0.2s;
            flex-shrink: 0;
            user-select: none;
        }

        .toggle-btn:hover {
            background: #e0e0e0;
            color: #333;
            border-color: #999;
        }

        .toggle-btn.collapsed::before {
            content: '+';
        }

        .toggle-btn.expanded::before {
            content: 'âˆ’';
        }

        .chapter-link {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #333;
            border-radius: 5px;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }

        .chapter-link:hover {
            background: #f0f0f0;
        }

        .chapter-link.active {
            background: #4CAF50;
            color: white;
        }

        .chapter-link.has-content {
            font-weight: 600;
            color: #4CAF50;
        }

        .chapter-link.has-content.active {
            color: white;
        }

        .sub-chapter {
            margin-left: 25px;
            overflow: hidden;
            max-height: 5000px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
            position: relative;
            border-left: 2px solid #e0e0e0; /* ì„¸ë¡œ ì—°ê²°ì„  */
            padding-left: 15px;
        }

        .sub-chapter.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        .sub-sub-chapter {
            margin-left: 25px;
            font-size: 13px;
            overflow: hidden;
            max-height: 5000px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
            position: relative;
            border-left: 2px solid #e0e0e0; /* ì„¸ë¡œ ì—°ê²°ì„  */
            padding-left: 15px;
        }

        .sub-sub-chapter.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }


        /* íŠ¸ë¦¬ êµ¬ì¡° ì—°ê²°ì„  */
        .sub-chapter > .chapter-item::before,
        .sub-sub-chapter > .chapter-item::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 20px;
            width: 15px;
            height: 2px;
            background: #e0e0e0; /* ê°€ë¡œ ì—°ê²°ì„  */
        }

        /* ë§ˆì§€ë§‰ í•­ëª©ì€ ì„¸ë¡œì„ ì„ ì§§ê²Œ */
        .sub-chapter > .chapter-item:last-child::after,
        .sub-sub-chapter > .chapter-item:last-child::after {
            content: '';
            position: absolute;
            left: -17px;
            top: 20px;
            bottom: 0;
            width: 2px;
            background: white; /* ì„¸ë¡œì„  ê°€ë¦¬ê¸° */
        }


        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
            min-width: 0;
        }

        /* ê¸€ì“°ê¸° ê°€ì´ë“œ íŒ¨ë„ */
        .guide-panel {
            width: 350px;
            background: #f9f9f9;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            flex-shrink: 0;
            display: none;
        }

        .guide-panel.active {
            display: block;
        }

        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }

        .guide-header h3 {
            font-size: 18px;
            color: #333;
            margin: 0;
        }

        .guide-content {
            line-height: 1.8;
            font-size: 14px;
            color: #555;
        }

        .guide-content h4 {
            font-size: 16px;
            color: #4CAF50;
            margin: 20px 0 10px 0;
        }

        .guide-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .guide-content li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .guide-loading {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .guide-loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .btn-guide {
            background: #9C27B0;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-guide:hover {
            background: #7B1FA2;
        }

        .content-header {
            padding: 20px 30px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-header h2 {
            font-size: 22px;
            color: #333;
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-small {
            padding: 5px 12px;
            font-size: 12px;
            background: #607D8B;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: #546E7A;
        }

        /* í¸ì§‘ê¸° ì˜ì—­ */
        .editor-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .view-mode {
            line-height: 1.8;
            font-size: 15px;
            color: #333;
        }

        .view-mode h1 {
            font-size: 28px;
            margin: 30px 0 20px 0;
            color: #222;
        }

        .view-mode h2 {
            font-size: 24px;
            margin: 25px 0 15px 0;
            color: #333;
        }

        .view-mode h3 {
            font-size: 20px;
            margin: 20px 0 10px 0;
            color: #444;
        }

        .view-mode p {
            margin: 15px 0;
        }

        .view-mode hr {
            margin: 30px 0;
            border: none;
            border-top: 2px solid #ddd;
        }

        .view-mode img {
            width: 80%;
            height: auto;
            margin: 20px auto;
            display: block;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .view-mode table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .view-mode table th,
        .view-mode table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .view-mode table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .toolbar {
            background: #f5f5f5;
            padding: 8px 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .toolbar button {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .toolbar button:hover {
            background: #f0f0f0;
        }

        /* ========== ê°œì„ ëœ íˆ´ë°” ìŠ¤íƒ€ì¼ ========== */
        .toolbar {
            background: #f5f5f5 !important;
            padding: 8px 10px !important;
            border: 1px solid #e0e0e0 !important;
            flex-wrap: wrap !important;
            align-items: flex-start !important;
            overflow: visible !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        .toolbar button {
            padding: 4px 8px !important;
            font-size: 11px !important;
            flex-shrink: 1 !important;
            white-space: nowrap !important;
        }

        .toolbar-group {
            display: flex;
            gap: 3px;
            padding: 3px 5px;
            background: #fff;
            border-radius: 4px;
            border-left: 2px solid #ccc;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 1;
            min-width: 0;
        }

        .toolbar-group-label {
            color: #666 !important;
            font-size: 9px !important;
            padding: 0 5px;
        }

        .toolbar button.btn-image {
            background: #ff9800 !important;
            color: white !important;
            border: 1px solid #ff9800 !important;
        }

        .toolbar button.btn-image:hover {
            background: #f57c00 !important;
            border-color: #f57c00 !important;
        }



        #contentEditor {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
            line-height: 1.8;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            resize: vertical;
        }

        .content-editor-editable {
            background: white;
            overflow-y: auto;
            max-height: 600px;
        }

        .content-editor-editable:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .content-editor-editable img {
            width: 80%;
            height: auto;
            margin: 20px auto;
            display: block;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .content-editor-editable p {
            margin: 10px 0;
        }

        .content-editor-editable h1,
        .content-editor-editable h2,
        .content-editor-editable h3 {
            margin: 20px 0 10px 0;
        }

        .content-editor-editable table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .content-editor-editable table th,
        .content-editor-editable table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .content-editor-editable table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        #editorWrapper {
            position: relative;
        }

        #dropOverlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(76, 175, 80, 0.1);
            border: 3px dashed #4CAF50;
            border-radius: 5px;
            z-index: 100;
            pointer-events: none;
        }

        .attachments {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .attachments h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .attachment-list {
            list-style: none;
        }

        .attachment-item {
            padding: 10px;
            background: #f9f9f9;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attachment-item a {
            color: #2196F3;
            text-decoration: none;
        }

        .attachment-item a:hover {
            text-decoration: underline;
        }

        .file-upload-area {
            margin-top: 15px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: #4CAF50;
            background: #f9f9f9;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #999;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .status-message.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }


        /* ========== Phase 2: ëª©ì°¨ ê´€ë¦¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ ========== */
        .toc-manage-btn {
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .toc-manage-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .toc-manage-btn.active {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }

        /* ëª©ì°¨ í•­ëª© ì•¡ì…˜ ë²„íŠ¼ë“¤ */
        .toc-actions {
            display: none;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            flex-wrap: nowrap;
        }

        .toc-manage-mode .toc-actions {
            display: flex;
            margin-left: 0;
            margin-top: 8px;
            padding-left: 25px; /* í† ê¸€ ë²„íŠ¼ ë„ˆë¹„ë§Œí¼ ë“¤ì—¬ì“°ê¸° */
        }

        /* ëª©ì°¨ ê´€ë¦¬ ëª¨ë“œì—ì„œ í—¤ë”ë¥¼ ì„¸ë¡œë¡œ ë°°ì¹˜ */
        .toc-manage-mode .chapter-item-header {
            flex-direction: column;
            align-items: flex-start;
        }

        /* ì œëª©ê³¼ í† ê¸€ ë²„íŠ¼ì„ ê°€ë¡œë¡œ ë°°ì¹˜í•˜ëŠ” ë˜í¼ */
        .chapter-title-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100%;
        }

        .toc-action-btn {
            width: 24px;
            height: 24px;
            padding: 0;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .toc-action-btn:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }

        .toc-action-btn.up:hover { background: #e3f2fd; border-color: #2196F3; }
        .toc-action-btn.down:hover { background: #e3f2fd; border-color: #2196F3; }
        .toc-action-btn.left:hover { background: #fff3e0; border-color: #FF9800; }
        .toc-action-btn.right:hover { background: #fff3e0; border-color: #FF9800; }
        .toc-action-btn.edit:hover { background: #e8f5e9; border-color: #4CAF50; }
        .toc-action-btn.delete:hover { background: #ffebee; border-color: #f44336; }
        .toc-action-btn.add:hover { background: #e8f5e9; border-color: #4CAF50; }

        /* ìƒˆ ì±•í„° ì¶”ê°€ ì˜ì—­ */
        .add-chapter-area {
            display: none;
            background: #f9f9f9;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .toc-manage-mode .add-chapter-area {
            display: block;
        }

        .add-chapter-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .add-chapter-buttons {
            display: flex;
            gap: 8px;
        }

        .add-chapter-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-chapter-buttons .btn-add {
            background: #4CAF50;
            color: white;
        }

        .add-chapter-buttons .btn-add:hover {
            background: #45a049;
        }

        .add-chapter-buttons .btn-cancel {
            background: #f0f0f0;
            color: #666;
        }

        .add-chapter-buttons .btn-cancel:hover {
            background: #e0e0e0;
        }


        /* ì•Œë¦¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

    </style>
    
    <!-- ëª¨ë°”ì¼ ë°˜ì‘í˜• CSS -->
    <link rel="stylesheet" href="mobile-ui.css">

    <!-- ëª©ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ -->
    <script src="toc-manager.js"></script>
    
    <!-- ëª¨ë°”ì¼ UI ì œì–´ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="mobile-ui.js"></script>
    
    <!-- ìŒì„± â†’ í…ìŠ¤íŠ¸ ë³€í™˜ -->
    <script src="voice-to-text.js"></script>



</head>
<body>
    
    <!-- ëª¨ë°”ì¼ í—¤ë” (768px ì´í•˜ì—ì„œë§Œ í‘œì‹œ) -->
    <div class="mobile-header">
        <button class="mobile-menu-btn" id="mobileTocBtn" title="ëª©ì°¨ ì—´ê¸°">
            ğŸ“‹
        </button>
        <div class="mobile-header-title">ììœ ì˜ì§€ ì˜ˆì¸¡</div>
        <button class="mobile-menu-btn" id="mobileGuideBtn" title="ê°€ì´ë“œ ì—´ê¸°">
            ğŸ“
        </button>
    </div>

    <!-- ì˜¤ë²„ë ˆì´ (íŒ¨ë„ ì—´ë¦´ ë•Œ ë°°ê²½) -->
    <div class="slide-overlay" id="slideOverlay"></div>

    <!-- ëª©ì°¨ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ (ì™¼ìª½) -->
    <div class="slide-panel slide-panel-left" id="tocSlidePanel">
        <div class="slide-panel-header">
            <h2>ğŸ“– ëª©ì°¨</h2>
            <button class="slide-panel-close" id="tocPanelClose">âœ•</button>
        </div>
        <div class="slide-panel-content" id="tocPanelContent">
            <!-- JavaScriptë¡œ ëª©ì°¨ ë‚´ìš©ì´ ë³µì‚¬ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ê°€ì´ë“œ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ (ì˜¤ë¥¸ìª½) -->
    <div class="slide-panel slide-panel-right" id="guideSlidePanel">
        <div class="slide-panel-header">
            <h2>ğŸ“ ê¸€ì“°ê¸° ê°€ì´ë“œ</h2>
            <button class="slide-panel-close" id="guidePanelClose">âœ•</button>
        </div>
        <div class="slide-panel-content" id="guidePanelContent">
            <!-- JavaScriptë¡œ ê°€ì´ë“œ ë‚´ìš©ì´ ë³µì‚¬ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ì§„í–‰ë¥  ìƒíƒœ ë°” -->
    <div class="progress-bar-container">
        <div class="progress-info">
            <h2>ğŸ“š ììœ ì˜ì§€ ì˜ˆì¸¡</h2>
            <div class="progress-stats">
                <span class="progress-stat" id="pagesWritten">0 / 500 í˜ì´ì§€</span>
                <span class="progress-stat" id="chaptersCompleted">0 / 0 ì±•í„°</span>
                <span class="progress-stat" id="totalChars">0 / 337,500 ì</span>
            </div>
        </div>
        <div class="progress-bar-wrapper">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;">
                    <span id="progressBarText"></span>
                </div>
            </div>
        </div>
        <div class="progress-percentage" id="progressPercentage">0%</div>
    </div>

    <div class="container">
        <!-- ì‚¬ì´ë“œë°” - ëª©ì°¨ -->
        <div class="sidebar">
            <h1>ğŸ“– ììœ ì˜ì§€ ì˜ˆì¸¡</h1>
            
            <!-- Phase 2: ëª©ì°¨ ê´€ë¦¬ ë²„íŠ¼ -->
            <button id="tocManageBtn" class="toc-manage-btn">
                <span>ğŸ› ï¸ ëª©ì°¨ ê´€ë¦¬</span>
            </button>
            
            <!-- Phase 2: ìƒˆ ì±•í„° ì¶”ê°€ ì˜ì—­ -->
            <div class="add-chapter-area" id="addChapterArea">
                <h4 style="margin-bottom: 10px; color: #666; font-size: 13px;">â• ìƒˆ ì±•í„° ì¶”ê°€</h4>
                <input type="text" class="add-chapter-input" id="newChapterTitle" placeholder="ìƒˆ ì±•í„° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <select class="add-chapter-input" id="newChapterParent">
                    <option value="">ìµœìƒìœ„ ë ˆë²¨ë¡œ ì¶”ê°€</option>
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </select>
                <div class="add-chapter-buttons">
                    <button class="btn-add" onclick="addNewChapter()">âœ“ ì¶”ê°€</button>
                    <button class="btn-cancel" onclick="cancelAddChapter()">âœ• ì·¨ì†Œ</button>
                </div>
            </div>

            <div style="margin-bottom: 15px; text-align: right;">
                <button id="collapseAllBtn" class="btn btn-small" style="font-size: 12px; padding: 5px 12px;">
                    âˆ’ ëª¨ë‘ ì ‘ê¸°
                </button>
            </div>
            <ul class="chapter-tree" id="chapterTree">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </ul>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <div class="content-header">
                <h2 id="contentTitle">ì±•í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
                <div class="content-actions" id="contentActions" style="display: none;">
                    <button class="btn btn-secondary" id="editBtn" style="display: none;">ìˆ˜ì •</button>
                    <button class="btn btn-primary" id="saveBtn" style="display: none;">ì €ì¥</button>
                    <button class="btn btn-danger" id="cancelBtn" style="display: none;">ì·¨ì†Œ</button>
                </div>
            </div>

            <div class="editor-area" id="editorArea">
                <div class="empty-state">
                    <h3>ğŸ“ ì§‘í•„ì„ ì‹œì‘í•˜ì„¸ìš”</h3>
                    <p>ì™¼ìª½ ëª©ì°¨ì—ì„œ ì±•í„°ë¥¼ ì„ íƒí•˜ë©´ ë‚´ìš©ì„ ì‘ì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <!-- ê¸€ì“°ê¸° ê°€ì´ë“œ íŒ¨ë„ -->
        <div class="guide-panel" id="guidePanel">
            <div class="guide-header">
                <h3>âœï¸ ê¸€ì“°ê¸° ê°€ì´ë“œ</h3>
                <button class="btn-guide" id="regenerateGuideBtn" onclick="regenerateGuide()">ğŸ”„ ì¬ê°€ì´ë“œ ìƒì„±</button>
            </div>
            <div class="guide-content" id="guideContent">
                <p style="color: #999; text-align: center; padding: 40px 20px;">ì±•í„°ë¥¼ ì„ íƒí•˜ë©´ ê¸€ì“°ê¸° ê°€ì´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <script>
        // API Base URL ì„¤ì • (ë¡œì»¬/í”„ë¡œë•ì…˜ ìë™ ê°ì§€)
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : window.location.origin;
        
        console.log('ğŸ”— API Base URL:', API_BASE_URL);
        
        // ëª©ì°¨ ë°ì´í„°
        const tableOfContents = {
            "bookInfo": {
                title: "ğŸ“‹ ì±… ê¸°ë³¸ ì •ë³´",
                isSpecial: true
            },
            "prologue": {
                title: "í”„ë¡¤ë¡œê·¸: ì¸ë¥˜ì˜ ìˆ™ëª…, ì˜ˆì¸¡ì— ëŒ€í•œ ê°ˆë§",
                children: {
                    "p1": { title: "ì™œ ìš°ë¦¬ëŠ” ì˜ˆì¸¡í•˜ë ¤ í•˜ëŠ”ê°€?" },
                    "p2": { title: "ì˜ˆì¸¡ì˜ ë³¸ëŠ¥: ìƒì¡´ê³¼ ë²ˆì˜ì„ ìœ„í•œ ì¸ë¥˜ì˜ ì—­ì‚¬" },
                    "p3": { title: "ì˜ˆì¸¡ì´ ì„±ê³µí–ˆì„ ë•Œì˜ ë³´ìƒ: ì—­ì‚¬ ì† ì‚¬ë¡€ì™€ í˜„ëŒ€ ì‚¬íšŒì˜ ê°€ì¹˜" },
                    "p4": { title: "ê°™ì€ ì‹¤ìˆ˜ë¥¼ ë°˜ë³µí•˜ëŠ” ì´ìœ : ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥ì„±ì´ ì£¼ëŠ” ì¢Œì ˆê³¼ í˜¼ë€" },
                    "p5": { title: "ì˜ˆì¸¡ì˜ ë‹¹ìœ„ì„±: ë” ë‚˜ì€ ì‚¶ì„ ìœ„í•œ í•„ìˆ˜ì ì¸ ì§€í˜œ" },
                    "p6": { title: "ì˜ˆì¸¡ì„ ìœ„í•œ ì¸ë¥˜ì˜ ë„êµ¬ë“¤: ê³¼í•™ê¸°ìˆ ì—ì„œ ë™ì–‘ì˜ ì§€í˜œê¹Œì§€" },
                    "p7": { title: "ì‹œê°„ê³¼ ê³µê°„ì„ ì½ì–´ë‚´ëŠ” ë„êµ¬: ì‹œê³„, ë‹¬ë ¥, ì²œë¬¸í•™" },
                    "p8": { title: "ìì—° í˜„ìƒ ì˜ˆì¸¡: ë‚ ì”¨ ì˜ˆì¸¡ì˜ ì—­ì‚¬ì™€ ë°œì „" },
                    "p9": { title: "ì‚¬íšŒ í˜„ìƒ ì˜ˆì¸¡: ì—­ì‚¬ì˜ ë°˜ë³µ, ìœ í–‰ì˜ ìˆœí™˜ (íŒ¨ì…˜, ìŒì•…)" },
                    "p10": { title: "ë¹…ë°ì´í„°ì™€ AI: ëª¨ë“  ê³¼í•™ê¸°ìˆ ì€ ì˜ˆì¸¡ì„ í–¥í•œë‹¤" },
                    "p11": { title: "ì˜ˆì¸¡ë§Œì„ ìœ„í•œ í•™ë¬¸: ë™ì–‘ì˜ ì ìˆ ê³¼ ì‚¬ì£¼ëª…ë¦¬" },
                    "p12": { title: "ê³¼í•™ê¸°ìˆ ë¡œ ì„¤ëª…í•  ìˆ˜ ì—†ëŠ” ê¸°í˜¸ì™€ ì˜ì§€ì˜ ë¬¸ì œ" },
                    "p13": { title: "ê²°ê³¼ì™€ ê³¼ì •: ì ìˆ /ì‚¬ì£¼ëª…ë¦¬ê°€ ê°€ì§„ ë…íŠ¹í•œ ì„¤ë“ë ¥" },
                    "p14": { title: "'ë‘ë£¨ë­‰ìˆ í•œ' ì˜ˆì¸¡ì˜ ì˜¤í•´ì™€ 'êµ¬ì²´í™”ëœ' ì˜ˆì¸¡ì˜ ì •í™•ì„±" },
                    "p15": { title: "í•œêµ­, ì˜ˆì¸¡ì˜ íŠ¹ì´ì : ì ìˆ  ì‹œì¥ì˜ ë¹„ë°€" },
                    "p16": { title: "ì „ ì„¸ê³„ ì¸êµ¬ ëŒ€ë¹„ ì••ë„ì ì¸ í•œêµ­ì˜ ì ìˆ  ì‹œì¥" },
                    "p17": { title: "í•œêµ­ ì ìˆ ì˜ íŠ¹ì´ì„±: 'ê³¼ê±° í•´ì†Œ'ë³´ë‹¤ 'ë¯¸ë˜ ì˜ˆì¸¡'ì— ì§‘ì¤‘í•˜ëŠ” ë¬¸í™”" },
                    "p18": { title: "'ì‹ ë“¤ì˜ ë‚˜ë¼' í•œêµ­ì´ ì ìˆ ì— ì—´ê´‘í•˜ëŠ” ì´ìœ " },
                    "p19": { title: "ì ìˆ ê³¼ ì‚¬ì£¼ëª…ë¦¬ì˜ ê²½ê³„, ê·¸ë¦¬ê³  'ì—­ì‚¬ì£¼'ì˜ ë“±ì¥" },
                    "p20": { title: "ì˜ˆì¸¡ íˆ´ë¡œì„œì˜ ì ìˆ ê³¼ ì‚¬ì£¼ëª…ë¦¬ì˜ ê³µí†µì ê³¼ ì°¨ì´ì " },
                    "p21": { title: "ì‚¬ì£¼ëª…ë¦¬: ë‹¬ë ¥ì˜ ì›ë¦¬ì— ê¸°ë°˜í•œ ì—­í•™" },
                    "p22": { title: "ì ìˆ ì˜ ë‘ ê°ˆë˜: ì‚¬ì£¼ëª…ë¦¬ì˜ ë¯¸ë¶„(ì„¸ë¶„í™”) ê°œë…ê³¼ ì‹ ì ‘(ç¥æ¥)ì˜ ì„¸ê³„" },
                    "p23": { title: "ë¹„ê³¼í•™ì  ê·¼ê±°ì— ëŒ€í•œ ë¹„íŒê³¼ ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ë¯¿ëŠ” ì´ìœ " },
                    "p24": { title: "ì˜ˆì¸¡ë¥ ì˜ í•œê³„: 70%ì™€ 55%, ë¯¿ì„ ìˆ˜ ì—†ëŠ” ì˜ˆì¸¡ê³¼ ì†Œë¦„ ë‹ëŠ” ì˜ˆì¸¡" },
                    "p25": { title: "ì‚¬ì£¼ëª…ë¦¬, ì˜¤ë˜ëœ ê¸°ìˆ ì´ ëœ ì´ìœ " },
                    "p26": { title: "ë°˜ë§Œë…„ ì—­ì‚¬ ì†ì—ì„œ 'ì›ë¦¬'ë³´ë‹¤ 'ê¸°ìˆ 'ë¡œ ì „ìˆ˜ëœ ì§€í˜œ" },
                    "p27": { title: "ì–´ì„¤í”„ê²Œ ë§ì§€ë§Œ, ì™œ ë§ëŠ”ì§€ëŠ” ëª°ëë˜ ê³¼ê±°ì˜ í•œê³„" },
                    "p28": { title: "'ë¹„ê¸‰'ê³¼ 'ë¹„ë°€': ì˜ˆì¸¡ì˜ ê°€ì¹˜ê°€ ë§Œë“¤ì–´ë‚¸ íì‡„ì„±" },
                    "p29": { title: "ìƒˆë¡œìš´ ì˜ˆì¸¡ì˜ ì‹œëŒ€: 'ì—­ì‚¬ì£¼'ì˜ íƒ„ìƒ ë°°ê²½" },
                    "p30": { title: "ê³¼ê±°ì˜ ì‹¤ë§ì„ ë„˜ì–´ì„  ìƒˆë¡œìš´ ì‹œë„" },
                    "p31": { title: "'ì˜¤í–‰ì˜ ì •ì²´'ì™€ 'ìš´, ê¸°'ì˜ í˜„ëŒ€ì  ì¬í•´ì„" },
                    "p32": { title: "ì‹œê°„ê³¼ ì—ë„ˆì§€: 'ì—­ì‚¬ì£¼'ê°€ ì˜ˆì¸¡ì˜ ìƒˆë¡œìš´ ì§€í‰ì„ ì—´ë‹¤" }
                }
            },
            "part1": {
                title: "ì œ1ë¶€. 'ì—­ì‚¬ì£¼'ì˜ ê·¼ê°„: ìŒì–‘ì˜¤í–‰, ë³€í™”í•˜ëŠ” ì—ë„ˆì§€",
                children: {
                    "1-1": {
                        title: "ë¬´ê·¹ì—ì„œ ìŒì–‘ìœ¼ë¡œ: ëª¨ë“  ê²ƒì˜ ì‹œì‘",
                        children: {
                            "1-1-1": { title: "ë¬´ê·¹ì˜ ìƒíƒœì™€ ì‹œê°„ì˜ ë°œìƒ" },
                            "1-1-2": { title: "ì—ë„ˆì§€ì™€ ì‹œê°„: ì•„ì¸ìŠˆíƒ€ì¸ì˜ ë°©ì •ì‹ìœ¼ë¡œ ë³¸ ê´€ê³„" },
                            "1-1-3": { title: "ìŒì–‘ì˜ ë°œìƒ: ì—ë„ˆì§€ ì°¨ì´ì— ì˜í•œ í¸ì°¨" },
                            "1-1-4": { title: "ìŒì–‘ì—ì„œ ì˜¤í–‰ìœ¼ë¡œ: ì—ë„ˆì§€ì˜ íë¦„ê³¼ ê· í˜•" },
                            "1-1-5": { title: "ì˜¤í–‰ì˜ ë¶„í™”ì™€ ì—ë„ˆì§€ ì¤€ìœ„" },
                            "1-1-6": { title: "ì˜¤í–‰ì˜ íŠ¹ì„±: ëª©, í™”, í† , ê¸ˆ, ìˆ˜" }
                        }
                    },
                    "1-2": {
                        title: "ê³ ì •ì ì´ì§€ ì•Šì€ ì˜¤í–‰: ë¶ˆë³€í•˜ì§€ ì•Šê³  ë³€í™”í•˜ë©° ìƒëŒ€ì ì¸ ì˜¤í–‰",
                        children: {
                            "1-2-1": { title: "ì‹­ê°„(åå¹²): ë³€í™”í•˜ëŠ” ì˜¤í–‰ì˜ í‘œí˜„" },
                            "1-2-2": { title: "ì²œê°„ì˜ ìŒì–‘ê³¼ ì˜¤í–‰ ë¶„ë¥˜" },
                            "1-2-3": { title: "ì‹­ê°„ì˜ ë¬¼ë¦¬ì /ìì—°ì  íŠ¹ì§•ê³¼ ëŒ€í‘œ ë¬¼ìƒ" }
                        }
                    },
                    "1-3": {
                        title: "ì˜¤í–‰ì˜ ìƒí˜¸ì‘ìš©: ìƒ(ç”Ÿ), ê·¹(å‰‹), ì¶©(æ²–), í•©(åˆ)",
                        children: {
                            "1-3-1": { title: "ì¶©ê³¼ í•©ì˜ íŒŒë™ì  ì¦ëª…: ë³´ê°• ê°„ì„­ê³¼ ìƒì‡„ ê°„ì„­" },
                            "1-3-2": { title: "ì˜¤í–‰ì˜ í•©í™” í˜„ìƒ (êµ´ì ˆ, ì—­í™”)" }
                        }
                    },
                    "1-4": {
                        title: "ì‹­ì„±(åæ˜Ÿ): ì¸ê°„ ë³¸ì—°ì˜ ìš•êµ¬ì™€ ì—ë„ˆì§€",
                        children: {
                            "1-4-1": { title: "ì‹­ì„±ì´ë€ ë¬´ì—‡ì´ë©°, ì™œ ë‚˜íƒ€ë‚˜ëŠ”ê°€" },
                            "1-4-2": { title: "ë³¸ì›(ê¸°ì¤€ ì˜¤í–‰)ê³¼ ì‹­ì„±: ë‚˜ì™€ ì˜¤í–‰ì˜ ê´€ê³„ (ìœ¡ì¹œ)" },
                            "1-4-3": { title: "ì‹­ì„±ì˜ ì›ë¦¬: ì—ë„ˆì§€ ì¤€ìœ„ì™€ ì‹¬ë¦¬ì /í–‰ë™ì  íŠ¹ì„±" }
                        }
                    },
                    "1-5": { title: "í† ì²´(ì§ˆëŸ‰ì²´)ë¥¼ ì§€ë‚˜ëŠ” ì‹­ê°„ì˜ ì§€ì—° í˜„ìƒ: 12ì§€ì§€ì˜ íƒ„ìƒ ì›ë¦¬" }
                }
            },
            "part2": {
                title: "ì œ2ë¶€. ìš´ê³¼ ê¸°: ì‹œê°„ê³¼ ì—ë„ˆì§€ì˜ ì‹¤ì²´ì  ë°œí˜„",
                children: {
                    "2-1": {
                        title: "ìš´(é‹)ê³¼ ê¸°(æ°£)ì˜ ëª…ëª…: ì²œê°„ê³¼ ì§€ì§€",
                        children: {
                            "2-1-1": { title: "ìš´(ì²œê°„): ë•Œ, ì‹œì , ì£¼ê¸°ì  ë³€í™”" },
                            "2-1-2": { title: "ê¸°(ì§€ì§€): ê¸°ì„¸, ì—ë„ˆì§€, í˜, ì£¼ë³€ í™˜ê²½ì˜ ì˜í–¥" },
                            "2-1-3": { title: "ìš´ê¸°(é‹æ°£)ì˜ ì‹¤ì œ: ì²œê°„ì€ ê¸°ë¥¼ ë‹´ëŠ” ê·¸ë¦‡" }
                        }
                    },
                    "2-2": {
                        title: "ìš´ê¸°ì˜ ìì—° í˜„ìƒ: ê³¼í•™ì  ì—°ê²°ê³ ë¦¬",
                        children: {
                            "2-2-1": { title: "ì›ìì˜ ì „ì ì˜¤ë¹„íƒˆê³¼ ì±„ì›€ ìˆœì„œ" },
                            "2-2-2": { title: "ë„íŒŒë¯¼ê³¼ ë„íŒŒë¯¼ ìˆ˜ìš©ì²´" },
                            "2-2-3": { title: "í˜¸ë¥´ëª¬ê³¼ í˜¸ë¥´ëª¬ ìˆ˜ìš©ì²´" },
                            "2-2-4": { title: "ê°ì¢… ë°”ì´ëŸ¬ìŠ¤ì™€ ì ‘ì´‰ ìˆ˜ìš©ì²´" },
                            "2-2-5": { title: "ë‚¨ìì™€ ì—¬ìì˜ ì„±ê¸° ëª¨ìŠµ ì°¨ì´: ìš´ê¸°ì™€ ì§ˆëŸ‰ì²´ì˜ ê´€ê³„" }
                        }
                    },
                    "2-3": {
                        title: "60ê°‘ì: ìš´ê¸°ì˜ ê¸°ë³¸ êµ¬ì„± ì›ë¦¬",
                        children: {
                            "2-3-1": { title: "60ê°‘ìì˜ ì¢…ë¥˜ì™€ ìì²´ íˆ¬ê°„" }
                        }
                    },
                    "2-4": {
                        title: "ì§€ì§€(åœ°æ”¯)ì™€ ì§€ì¥ê°„(åœ°è—å¹²): ìš´ê¸° ë°œí˜„ì˜ ê¹Šì´",
                        children: {
                            "2-4-1": { title: "12ì§€ì§€ì˜ êµ¬ì„±ê³¼ ì§€ì¥ê°„ì˜ ë°œí˜„ ìˆœì„œ" },
                            "2-4-2": { title: "ì§€ì¥ê°„ì˜ ìˆ˜ì¹˜: ê¸°ì˜ í¬ê¸°" }
                        }
                    },
                    "2-5": {
                        title: "íˆ¬ê°„(é€å¹²): ì§€ì¥ê°„ì˜ ì—ë„ˆì§€ê°€ ì²œê°„ìœ¼ë¡œ ë°œí˜„ë˜ëŠ” í˜„ìƒ",
                        children: {
                            "2-5-1": { title: "ì‹ ê°•(èº«å¼º)ê³¼ ì‹ ì•½(èº«å¼±)ì˜ ì¬í•´ì„" }
                        }
                    },
                    "2-6": {
                        title: "ì‚¬ì£¼íŒ”ì: ì‚¶ì˜ ìš´ê¸° êµ¬ì¡°",
                        children: {
                            "2-6-1": { title: "ë…„ì›”ì¼ì‹œ ì‚¬ì£¼ì˜ êµ¬ì„±ê³¼ ì˜ë¯¸" },
                            "2-6-2": { title: "ì‚¬ì£¼ì˜ ê¸°ì : ì¶œìƒ ì‹œì ì— ì •í•´ì§€ëŠ” ìš´ê¸°" },
                            "2-6-3": { title: "ì¼ìƒìƒí™œì—ì„œ ì‚¬ì£¼ì˜ ì‘ë™ ì›ë¦¬ ê²½í—˜" }
                        }
                    },
                    "2-7": {
                        title: "í˜„ìš´(ç¾é‹): ì˜¤ëŠ˜ì˜ ìš´ì„¸ì™€ ì‚¬ì£¼ì˜ ìƒí˜¸ì‘ìš©",
                        children: {
                            "2-7-1": { title: "ì—¬ëŸ¬ ìš´ê¸°ì˜ ë™ì‹œ ì‘ìš© ê³„ì‚°: ìŒì–‘ ì‚¼í•©ë¡ " },
                            "2-7-2": { title: "ìš´ê¸°ì˜ ì‘ë™ ëª¨ë¸: í™€ë¤ ê²Œì„ ë¹„ìœ " }
                        }
                    }
                }
            },
            "part3": {
                title: "ì œ3ë¶€. 'ì—­ì‚¬ì£¼' í•µì‹¬ ì´ë¡ : ë³¸ì› ì´ë™, ìˆ˜ìš©ìš´, í•©í™”",
                children: {
                    "3-1": {
                        title: "ë³¸ì›(æœ¬æº) ì´ë™ë¡ : ì‚¶ì˜ ë³€í™”ë¥¼ ì½ëŠ” ìƒˆë¡œìš´ ê¸°ì¤€ì ",
                        children: {
                            "3-1-1": { title: "ê·¼ë¬˜í™”ì‹¤(æ ¹è‹—èŠ±å¯¦) ì›ë¦¬ë¶€í„° ì‹œì‘í•˜ëŠ” ë³¸ì›ì˜ ë³€í™”" },
                            "3-1-2": { title: "ë³¸ì›ì´ë™ì˜ ì‹œê¸°: 18ë…„ ì£¼ê¸°ì™€ ê·¸ ì¦ê±°" },
                            "3-1-3": { title: "ë‚˜ì´ê°€ ë“¤ìˆ˜ë¡ ì£½ìŒì— ì´ë¥´ëŠ” ê³¼ì •: ìƒëª…ì€ ì†Œìš©ëŒì´ì™€ ê°™ë‹¤" }
                        }
                    },
                    "3-2": {
                        title: "ìˆ˜ìš©ìš´(å—å®¹é‹)ë¡ : ì‹­ê°„ ì›€ì§ì„ì˜ ì›ë¦¬",
                        children: {
                            "3-2-1": { title: "ìŒì–‘ì˜¤í–‰ ì›ë¦¬ì˜ ì„¸ë¶„í™”" },
                            "3-2-2": { title: "í† ì²´(ì§ˆëŸ‰ì²´)ì— ëŒ€í•œ ì§€ì²´ ë° ë³µì‚¬ í˜„ìƒ" },
                            "3-2-3": { title: "ì´ì„±ì§ˆì²´(ì§ìˆ˜): ì˜¤ë¥¸ìª½ ë‚˜ì„ ë§Œ ì¡´ì¬í•˜ëŠ” ì„¸ìƒ" },
                            "3-2-4": { title: "ì²œê°„ì˜ ê°œìˆ˜ ì¦ê°€ê°€ ìš´ì˜ ê°ì†Œë¥¼ ì˜ë¯¸í•˜ëŠ” ì´ìœ " },
                            "3-2-5": { title: "ì§€ì¥ê°„ì˜ í¬ê¸°ì™€ ìš´ì˜ í¬ê¸° ë° ëŠ¥ë ¥" }
                        }
                    },
                    "3-3": {
                        title: "í•©í™”(åˆåŒ–)ë¡ : ìš´ê¸°ì˜ ë¡œë Œì¸  ë‚˜ë¹„ ê³¡ì„ ",
                        children: {
                            "3-3-1": { title: "ì˜¤í–‰ì˜ í•©í™”: ë³¸ë˜ì˜ ì˜¤í–‰ì„ ë²„ë¦¬ê³  ë‹¤ë¥¸ ì˜¤í–‰ìœ¼ë¡œ ë°”ë€ŒëŠ” í˜„ìƒ" },
                            "3-3-2": { title: "ì§€ì¥ê°„ì˜ í¬ê¸°ì™€ í•©í™”: ì˜¤ìš´ì˜ ë‚˜ë¹„" },
                            "3-3-3": { title: "ë¡œë Œì¸ ì˜ ë‚˜ë¹„ ê³¡ì„ ê³¼ í•©í™” í˜„ìƒì˜ ìœ ì‚¬ì„±" }
                        }
                    }
                }
            },
            "part4": {
                title: "ì œ4ë¶€. 'ì—­ì‚¬ì£¼'ì˜ ë‹¤ì–‘í•œ ìš´: ì‚¶ì˜ ì—ë„ˆì§€ë¥¼ ì½ë‹¤",
                children: {
                    "4-1": {
                        title: "ì¸ì²´ì˜ ìš´ê¸°: ì¤‘ìš´(ä¸­é‹)",
                        children: {
                            "4-1-1": { title: "ì¸ë¥˜ ë³´í¸ì˜ ì‹ ì²´ì  íŠ¹ì§•ê³¼ ìš´ê¸° ë³€í™”ì˜ ê´€ê³„" },
                            "4-1-2": { title: "5ë…„ ì£¼ê¸° ì²´ì¤‘ìš´ì˜ ì‹œì‘ê³¼ ë³€í™”" },
                            "4-1-3": { title: "ê²½ë½ì„ í†µí•œ ìš´ê¸°ì˜ ëŠë‚Œ" },
                            "4-1-4": { title: "ê²½ë½ì˜ ìƒì„±ê³¼ ì˜¤í–‰ ë°˜ì‘" },
                            "4-1-5": { title: "ì˜¤í–‰ë³„ ì²´ì§ˆê³¼ íŠ¹ì§•" },
                            "4-1-6": { title: "ì˜¤í–‰ê³¼ í‘œì •: ìš´ê¸°ê°€ ê°ì •ì— ë¯¸ì¹˜ëŠ” ì˜í–¥" }
                        }
                    },
                    "4-2": {
                        title: "ì‚¶ì˜ í° íë¦„: ì²´ì¥ìš´ê³¼ ëŒ€ìš´",
                        children: {
                            "4-2-1": { title: "ëŒ€ìš´: ì›”ìš´ì˜ 10ë…„ ì£¼ê¸° ë³€í™”" },
                            "4-2-2": { title: "ì²´ëŒ€ìš´: ê·¼ë¬˜í™”ì‹¤ì˜ ì›ë¦¬ì— ì˜í•œ 18ë…„ ì£¼ê¸° ë³€í™”" },
                            "4-2-3": { title: "ì—ë„ˆì§€ íë¦„ì— ë”°ë¥¸ ì°¨ì´ ì¸ì‹" }
                        }
                    },
                    "4-3": {
                        title: "í˜„ì¬ì˜ ìš´: í˜„ìš´(ç¾é‹)",
                        children: {
                            "4-3-1": { title: "í˜„ìš´: í˜„ì¬ì˜ ë…„ì›”ì¼ì‹œ ìš´ê¸°" },
                            "4-3-2": { title: "í˜„ìš´ì˜ ë‹¤ì–‘ì„±ê³¼ ê³µí†µ ì ìš©" },
                            "4-3-3": { title: "ì‚¬ì£¼ì™€ í˜„ìš´ì˜ í•©ì³ì§„ í•´ì„ì˜ ì¤‘ìš”ì„±" }
                        }
                    },
                    "4-4": {
                        title: "ì¥ì†Œì˜ ìš´ê¸°: ì§€ìš´ê³¼ ì¥ìš´",
                        children: {
                            "4-4-1": { title: "ì§€ìš´: ì§€êµ¬ì˜ ê²½ë„ë³„/ìœ„ë„ë³„ ì˜¤í–‰ ì„¤ì •ê³¼ ì‘ìš©" },
                            "4-4-2": { title: "ì§€ìš´ì˜ ì‹œê¸°ë³„ ë³€í™”: íƒœì–‘ì˜ ê³ ë„ì™€ ì—ë„ˆì§€ ë³´ì •" },
                            "4-4-3": { title: "ì¥ìš´: 20ë…„ ì£¼ê¸°ì˜ ìš´, í’ìˆ˜ì§€ë¦¬ì™€ ì „ìŸ/ì •ë³µì˜ ì—­ì‚¬" },
                            "4-4-4": { title: "ì§€ìš´ì˜ íŠ¹ì§• ë° ê°œìš´ë²• í™œìš©" }
                        }
                    }
                }
            },
            "part5": {
                title: "ì œ5ë¶€. 'ì—­ì‚¬ì£¼' ì˜ˆì¸¡ì˜ ì™„ì„±: ì¸ìƒ ê·¸ë˜í”„ì™€ ê°œìš´ ì „ëµ",
                children: {
                    "5-1": {
                        title: "ì¸ìƒ ê·¸ë˜í”„ì˜ ë„ì¶œê³¼ ê¸°ë³¸ í•´ì„",
                        children: {
                            "5-1-1": { title: "'ì—­ì‚¬ì£¼' ì¸ìƒ ê·¸ë˜í”„ì˜ ì—­í• " },
                            "5-1-2": { title: "ì¶©ì˜ ì ìš©ê³¼ ê·¸ë˜í”„ í•´ì„" },
                            "5-1-3": { title: "ì‹­ì„±ê³¼ í•©í™”ë¡œ ê·¸ë˜í”„ ë³´ëŠ” ë°©ë²•" }
                        }
                    },
                    "5-2": {
                        title: "ì˜ˆì¸¡ì˜ ì •í™•ì„±ì„ ë†’ì´ëŠ” ì˜¤ì°¨ ìˆ˜ì •",
                        children: {
                            "5-2-1": { title: "ê· ì‹œì°¨ì™€ íƒœì–‘ì‹œ" },
                            "5-2-2": { title: "ë‹¬ë ¥ ì˜¤ì°¨: ì§€êµ¬ ê³µì „ì¼ê³¼ ìœ¤ë…„ì˜ ì˜í–¥" },
                            "5-2-3": { title: "ì¼, ì›”, ë…„ì´ ë°”ë€ŒëŠ” í¬ì¸íŠ¸" },
                            "5-2-4": { title: "ìš´ê¸°ì˜ ë¶ˆí™•ì‹¤ì„±: ë¯¸ë°œê²¬ ìš´ê¸° ë° ì˜ˆì¸¡ì˜ í•œê³„" }
                        }
                    },
                    "5-3": {
                        title: "'ì—­ì‚¬ì£¼' ì‹¤ì „ í•´ì„ ì‚¬ë¡€",
                        children: {
                            "5-3-1": { title: "ì‹¤ì œ ì¸ìƒ ê·¸ë˜í”„ì™€ ì‚¬ë¡€ë¥¼ í†µí•œ í•´ì„ ë°©ë²•" },
                            "5-3-2": { title: "ì‚¬ê³  ì‚¬ë¡€ ë¶„ì„: ìš´ê¸° ì‘ìš© ê³¼ì •" },
                            "5-3-3": { title: "ê¶í•© ì‚¬ë¡€ ë¶„ì„" }
                        }
                    },
                    "5-4": {
                        title: "'ì—­ì‚¬ì£¼'ë¥¼ í†µí•œ ê°œìš´ ì „ëµ",
                        children: {
                            "5-4-1": { title: "ìš´ê¸°ì˜ ì‘ë™ ê³¼ì •: ì™¸ë¶€ ìš´, ê³ ìœ  ìš´, ì„ íƒê³¼ ì˜ì§€" },
                            "5-4-2": { title: "ìš´ì„¸ì˜ ë³€ìˆ˜ ì¡°ì •" },
                            "5-4-3": { title: "ì¢‹ì€ ìš´ì˜ ê·¹ëŒ€í™”ì™€ ë‚˜ìœ ìš´ì˜ íšŒí”¼ ì „ëµ" },
                            "5-4-4": { title: "ê²°í˜¼, ì‚¬ì—…, ì·¨ì—… ë“±ì— ìš´ê¸°ê°€ ë¯¸ì¹˜ëŠ” ì˜í–¥ê³¼ í™œìš©" }
                        }
                    }
                }
            },
            "epilogue": {
                title: "ì—í•„ë¡œê·¸: AI ì‹œëŒ€, 'ì—­ì‚¬ì£¼'ì™€ ìƒìƒí•˜ë‹¤",
                children: {
                    "e1": { title: "AIì™€ì˜ ê²½ìŸê³¼ ìƒìƒ: ì¸ê°„ ì˜ˆì¸¡ì˜ ê°€ì¹˜" },
                    "e2": { title: "'ì—­ì‚¬ì£¼'ê°€ ì œì‹œí•˜ëŠ” ì‚¶ì˜ ìƒˆë¡œìš´ ì§€ë„ì™€ í†µì°°" },
                    "e3": { title: "'ì—­ì‚¬ì£¼' ê³µë¶€ì˜ ì˜ë¯¸ì™€ í™œìš© ë°©ì•ˆ" },
                    "e4": { title: "'ì—­ì‚¬ì£¼'ì˜ í•œê³„ì™€ ê°œìš´ì˜ ê°€ëŠ¥ì„±" }
                }
            }
        };

        // âœ… window ê°ì²´ì— í• ë‹¹í•˜ì—¬ toc-manager.jsì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        window.tableOfContents = tableOfContents;


        let currentChapterId = null;
        let isEditMode = false;
        let originalContent = '';
        let chapterData = {};

        const TOTAL_PAGES = 500;
        const CHARS_PER_PAGE = 675; // A5 ê¸°ì¤€, 25í–‰ Ã— 27ì = 675ì

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            await loadChapterData();
            renderChapterTree();
            updateProgress();
            
            // ëª¨ë‘ ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            const collapseBtn = document.getElementById('collapseAllBtn');
            let isAllCollapsed = false;
            
            collapseBtn.addEventListener('click', () => {
                const allToggles = document.querySelectorAll('.toggle-btn');
                const allSubLists = document.querySelectorAll('.sub-chapter, .sub-sub-chapter');
                
                if (isAllCollapsed) {
                    // ëª¨ë‘ í¼ì¹˜ê¸°
                    allToggles.forEach(btn => {
                        btn.classList.remove('collapsed');
                        btn.classList.add('expanded');
                    });
                    allSubLists.forEach(ul => {
                        ul.classList.remove('collapsed');
                    });
                    collapseBtn.textContent = 'âˆ’ ëª¨ë‘ ì ‘ê¸°';
                    isAllCollapsed = false;
                } else {
                    // ëª¨ë‘ ì ‘ê¸°
                    allToggles.forEach(btn => {
                        btn.classList.remove('expanded');
                        btn.classList.add('collapsed');
                    });
                    allSubLists.forEach(ul => {
                        ul.classList.add('collapsed');
                    });
                    collapseBtn.textContent = '+ ëª¨ë‘ í¼ì¹˜ê¸°';
                    isAllCollapsed = true;
                }
            });
        });

        // ì§„í–‰ë¥  ê³„ì‚°
        function calculateProgress() {
            let totalChars = 0;
            let completedChapters = 0;
            let totalChapters = 0;

            // ëª¨ë“  ì±•í„° ìˆœíšŒ
            function countChapters(obj, prefix = '') {
                Object.keys(obj).forEach(key => {
                    if (key === 'bookInfo') return; // ì±… ê¸°ë³¸ ì •ë³´ëŠ” ì œì™¸
                    
                    const fullKey = prefix ? `${prefix}-${key}` : key;
                    const item = obj[key];

                    if (item.children) {
                        countChapters(item.children, fullKey);
                    } else {
                        totalChapters++;
                        const data = chapterData[fullKey];
                        if (data && data.content) {
                            // HTML íƒœê·¸ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ì¹´ìš´íŠ¸
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = data.content;
                            const textContent = tempDiv.textContent || tempDiv.innerText || '';
                            const chars = textContent.trim().length;
                            
                            if (chars > 0) {
                                totalChars += chars;
                                if (chars >= 100) { // ìµœì†Œ 100ì ì´ìƒì´ë©´ ì™„ë£Œë¡œ ê°„ì£¼
                                    completedChapters++;
                                }
                            }
                        }
                    }
                });
            }

            countChapters(tableOfContents);

            const pagesWritten = Math.floor(totalChars / CHARS_PER_PAGE);
            const percentage = Math.min(100, (pagesWritten / TOTAL_PAGES) * 100);

            return {
                pagesWritten,
                totalPages: TOTAL_PAGES,
                percentage: percentage.toFixed(1),
                completedChapters,
                totalChapters,
                totalChars
            };
        }

        // ì§„í–‰ë¥  UI ì—…ë°ì´íŠ¸
        function updateProgress() {
            const progress = calculateProgress();

            document.getElementById('pagesWritten').textContent = 
                `${progress.pagesWritten} / ${progress.totalPages} í˜ì´ì§€`;
            
            document.getElementById('chaptersCompleted').textContent = 
                `${progress.completedChapters} / ${progress.totalChapters} ì±•í„°`;
            
            // ì´ ê¸€ììˆ˜ í‘œì‹œ (ì²œ ë‹¨ìœ„ ì‰¼í‘œ ì¶”ê°€)
            document.getElementById('totalChars').textContent = 
                `${progress.totalChars.toLocaleString()} / 337,500 ì`;
            
            document.getElementById('progressPercentage').textContent = 
                `${progress.percentage}%`;
            
            const fillElement = document.getElementById('progressBarFill');
            fillElement.style.width = `${progress.percentage}%`;
            
            // ì§„í–‰ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
            const percentage = parseFloat(progress.percentage);
            let gradientColor;
            if (percentage < 30) {
                gradientColor = 'linear-gradient(90deg, #f44336 0%, #e91e63 100%)'; // ë¹¨ê°•
            } else if (percentage < 70) {
                gradientColor = 'linear-gradient(90deg, #FF9800 0%, #FFC107 100%)'; // ë…¸ë‘
            } else {
                gradientColor = 'linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%)'; // ì´ˆë¡
            }
            fillElement.style.background = gradientColor;
            
            if (progress.percentage > 5) {
                document.getElementById('progressBarText').textContent = 
                    `${progress.percentage}%`;
            } else {
                document.getElementById('progressBarText').textContent = '';
            }
        }

        // ì±•í„° ë°ì´í„° ë¡œë“œ
        async function loadChapterData() {
            try {
                const response = await fetch('/api/chapters');
                chapterData = await response.json();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            }
        }

        // ëª©ì°¨ íŠ¸ë¦¬ ë Œë”ë§
        function renderChapterTree() {
            // ì±•í„° ë§µ ë¹Œë“œ (ëª©ì°¨ ë Œë”ë§ ì „ì— í•­ìƒ ë§µ ê°±ì‹ )
            buildChapterMap();
            const treeElement = document.getElementById('chapterTree');
            treeElement.innerHTML = '';

            Object.keys(tableOfContents).forEach(key => {
                const chapter = tableOfContents[key];
                const li = document.createElement('li');
                li.className = 'chapter-item';

                // í—¤ë” ì»¨í…Œì´ë„ˆ ìƒì„±
                const header = document.createElement('div');
                header.className = 'chapter-item-header';

                // ìì‹ì´ ìˆìœ¼ë©´ í† ê¸€ ë²„íŠ¼ ì¶”ê°€
                if (chapter.children) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn expanded';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleChapter(toggleBtn);
                    };
                    header.appendChild(toggleBtn);
                }

                const link = document.createElement('a');
                link.className = 'chapter-link' + (chapterData[key]?.content ? ' has-content' : '');
                link.textContent = chapter.title;
                link.setAttribute('data-id', key);
                link.onclick = () => selectChapter(key);

                header.appendChild(link);
                li.appendChild(header);

                if (chapter.children) {
                    const subUl = document.createElement('ul');
                    subUl.className = 'chapter-tree sub-chapter';
                    renderSubChapters(chapter.children, subUl, key);
                    li.appendChild(subUl);
                }

                treeElement.appendChild(li);
            });
            
            // ëª¨ë°”ì¼ ëª©ì°¨ ì—…ë°ì´íŠ¸
            if (window.mobileUI && window.mobileUI.isInitialized) {
                setTimeout(() => window.mobileUI.refreshTocContent(), 100);
            }

        }

        // í•˜ìœ„ ì±•í„° ë Œë”ë§
        function renderSubChapters(children, parentElement, prefix) {
            Object.keys(children).forEach(key => {
                const child = children[key];
                const fullKey = prefix + '-' + key;
                
                const li = document.createElement('li');
                li.className = 'chapter-item';

                // í—¤ë” ì»¨í…Œì´ë„ˆ ìƒì„±
                const header = document.createElement('div');
                header.className = 'chapter-item-header';

                // ìì‹ì´ ìˆìœ¼ë©´ í† ê¸€ ë²„íŠ¼ ì¶”ê°€
                if (child.children) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn expanded';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleChapter(toggleBtn);
                    };
                    header.appendChild(toggleBtn);
                }

                const link = document.createElement('a');
                link.className = 'chapter-link' + (chapterData[fullKey]?.content ? ' has-content' : '');
                link.textContent = child.title;
                link.setAttribute('data-id', fullKey);
                link.onclick = () => selectChapter(fullKey);

                header.appendChild(link);
                li.appendChild(header);

                if (child.children) {
                    const subUl = document.createElement('ul');
                    subUl.className = 'chapter-tree sub-sub-chapter';
                    renderSubChapters(child.children, subUl, fullKey);
                    li.appendChild(subUl);
                }

                parentElement.appendChild(li);
            });
        }

        // ì±•í„° í† ê¸€ (ì ‘ê¸°/í¼ì¹˜ê¸°)
        function toggleChapter(button) {
            const li = button.closest('.chapter-item');
            const subList = li.querySelector('ul');
            
            if (!subList) return;

            if (button.classList.contains('expanded')) {
                // ì ‘ê¸°
                button.classList.remove('expanded');
                button.classList.add('collapsed');
                subList.classList.add('collapsed');
            } else {
                // í¼ì¹˜ê¸°
                button.classList.remove('collapsed');
                button.classList.add('expanded');
                subList.classList.remove('collapsed');
            }
        }

        // ì±•í„° ì„ íƒ
        async function selectChapter(chapterId) {
            if (isEditMode && currentChapterId !== chapterId) {
                if (!confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }

            currentChapterId = chapterId;
            
            // ëª¨ë“  ë§í¬ì—ì„œ active ì œê±°
            document.querySelectorAll('.chapter-link').forEach(link => {
                link.classList.remove('active');
            });

            // í˜„ì¬ ë§í¬ì— active ì¶”ê°€
            event.target.classList.add('active');

            // ì±•í„° ë°ì´í„° ë¡œë“œ
            await loadChapterContent(chapterId);
            
            // ê°€ì´ë“œ íŒ¨ë„ í‘œì‹œ ë° ê°€ì´ë“œ ìƒì„±
            showGuidePanel();
            await generateGuide(chapterId);
        }

        // ì±•í„° ë‚´ìš© ë¡œë“œ
        async function loadChapterContent(chapterId) {
            try {
                const response = await fetch(`/api/chapters/${chapterId}`);
                const data = await response.json();

                const title = getChapterTitle(chapterId);
                document.getElementById('contentTitle').textContent = title;
                document.getElementById('contentActions').style.display = 'flex';

                if (data.content) {
                    // ë‚´ìš©ì´ ìˆìœ¼ë©´ ë·° ëª¨ë“œë¡œ í‘œì‹œ
                    renderViewMode(data);
                } else {
                    // ë‚´ìš©ì´ ì—†ìœ¼ë©´ ë°”ë¡œ í¸ì§‘ ëª¨ë“œ
                    enterEditMode({ content: '', attachments: [] });
                }
            } catch (error) {
                console.error('ì±•í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ì±•í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            }
        }

        // ì±•í„° ë§µ (ID â†’ Chapter ê°ì²´) ìƒì„±
        let chapterMap = {};
        
        function buildChapterMap() {
            chapterMap = {};
            
            function traverse(obj, prefix = '') {
                Object.keys(obj).forEach(key => {
                    const chapter = obj[key];
                    const fullId = prefix ? `${prefix}-${key}` : key;
                    
                    // ë§µì— ì¶”ê°€
                    chapterMap[fullId] = {
                        title: chapter.title,
                        isSpecial: chapter.isSpecial,
                        children: chapter.children
                    };
                    
                    // ìì‹ì´ ìˆìœ¼ë©´ ì¬ê·€ íƒìƒ‰
                    if (chapter.children) {
                        traverse(chapter.children, fullId);
                    }
                });
            }
            
            traverse(tableOfContents);
            console.log('ğŸ“‹ ì±•í„° ë§µ ìƒì„± ì™„ë£Œ:', Object.keys(chapterMap).length, 'ê°œ');
        }
        
        // ì±•í„° ì œëª© ê°€ì ¸ì˜¤ê¸° (ë§µ ë°©ì‹)
        function getChapterTitle(chapterId) {
            if (!chapterId) return '';
            
            // ë§µì´ ë¹„ì–´ìˆìœ¼ë©´ ë¹Œë“œ
            if (Object.keys(chapterMap).length === 0) {
                buildChapterMap();
            }
            
            const chapter = chapterMap[chapterId];
            if (chapter) {
                return chapter.title || '';
            }
            
            console.warn(`âš ï¸ ì±•í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${chapterId}`);
            return '';
        }

        // ë·° ëª¨ë“œ ë Œë”ë§
        function renderViewMode(data) {
            isEditMode = false;
            document.getElementById('editBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';

            const editorArea = document.getElementById('editorArea');
            editorArea.innerHTML = `
                <div class="view-mode">
                    ${data.content}
                </div>
                ${renderAttachments(data.attachments || [], false)}
            `;
        }

        // í¸ì§‘ ëª¨ë“œ ì§„ì…
        function enterEditMode(data) {
            console.log('ğŸŸ¡ enterEditMode í˜¸ì¶œë¨');
            console.log('  - currentChapterId:', currentChapterId);

            isEditMode = true;
            originalContent = data.content;

            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'inline-block';

            // ì œëª© í¸ì§‘ í•„ë“œ ìƒì„± (toc-manager.js)
            let titleEditorHTML = '';
            if (window.TOCManager && typeof window.TOCManager.createTitleEditorHTML === 'function') {
                titleEditorHTML = window.TOCManager.createTitleEditorHTML(currentChapterId);
                console.log('  - ì œëª© í¸ì§‘ í•„ë“œ ìƒì„±ë¨');
            } else {
                console.warn('âš ï¸ TOCManager.createTitleEditorHTMLë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }

            const editorArea = document.getElementById('editorArea');
            editorArea.innerHTML = `
                ${titleEditorHTML}
                <div class="toolbar">
                    <!-- í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê·¸ë£¹ -->
                    <div class="toolbar-group">
                        <span class="toolbar-group-label">ğŸ“ í…ìŠ¤íŠ¸</span>
                        <button onclick="insertFormat('p')" title="ë³¸ë¬¸">ë³¸ë¬¸</button>
                        <button onclick="insertFormat('h1')" title="ì œëª© 1">ì œëª© 1</button>
                        <button onclick="insertFormat('h2')" title="ì œëª© 2">ì œëª© 2</button>
                        <button onclick="insertFormat('h3')" title="ì œëª© 3">ì œëª© 3</button>
                    </div>

                    <!-- ì„œì‹ ê·¸ë£¹ -->
                    <div class="toolbar-group">
                        <span class="toolbar-group-label">âœï¸ ì„œì‹</span>
                        <button onclick="insertFormat('bold')" title="êµµê²Œ"><strong>B</strong></button>
                        <button onclick="insertFormat('italic')" title="ê¸°ìš¸ì„"><em>I</em></button>
                        <button onclick="insertFormat('underline')" title="ë°‘ì¤„"><u>U</u></button>
                    </div>

                    <!-- êµ¬ë¶„ì„  ê·¸ë£¹ -->
                    <div class="toolbar-group">
                        <span class="toolbar-group-label">â– êµ¬ë¶„ì„ </span>
                        <button onclick="insertFormat('hr-solid')" title="ì‹¤ì„ ">â”â”â”</button>
                        <button onclick="insertFormat('hr-dashed')" title="ì ì„ ">â”ˆâ”ˆâ”ˆ</button>
                    </div>

                    <!-- ì‚½ì… ê·¸ë£¹ -->
                    <div class="toolbar-group">
                        <span class="toolbar-group-label">ğŸ“Š ì‚½ì…</span>
                        <button onclick="insertTableWithSize()" title="í‘œ ì‚½ì…">ğŸ“Š í‘œ</button>
                        <button onclick="document.getElementById('imageInput').click()" class="btn-image" title="ì´ë¯¸ì§€ ì‚½ì…">ğŸ–¼ï¸ ì´ë¯¸ì§€</button>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="insertImage(this)">
                    </div>
                </div>
                <div id="contentEditor" contenteditable="true" class="content-editor-editable">${data.content || '<p>ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...</p>'}</div>
                ${renderAttachments(data.attachments || [], true)}
            `;

            console.log('âœ… í¸ì§‘ ëª¨ë“œ UI ìƒì„± ì™„ë£Œ');
            // ë“œë˜ê·¸ë“œë¡­ ì œê±°ë¨ (ì‚¬ìš©ì ìš”ì²­)
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDragAndDrop() {
            const editor = document.getElementById('contentEditor');
            const overlay = document.getElementById('dropOverlay');
            let dragCounter = 0;

            editor.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter++;
                if (overlay) {
                    overlay.style.display = 'flex';
                }
            });

            editor.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter--;
                if (dragCounter === 0 && overlay) {
                    overlay.style.display = 'none';
                }
            });

            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            editor.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter = 0;
                if (overlay) {
                    overlay.style.display = 'none';
                }

                const files = e.dataTransfer.files;
                if (files.length === 0) return;

                // ì´ë¯¸ì§€ íŒŒì¼ë§Œ í•„í„°ë§
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                
                if (imageFiles.length === 0) {
                    showMessage('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ë“œë¡­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', true);
                    return;
                }

                // ê° ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì‚½ì…
                for (const file of imageFiles) {
                    await uploadAndInsertImageAtCursor(file);
                }
            });
        }

        // ì»¤ì„œ ìœ„ì¹˜ì— ì´ë¯¸ì§€ ì‚½ì…
        async function uploadAndInsertImageAtCursor(file) {
            showMessage('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const editor = document.getElementById('contentEditor');
                    const imageHTML = `<br><br><img src="${result.path}" alt="${result.originalname}" style="width: 80%; height: auto; margin: 20px auto; display: block;"><br><br>`;
                    
                    if (editor.contentEditable === 'true') {
                        // contenteditableì˜ ê²½ìš° í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…
                        editor.focus();
                        document.execCommand('insertHTML', false, imageHTML);
                    } else {
                        // textareaì˜ ê²½ìš° (í•˜ìœ„ í˜¸í™˜ì„±)
                        const cursorPos = editor.selectionStart;
                        editor.value = editor.value.substring(0, cursorPos) + imageHTML + editor.value.substring(cursorPos);
                        editor.focus();
                        editor.selectionStart = editor.selectionEnd = cursorPos + imageHTML.length;
                    }
                    
                    showMessage('ì´ë¯¸ì§€ê°€ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return true;
                } else {
                    showMessage('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                    return false;
                }
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                return false;
            }
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì‚½ì… (ê³µí†µ í•¨ìˆ˜)
        async function uploadAndInsertImage(file, cursorPos) {
            showMessage('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const editor = document.getElementById('contentEditor');
                    // ì¤„ë°”ê¿ˆ 2ê°œì”© ì¶”ê°€í•˜ì—¬ ì´ë¯¸ì§€ ì•ë’¤ë¡œ ì—¬ë°± ìƒì„±, ê°€ë¡œ 80%ë¡œ ì„¤ì •
                    const imageTag = `<br><br><img src="${result.path}" alt="${result.originalname}" style="width: 80%; height: auto; margin: 20px auto; display: block;"><br><br>`;
                    
                    // contenteditable divì¸ ê²½ìš°
                    if (editor.contentEditable === 'true') {
                        const imgElement = document.createElement('div');
                        imgElement.innerHTML = imageTag;
                        
                        // í˜„ì¬ ì„ íƒ ì˜ì—­ì— ì‚½ì…
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            range.deleteContents();
                            range.insertNode(imgElement.firstChild);
                        }
                    } else {
                        // textareaì¸ ê²½ìš° (í•˜ìœ„ í˜¸í™˜ì„±)
                        editor.value = editor.value.substring(0, cursorPos) + imageTag + editor.value.substring(cursorPos);
                        editor.focus();
                        editor.selectionStart = editor.selectionEnd = cursorPos + imageTag.length;
                    }
                    
                    showMessage('ì´ë¯¸ì§€ê°€ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return true;
                } else {
                    showMessage('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                    return false;
                }
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                return false;
            }
        }


        // í‘œ í¬ê¸° ì…ë ¥ë°›ì•„ ì‚½ì…
        function insertTableWithSize() {
            const rows = prompt('í–‰(ì„¸ë¡œ) ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '3');
            const cols = prompt('ì—´(ê°€ë¡œ) ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '3');
            
            if (rows === null || cols === null) return; // ì·¨ì†Œ
            
            const numRows = parseInt(rows);
            const numCols = parseInt(cols);
            
            if (isNaN(numRows) || isNaN(numCols) || numRows < 1 || numCols < 1) {
                alert('ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (numRows > 20 || numCols > 10) {
                alert('í‘œê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. í–‰ì€ ìµœëŒ€ 20ê°œ, ì—´ì€ ìµœëŒ€ 10ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            let tableHTML = '<table>\n';
            
            // í—¤ë” í–‰
            tableHTML += '  <tr>\n';
            for (let j = 1; j <= numCols; j++) {
                tableHTML += `    <th>í—¤ë”${j}</th>\n`;
            }
            tableHTML += '  </tr>\n';
            
            // ë°ì´í„° í–‰ë“¤
            for (let i = 1; i < numRows; i++) {
                tableHTML += '  <tr>\n';
                for (let j = 1; j <= numCols; j++) {
                    tableHTML += `    <td>ë°ì´í„°${i}-${j}</td>\n`;
                }
                tableHTML += '  </tr>\n';
            }
            
            tableHTML += '</table><br>';
            
            const editor = document.getElementById('contentEditor');
            if (editor) {
                editor.focus();
                document.execCommand('insertHTML', false, tableHTML);
            }
        }

        // ì„œì‹ ì‚½ì…
        function insertFormat(type) {
            const editor = document.getElementById('contentEditor');
            
            // contenteditable divì¸ ê²½ìš°
            if (editor.contentEditable === 'true') {
                editor.focus();
                
                switch(type) {
                    case 'h1':
                        document.execCommand('formatBlock', false, '<h1>');
                        break;
                    case 'h2':
                        document.execCommand('formatBlock', false, '<h2>');
                        break;
                    case 'h3':
                        document.execCommand('formatBlock', false, '<h3>');
                        break;
                    case 'hr':
                        document.execCommand('insertHTML', false, '<hr>');
                        break;
                    case 'table':
                        const tableHTML = `<table>
    <tr>
        <th>í—¤ë”1</th>
        <th>í—¤ë”2</th>
        <th>í—¤ë”3</th>
    </tr>
    <tr>
        <td>ë°ì´í„°1</td>
        <td>ë°ì´í„°2</td>
        <td>ë°ì´í„°3</td>
    </tr>
</table><br>`;
                        document.execCommand('insertHTML', false, tableHTML);
                        break;
                    case 'bold':
                        document.execCommand('bold', false, null);
                        break;
                    case 'italic':
                        document.execCommand('italic', false, null);
                        break;
                    case 'underline':
                        document.execCommand('underline', false, null);
                        break;
                    case 'p':
                        document.execCommand('formatBlock', false, '<p>');
                        break;
                    case 'hr-solid':
                        document.execCommand('insertHTML', false, '<hr style="border: none; border-top: 2px solid #999; margin: 20px 0;"><p></p>');
                        break;
                    case 'hr-dashed':
                        document.execCommand('insertHTML', false, '<hr style="border: none; border-top: 2px dashed #999; margin: 20px 0;"><p></p>');
                        break;
                }
            } else {
                // textareaì¸ ê²½ìš° (í•˜ìœ„ í˜¸í™˜ì„±)
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const selectedText = editor.value.substring(start, end);
                let insertText = '';

                switch(type) {
                    case 'h1':
                        insertText = `<h1>${selectedText || 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'}</h1>\n`;
                        break;
                    case 'h2':
                        insertText = `<h2>${selectedText || 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'}</h2>\n`;
                        break;
                    case 'h3':
                        insertText = `<h3>${selectedText || 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'}</h3>\n`;
                        break;
                    case 'hr':
                        insertText = '<hr>\n';
                        break;
                    case 'table':
                        insertText = `<table>
    <tr>
        <th>í—¤ë”1</th>
        <th>í—¤ë”2</th>
        <th>í—¤ë”3</th>
    </tr>
    <tr>
        <td>ë°ì´í„°1</td>
        <td>ë°ì´í„°2</td>
        <td>ë°ì´í„°3</td>
    </tr>
</table>\n`;
                        break;
                    case 'bold':
                        insertText = `<strong>${selectedText || 'êµµê²Œ'}</strong>`;
                        break;
                    case 'italic':
                        insertText = `<em>${selectedText || 'ê¸°ìš¸ì„'}</em>`;
                        break;
                }

                editor.value = editor.value.substring(0, start) + insertText + editor.value.substring(end);
                editor.focus();
            }
        }

        // ì²¨ë¶€íŒŒì¼ ë Œë”ë§
        function renderAttachments(attachments, editMode) {
            if (!attachments || attachments.length === 0) {
                if (!editMode) return '';
            }

            let html = '<div class="attachments"><h3>ğŸ“ ì²¨ë¶€íŒŒì¼</h3>';
            
            if (attachments.length > 0) {
                html += '<ul class="attachment-list">';
                attachments.forEach((file, index) => {
                    html += `
                        <li class="attachment-item">
                            <a href="${file.path}" target="_blank">${file.originalname}</a>
                            ${editMode ? `<button class="btn btn-danger" onclick="removeAttachment(${index})">ì‚­ì œ</button>` : ''}
                        </li>
                    `;
                });
                html += '</ul>';
            }

            if (editMode) {
                html += `
                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" onchange="uploadFile(this)" multiple>
                        <p>ğŸ“ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”</p>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // ì´ë¯¸ì§€ ì‚½ì… (ë²„íŠ¼ í´ë¦­)
        async function insertImage(input) {
            if (!input.files || input.files.length === 0) return;

            const file = input.files[0];
            
            // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
            if (!file.type.startsWith('image/')) {
                showMessage('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì‚½ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', true);
                input.value = '';
                return;
            }

            await uploadAndInsertImageAtCursor(file);
            input.value = '';
        }

        // íŒŒì¼ ì—…ë¡œë“œ (ì²¨ë¶€íŒŒì¼ìš©)
        async function uploadFile(input) {
            if (!input.files || input.files.length === 0) return;

            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // í˜„ì¬ ì±•í„° ë°ì´í„°ì— ì²¨ë¶€íŒŒì¼ ì¶”ê°€
                    const data = await fetch(`/api/chapters/${currentChapterId}`).then(r => r.json());
                    if (!data.attachments) data.attachments = [];
                    data.attachments.push({
                        filename: result.filename,
                        originalname: result.originalname,
                        path: result.path
                    });

                    // UI ì—…ë°ì´íŠ¸
                    enterEditMode(data);
                } else {
                    showMessage('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                }
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            }

            input.value = '';
        }

        // ì²¨ë¶€íŒŒì¼ ì‚­ì œ
        function removeAttachment(index) {
            if (!confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            // í˜„ì¬ ë°ì´í„°ì—ì„œ ì²¨ë¶€íŒŒì¼ ì œê±°
            fetch(`/api/chapters/${currentChapterId}`)
                .then(r => r.json())
                .then(data => {
                    data.attachments.splice(index, 1);
                    enterEditMode(data);
                    showMessage('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                });
        }

        // ì €ì¥
        async function saveContent() {
            console.log('ğŸ”µ saveContent í•¨ìˆ˜ í˜¸ì¶œë¨');
            console.log('  - currentChapterId:', currentChapterId);

            const editor = document.getElementById('contentEditor');
            console.log('  - editor ì¡´ì¬:', !!editor);

            if (!editor) {
                console.error('âŒ contentEditorë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                showMessage('í¸ì§‘ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }

            // contenteditable divì¸ ê²½ìš° innerHTML, textareaì¸ ê²½ìš° value ì‚¬ìš©
            const content = editor.contentEditable === 'true' ? editor.innerHTML : editor.value;
            console.log('  - content ê¸¸ì´:', content?.length || 0);

            // 1. ì±•í„° ì œëª© ì €ì¥ (toc-manager.js)
            console.log('ğŸ”µ ì œëª© ì €ì¥ ì‹œë„...');
            if (window.TOCManager && typeof window.TOCManager.saveChapterTitle === 'function') {
                const titleSaved = window.TOCManager.saveChapterTitle(currentChapterId);
                console.log('  - ì œëª© ì €ì¥ ê²°ê³¼:', titleSaved);
            } else {
                console.warn('âš ï¸ TOCManager.saveChapterTitleë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }

            console.log('ğŸ”µ ì±•í„° ë°ì´í„° ì¡°íšŒ ì¤‘...');
            const response = await fetch(`/api/chapters/${currentChapterId}`);
            const currentData = await response.json();
            console.log('  - í˜„ì¬ ë°ì´í„°:', currentData);

            try {
                console.log('ğŸ”µ ì„œë²„ì— ì €ì¥ ìš”ì²­ ì¤‘...');
                const saveResponse = await fetch(`/api/chapters/${currentChapterId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        attachments: currentData.attachments || []
                    })
                });

                const result = await saveResponse.json();
                console.log('  - ì„œë²„ ì‘ë‹µ:', result);

                if (result.success) {
                    console.log('âœ… ì €ì¥ ì„±ê³µ!');
                    showMessage('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await loadChapterData();
                    renderChapterTree();
                    await loadChapterContent(currentChapterId);
                } else {
                    console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', result);
                    showMessage('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                }
            } catch (error) {
                console.error('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                showMessage('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            }
        }

        // ì·¨ì†Œ
        function cancelEdit() {
            if (confirm('ë³€ê²½ì‚¬í•­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                loadChapterContent(currentChapterId);
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(message, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'status-message' + (isError ? ' error' : '');
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ê°€ì´ë“œ íŒ¨ë„ í‘œì‹œ
        function showGuidePanel() {
            document.getElementById('guidePanel').classList.add('active');
        }

        // ê°€ì´ë“œ ìƒì„±
        async function generateGuide(chapterId, existingContent = '') {
            const guideContent = document.getElementById('guideContent');
            guideContent.innerHTML = '<div class="guide-loading">AIê°€ ê¸€ì“°ê¸° ê°€ì´ë“œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>';

            try {
                const title = getChapterTitle(chapterId);
                const bookContext = `
ë„ì„œ ì œëª©: ììœ ì˜ì§€ ì˜ˆì¸¡
ë„ì„œ ì£¼ì œ: ëª…ë¦¬ ì´ë¡ ì— ëŒ€í•œ ìƒˆë¡œìš´ ì ‘ê·¼ ë°©ë²• (ì—­ì‚¬ì£¼)
íƒ€ê²Ÿ ë…ì: 45-60ì„¸, 25-30ì„¸ ë…ì
ë¬¸ì²´: ì „ë¬¸ì„±ê³¼ ì§„ì¤‘í•¨ì„ ìœ ì§€í•˜ë©´ì„œë„ ì´í•´í•˜ê¸° ì‰¬ìš´ ë¹„ë¬¸í•™ ìŠ¤íƒ€ì¼
`;

                // ì „ì²´ ëª©ì°¨ë¥¼ ì½ê¸° ì‰¬ìš´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                const tocText = generateTableOfContentsText();

                const response = await fetch('/api/generate-guide', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        existingContent: existingContent,
                        bookContext: bookContext,
                        tableOfContents: tocText,
                        currentChapterId: chapterId
                    })
                });

                const data = await response.json();
                
                if (data.success && data.guide) {
                    guideContent.innerHTML = data.guide;
                } else {
                    guideContent.innerHTML = `<p style="color: #f44336;">ê°€ì´ë“œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">
                        â€» AI ê°€ì´ë“œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Anthropic API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
                        ì„œë²„ ì‹¤í–‰ ì‹œ í™˜ê²½ë³€ìˆ˜ ANTHROPIC_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.<br>
                        ìì„¸í•œ ë‚´ìš©ì€ API_KEY_SETUP.md íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.
                    </p>`;
                }
            } catch (error) {
                console.error('ê°€ì´ë“œ ìƒì„± ì‹¤íŒ¨:', error);
                guideContent.innerHTML = `<p style="color: #f44336;">ê°€ì´ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 12px; color: #999; margin-top: 10px;">
                    ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                </p>`;
            }
        }

        // ì „ì²´ ëª©ì°¨ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        function generateTableOfContentsText() {
            let text = '';
            
            Object.keys(tableOfContents).forEach(key => {
                const chapter = tableOfContents[key];
                text += `\n${chapter.title}\n`;
                
                if (chapter.children) {
                    Object.keys(chapter.children).forEach(subKey => {
                        const subChapter = chapter.children[subKey];
                        text += `  - ${subChapter.title}\n`;
                        
                        if (subChapter.children) {
                            Object.keys(subChapter.children).forEach(subSubKey => {
                                const subSubChapter = subChapter.children[subSubKey];
                                text += `    â€¢ ${subSubChapter.title}\n`;
                            });
                        }
                    });
                }
            });
            
            return text;
        }

        // ì¬ê°€ì´ë“œ ìƒì„±
        async function regenerateGuide() {
            if (!currentChapterId) {
                showMessage('ì±•í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', true);
                return;
            }

            const editor = document.getElementById('contentEditor');
            let currentContent = '';
            
            if (editor) {
                // í¸ì§‘ ëª¨ë“œì¸ ê²½ìš°
                currentContent = editor.contentEditable === 'true' ? editor.innerHTML : editor.value;
            } else {
                // ë·° ëª¨ë“œì¸ ê²½ìš° - ì €ì¥ëœ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                try {
                    const response = await fetch(`/api/chapters/${currentChapterId}`);
                    const data = await response.json();
                    currentContent = data.content || '';
                } catch (error) {
                    console.error('ë‚´ìš© ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            // HTML íƒœê·¸ ì œê±°í•˜ì—¬ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ (ë¶„ì„ìš©)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentContent;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';

            // ë‚´ìš©ì´ ìˆë“  ì—†ë“  ê°€ì´ë“œ ìƒì„±
            // ë‚´ìš©ì´ ìˆìœ¼ë©´: ë‚´ìš© ë¶„ì„ + ë³´ì¶©/ìˆ˜ì • ì œì•ˆ
            // ë‚´ìš©ì´ ì—†ìœ¼ë©´: ëª©ì°¨ ê¸°ë°˜ ì‘ì„± ê°€ì´ë“œ
            if (textContent.trim().length > 0) {
                showMessage('ì‘ì„±ëœ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ì¬ê°€ì´ë“œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            } else {
                showMessage('ì±•í„° ì œëª©ê³¼ ëª©ì°¨ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°€ì´ë“œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            }
            
            await generateGuide(currentChapterId, textContent.trim());
        }

        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('editBtn').addEventListener('click', async () => {
            const response = await fetch(`/api/chapters/${currentChapterId}`);
            const data = await response.json();
            enterEditMode(data);
        });

        document.getElementById('saveBtn').addEventListener('click', function() {
            console.log('ğŸŸ¢ ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨!');
            saveContent();
        });

        document.getElementById('cancelBtn').addEventListener('click', cancelEdit);


        // ========== Phase 2: ëª©ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ ==========
        
        let isTocManageMode = false;

        // ëª©ì°¨ ê´€ë¦¬ ëª¨ë“œ í† ê¸€
        document.getElementById('tocManageBtn').addEventListener('click', () => {
            isTocManageMode = !isTocManageMode;
            const sidebar = document.querySelector('.sidebar');
            const btn = document.getElementById('tocManageBtn');
            
            if (isTocManageMode) {
                sidebar.classList.add('toc-manage-mode');
                btn.classList.add('active');
                btn.innerHTML = '<span>âœ–ï¸ ê´€ë¦¬ ëª¨ë“œ ì¢…ë£Œ</span>';
                renderChapterTreeWithActions();
                populateParentSelect();
            } else {
                sidebar.classList.remove('toc-manage-mode');
                btn.classList.remove('active');
                btn.innerHTML = '<span>ğŸ› ï¸ ëª©ì°¨ ê´€ë¦¬</span>';
                renderChapterTree();
            }
        });

        // ì•¡ì…˜ ë²„íŠ¼ì´ í¬í•¨ëœ ëª©ì°¨ íŠ¸ë¦¬ ë Œë”ë§
        function renderChapterTreeWithActions() {
            const treeElement = document.getElementById('chapterTree');
            treeElement.innerHTML = '';

            Object.keys(tableOfContents).forEach((key, index) => {
                const chapter = tableOfContents[key];
                const li = document.createElement('li');
                li.className = 'chapter-item';
                li.dataset.chapterId = key;

                const header = document.createElement('div');
                header.className = 'chapter-item-header';

                // ì œëª© ì˜ì—­ (í† ê¸€ ë²„íŠ¼ + ë§í¬)
                const titleWrapper = document.createElement('div');
                titleWrapper.className = 'chapter-title-wrapper';

                // í† ê¸€ ë²„íŠ¼
                if (chapter.children) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn expanded';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleChapter(toggleBtn);
                    };
                    titleWrapper.appendChild(toggleBtn);
                }

                // ì±•í„° ë§í¬
                const link = document.createElement('a');
                link.className = 'chapter-link' + (chapterData[key]?.content ? ' has-content' : '');
                link.textContent = chapter.title;
                link.setAttribute('data-id', key);
                link.onclick = () => selectChapter(key);
                titleWrapper.appendChild(link);

                header.appendChild(titleWrapper);

                // ì•¡ì…˜ ë²„íŠ¼ë“¤
                const actions = document.createElement('div');
                actions.className = 'toc-actions';
                
                // ìœ„ë¡œ ì´ë™
                if (index > 0) {
                    const upBtn = document.createElement('button');
                    upBtn.className = 'toc-action-btn up';
                    upBtn.innerHTML = 'â†‘';
                    upBtn.title = 'ìœ„ë¡œ ì´ë™';
                    upBtn.onclick = (e) => {
                        e.stopPropagation();
                        moveChapterUp(key);
                    };
                    actions.appendChild(upBtn);
                }

                // ì•„ë˜ë¡œ ì´ë™
                if (index < Object.keys(tableOfContents).length - 1) {
                    const downBtn = document.createElement('button');
                    downBtn.className = 'toc-action-btn down';
                    downBtn.innerHTML = 'â†“';
                    downBtn.title = 'ì•„ë˜ë¡œ ì´ë™';
                    downBtn.onclick = (e) => {
                        e.stopPropagation();
                        moveChapterDown(key);
                    };
                    actions.appendChild(downBtn);
                }

                // ì œëª© ìˆ˜ì •
                const editBtn = document.createElement('button');
                editBtn.className = 'toc-action-btn edit';
                editBtn.innerHTML = 'âœï¸';
                editBtn.title = 'ì œëª© ìˆ˜ì •';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    editChapterTitle(key);
                };
                actions.appendChild(editBtn);

                // ì‚­ì œ
                if (!chapter.isSpecial) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'toc-action-btn delete';
                    deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                    deleteBtn.title = 'ì‚­ì œ';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteChapter(key);
                    };
                    actions.appendChild(deleteBtn);
                }

                header.appendChild(actions);
                li.appendChild(header);

                // í•˜ìœ„ ì±•í„°
                if (chapter.children) {
                    const subUl = document.createElement('ul');
                    subUl.className = 'chapter-tree sub-chapter';
                    renderSubChaptersWithActions(chapter.children, subUl, key);
                    li.appendChild(subUl);
                }

                treeElement.appendChild(li);
            });
            
            // ëª¨ë°”ì¼ ëª©ì°¨ ì—…ë°ì´íŠ¸
            if (window.mobileUI && window.mobileUI.isInitialized) {
                setTimeout(() => window.mobileUI.refreshTocContent(), 100);
            }

        }

        // í•˜ìœ„ ì±•í„° ë Œë”ë§ (ì•¡ì…˜ ë²„íŠ¼ í¬í•¨)
        function renderSubChaptersWithActions(children, parentElement, prefix) {
            const keys = Object.keys(children);
            keys.forEach((key, index) => {
                const child = children[key];
                const fullKey = prefix + '-' + key;
                
                const li = document.createElement('li');
                li.className = 'chapter-item';
                li.dataset.chapterId = fullKey;

                const header = document.createElement('div');
                header.className = 'chapter-item-header';

                // ì œëª© ì˜ì—­ (í† ê¸€ ë²„íŠ¼ + ë§í¬)
                const titleWrapper = document.createElement('div');
                titleWrapper.className = 'chapter-title-wrapper';

                if (child.children) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn expanded';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleChapter(toggleBtn);
                    };
                    titleWrapper.appendChild(toggleBtn);
                }

                const link = document.createElement('a');
                link.className = 'chapter-link' + (chapterData[fullKey]?.content ? ' has-content' : '');
                link.textContent = child.title;
                link.setAttribute('data-id', fullKey);
                link.onclick = () => selectChapter(fullKey);
                titleWrapper.appendChild(link);

                header.appendChild(titleWrapper);

                // ì•¡ì…˜ ë²„íŠ¼ë“¤
                const actions = document.createElement('div');
                actions.className = 'toc-actions';
                
                // ìœ„ë¡œ
                if (index > 0) {
                    const upBtn = document.createElement('button');
                    upBtn.className = 'toc-action-btn up';
                    upBtn.innerHTML = 'â†‘';
                    upBtn.title = 'ìœ„ë¡œ ì´ë™';
                    upBtn.onclick = (e) => {
                        e.stopPropagation();
                        moveChapterUp(fullKey);
                    };
                    actions.appendChild(upBtn);
                }

                // ì•„ë˜ë¡œ
                if (index < keys.length - 1) {
                    const downBtn = document.createElement('button');
                    downBtn.className = 'toc-action-btn down';
                    downBtn.innerHTML = 'â†“';
                    downBtn.title = 'ì•„ë˜ë¡œ ì´ë™';
                    downBtn.onclick = (e) => {
                        e.stopPropagation();
                        moveChapterDown(fullKey);
                    };
                    actions.appendChild(downBtn);
                }

                // ë ˆë²¨ì—… (ì™¼ìª½)
                const leftBtn = document.createElement('button');
                leftBtn.className = 'toc-action-btn left';
                leftBtn.innerHTML = 'â†';
                leftBtn.title = 'ë ˆë²¨ ì˜¬ë¦¬ê¸° (ìƒìœ„ë¡œ)';
                leftBtn.onclick = (e) => {
                    e.stopPropagation();
                    changeLevelUp(fullKey);
                };
                actions.appendChild(leftBtn);

                // ë ˆë²¨ë‹¤ìš´ (ì˜¤ë¥¸ìª½) - ì²« ë²ˆì§¸ê°€ ì•„ë‹ ë•Œë§Œ
                if (index > 0) {
                    const rightBtn = document.createElement('button');
                    rightBtn.className = 'toc-action-btn right';
                    rightBtn.innerHTML = 'â†’';
                    rightBtn.title = 'ë ˆë²¨ ë‚´ë¦¬ê¸° (í•˜ìœ„ë¡œ)';
                    rightBtn.onclick = (e) => {
                        e.stopPropagation();
                        changeLevelDown(fullKey);
                    };
                    actions.appendChild(rightBtn);
                }

                // ìˆ˜ì •
                const editBtn = document.createElement('button');
                editBtn.className = 'toc-action-btn edit';
                editBtn.innerHTML = 'âœï¸';
                editBtn.title = 'ì œëª© ìˆ˜ì •';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    editChapterTitle(fullKey);
                };
                actions.appendChild(editBtn);

                // ì‚­ì œ
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'toc-action-btn delete';
                deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                deleteBtn.title = 'ì‚­ì œ';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteChapter(fullKey);
                };
                actions.appendChild(deleteBtn);

                header.appendChild(actions);
                li.appendChild(header);

                if (child.children) {
                    const subUl = document.createElement('ul');
                    subUl.className = 'chapter-tree sub-sub-chapter';
                    renderSubChaptersWithActions(child.children, subUl, fullKey);
                    li.appendChild(subUl);
                }

                parentElement.appendChild(li);
            });
        }

        // ì±•í„° ìœ„ë¡œ ì´ë™
        function moveChapterUp(chapterId) {
            console.log('ìœ„ë¡œ ì´ë™:', chapterId);
            
            const parts = chapterId.split('-');
            
            // ë¶€ëª¨ ê°ì²´ì™€ í˜„ì¬ ë ˆë²¨ì˜ í‚¤ë“¤ ì°¾ê¸°
            let parent, currentLevel, parentKeys;
            
            if (parts.length === 1) {
                // ìµœìƒìœ„ ë ˆë²¨
                currentLevel = tableOfContents;
                parentKeys = Object.keys(tableOfContents);
            } else {
                // í•˜ìœ„ ë ˆë²¨
                parent = tableOfContents;
                for (let i = 0; i < parts.length - 1; i++) {
                    if (!parent[parts[i]]) return;
                    parent = parent[parts[i]];
                }
                
                if (!parent.children) return;
                currentLevel = parent.children;
                parentKeys = Object.keys(currentLevel);
            }
            
            const lastKey = parts[parts.length - 1];
            const currentIndex = parentKeys.indexOf(lastKey);
            
            if (currentIndex <= 0) {
                showMessage('ì´ë¯¸ ë§¨ ìœ„ì— ìˆìŠµë‹ˆë‹¤.', true);
                return;
            }
            
            // ìœ„ í•­ëª©ê³¼ ìˆœì„œ ë°”ê¾¸ê¸°
            const newKeys = [...parentKeys];
            [newKeys[currentIndex - 1], newKeys[currentIndex]] = [newKeys[currentIndex], newKeys[currentIndex - 1]];
            
            // ê°ì²´ ì¬êµ¬ì„±
            const newLevel = {};
            newKeys.forEach(key => {
                newLevel[key] = currentLevel[key];
            });
            
            // ë¶€ëª¨ ê°ì²´ ì—…ë°ì´íŠ¸
            if (parts.length === 1) {
                Object.keys(tableOfContents).forEach(key => delete tableOfContents[key]);
                Object.assign(tableOfContents, newLevel);
            } else {
                parent.children = newLevel;
            }
            
            saveTOCToLocalStorage();
            renderChapterTreeWithActions();
            showMessage('ìœ„ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.', false);
        }

        // ì±•í„° ì•„ë˜ë¡œ ì´ë™
        function moveChapterDown(chapterId) {
            console.log('ì•„ë˜ë¡œ ì´ë™:', chapterId);
            
            const parts = chapterId.split('-');
            
            // ë¶€ëª¨ ê°ì²´ì™€ í˜„ì¬ ë ˆë²¨ì˜ í‚¤ë“¤ ì°¾ê¸°
            let parent, currentLevel, parentKeys;
            
            if (parts.length === 1) {
                // ìµœìƒìœ„ ë ˆë²¨
                currentLevel = tableOfContents;
                parentKeys = Object.keys(tableOfContents);
            } else {
                // í•˜ìœ„ ë ˆë²¨
                parent = tableOfContents;
                for (let i = 0; i < parts.length - 1; i++) {
                    if (!parent[parts[i]]) return;
                    parent = parent[parts[i]];
                }
                
                if (!parent.children) return;
                currentLevel = parent.children;
                parentKeys = Object.keys(currentLevel);
            }
            
            const lastKey = parts[parts.length - 1];
            const currentIndex = parentKeys.indexOf(lastKey);
            
            if (currentIndex < 0 || currentIndex >= parentKeys.length - 1) {
                showMessage('ì´ë¯¸ ë§¨ ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤.', true);
                return;
            }
            
            // ì•„ë˜ í•­ëª©ê³¼ ìˆœì„œ ë°”ê¾¸ê¸°
            const newKeys = [...parentKeys];
            [newKeys[currentIndex], newKeys[currentIndex + 1]] = [newKeys[currentIndex + 1], newKeys[currentIndex]];
            
            // ê°ì²´ ì¬êµ¬ì„±
            const newLevel = {};
            newKeys.forEach(key => {
                newLevel[key] = currentLevel[key];
            });
            
            // ë¶€ëª¨ ê°ì²´ ì—…ë°ì´íŠ¸
            if (parts.length === 1) {
                Object.keys(tableOfContents).forEach(key => delete tableOfContents[key]);
                Object.assign(tableOfContents, newLevel);
            } else {
                parent.children = newLevel;
            }
            
            saveTOCToLocalStorage();
            renderChapterTreeWithActions();
            showMessage('ì•„ë˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.', false);
        }

        // ë ˆë²¨ ì˜¬ë¦¬ê¸° (ìì‹ â†’ í˜•ì œ)
        function changeLevelUp(chapterId) {
            console.log('ë ˆë²¨ ì˜¬ë¦¬ê¸°:', chapterId);
            
            const parts = chapterId.split('-');
            
            if (parts.length === 1) {
                showMessage('ìµœìƒìœ„ ë ˆë²¨ì€ ë” ì´ìƒ ì˜¬ë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }
            
            // í˜„ì¬ ì±•í„° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const chapter = getChapterById(chapterId);
            if (!chapter) {
                showMessage('ì±•í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }
            
            // ë¶€ëª¨ ì°¾ê¸°
            let parent = tableOfContents;
            for (let i = 0; i < parts.length - 2; i++) {
                if (!parent[parts[i]] || !parent[parts[i]].children) return;
                parent = parent[parts[i]].children;
            }
            
            const parentKey = parts[parts.length - 2];
            const currentKey = parts[parts.length - 1];
            
            if (!parent[parentKey] || !parent[parentKey].children || !parent[parentKey].children[currentKey]) {
                showMessage('êµ¬ì¡° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
                return;
            }
            
            // ì±•í„° ë°ì´í„° ë³µì‚¬ (ê¹Šì€ ë³µì‚¬)
            const chapterData = JSON.parse(JSON.stringify(chapter));
            
            // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì‚­ì œ
            delete parent[parentKey].children[currentKey];
            
            // childrenì´ ë¹„ì–´ìˆìœ¼ë©´ ì‚­ì œ
            if (Object.keys(parent[parentKey].children).length === 0) {
                delete parent[parentKey].children;
            }
            
            // ë¶€ëª¨ì˜ í˜•ì œë¡œ ì¶”ê°€ (ë¶€ëª¨ ë°”ë¡œ ë’¤ì—)
            const parentKeys = Object.keys(parent);
            const parentIndex = parentKeys.indexOf(parentKey);
            
            const newParent = {};
            let inserted = false;
            parentKeys.forEach((key, index) => {
                newParent[key] = parent[key];
                if (index === parentIndex && !inserted) {
                    // ìƒˆ í‚¤ ìƒì„± (ê¸°ì¡´ í‚¤ ìœ ì§€)
                    newParent[currentKey] = chapterData;
                    inserted = true;
                }
            });
            
            // ë¶€ëª¨ ë ˆë²¨ì´ ìµœìƒìœ„ì¸ì§€ í™•ì¸
            if (parts.length === 2) {
                // ìµœìƒìœ„ ë ˆë²¨ ì¬êµ¬ì„±
                Object.keys(tableOfContents).forEach(key => delete tableOfContents[key]);
                Object.assign(tableOfContents, newParent);
            } else {
                // ìƒìœ„ ë ˆë²¨ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
                let grandParent = tableOfContents;
                for (let i = 0; i < parts.length - 3; i++) {
                    grandParent = grandParent[parts[i]].children;
                }
                grandParent[parts[parts.length - 3]].children = newParent;
            }
            
            saveTOCToLocalStorage();
            renderChapterTreeWithActions();
            showMessage('ë ˆë²¨ì„ ì˜¬ë ¸ìŠµë‹ˆë‹¤.', false);
        }

        // ë ˆë²¨ ë‚´ë¦¬ê¸° (í˜•ì œ â†’ ìì‹)
        function changeLevelDown(chapterId) {
            console.log('ë ˆë²¨ ë‚´ë¦¬ê¸°:', chapterId);
            
            const parts = chapterId.split('-');
            const lastKey = parts[parts.length - 1];
            
            // í˜„ì¬ ì±•í„° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const chapter = getChapterById(chapterId);
            if (!chapter) {
                showMessage('ì±•í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }
            
            // ë¶€ëª¨ ê°ì²´ì™€ í˜„ì¬ ë ˆë²¨ì˜ í‚¤ë“¤ ì°¾ê¸°
            let parent, currentLevel, parentKeys;
            
            if (parts.length === 1) {
                // ìµœìƒìœ„ ë ˆë²¨
                currentLevel = tableOfContents;
                parentKeys = Object.keys(tableOfContents);
            } else {
                // í•˜ìœ„ ë ˆë²¨
                parent = tableOfContents;
                for (let i = 0; i < parts.length - 1; i++) {
                    if (!parent[parts[i]]) return;
                    parent = parent[parts[i]];
                }
                
                if (!parent.children) return;
                currentLevel = parent.children;
                parentKeys = Object.keys(currentLevel);
            }
            
            const currentIndex = parentKeys.indexOf(lastKey);
            
            if (currentIndex <= 0) {
                showMessage('ì²« ë²ˆì§¸ í•­ëª©ì€ ë ˆë²¨ì„ ë‚´ë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }
            
            // ë°”ë¡œ ìœ„ í˜•ì œ
            const prevKey = parentKeys[currentIndex - 1];
            const prevSibling = currentLevel[prevKey];
            
            // ì±•í„° ë°ì´í„° ë³µì‚¬ (ê¹Šì€ ë³µì‚¬)
            const chapterData = JSON.parse(JSON.stringify(chapter));
            
            // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì‚­ì œ
            delete currentLevel[lastKey];
            
            // ë°”ë¡œ ìœ„ í˜•ì œì˜ childrenìœ¼ë¡œ ì¶”ê°€
            if (!prevSibling.children) {
                prevSibling.children = {};
            }
            
            // ìƒˆ í‚¤ ìƒì„± (ìì‹ë“¤ì˜ ë§ˆì§€ë§‰ ë²ˆí˜¸ + 1)
            const childKeys = Object.keys(prevSibling.children);
            let newKey = lastKey;
            
            // í‚¤ ì¤‘ë³µ ë°©ì§€
            if (prevSibling.children[newKey]) {
                let counter = 1;
                while (prevSibling.children[newKey + '-' + counter]) {
                    counter++;
                }
                newKey = newKey + '-' + counter;
            }
            
            prevSibling.children[newKey] = chapterData;
            
            saveTOCToLocalStorage();
            renderChapterTreeWithActions();
            showMessage('ë ˆë²¨ì„ ë‚´ë ¸ìŠµë‹ˆë‹¤.', false);
        }

        // ì œëª© ìˆ˜ì •
        function editChapterTitle(chapterId) {
            const chapter = getChapterById(chapterId);
            if (!chapter) return;

            const newTitle = prompt('ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:', chapter.title);
            if (newTitle && newTitle.trim()) {
                chapter.title = newTitle.trim();
                saveTOCToLocalStorage();
                renderChapterTreeWithActions();
                showMessage('ì œëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', false);
            }
        }

        // ì±•í„° ì‚­ì œ
        function deleteChapter(chapterId) {
            const chapter = getChapterById(chapterId);
            if (!chapter) return;

            if (!confirm(`"${chapter.title}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í•˜ìœ„ ì±•í„°ì™€ ë‚´ìš©ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤!`)) {
                return;
            }

            removeChapterById(chapterId);
            saveTOCToLocalStorage();
            renderChapterTreeWithActions();
            showMessage('ì±•í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', false);
        }

        // ìƒˆ ì±•í„° ì¶”ê°€
        function addNewChapter() {
            const titleInput = document.getElementById('newChapterTitle');
            const parentSelect = document.getElementById('newChapterParent');
            
            const title = titleInput.value.trim();
            const parentId = parentSelect.value;

            if (!title) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ìƒˆ ID ìƒì„±
            const newId = generateNewChapterId(parentId);
            
            // ìƒˆ ì±•í„° ê°ì²´
            const newChapter = {
                title: title
            };

            // ë¶€ëª¨ê°€ ìˆìœ¼ë©´ childrenì— ì¶”ê°€, ì—†ìœ¼ë©´ ìµœìƒìœ„ì— ì¶”ê°€
            if (parentId) {
                const parent = getChapterById(parentId);
                if (parent) {
                    if (!parent.children) {
                        parent.children = {};
                    }
                    parent.children[newId] = newChapter;
                }
            } else {
                tableOfContents[newId] = newChapter;
            }

            saveTOCToLocalStorage();
            renderChapterTreeWithActions();
            populateParentSelect();
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            titleInput.value = '';
            parentSelect.value = '';
            
            showMessage(`"${title}" ì±•í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, false);
        }

        // ìƒˆ ì±•í„° ì¶”ê°€ ì·¨ì†Œ
        function cancelAddChapter() {
            document.getElementById('newChapterTitle').value = '';
            document.getElementById('newChapterParent').value = '';
        }

        // ë¶€ëª¨ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        function populateParentSelect() {
            const select = document.getElementById('newChapterParent');
            select.innerHTML = '<option value="">ìµœìƒìœ„ ë ˆë²¨ë¡œ ì¶”ê°€</option>';

            function addOptions(obj, prefix = '', indent = '') {
                Object.keys(obj).forEach(key => {
                    const chapter = obj[key];
                    if (chapter.isSpecial) return; // íŠ¹ìˆ˜ í•­ëª© ì œì™¸
                    
                    const option = document.createElement('option');
                    option.value = prefix + key;
                    option.textContent = indent + chapter.title;
                    select.appendChild(option);

                    if (chapter.children) {
                        addOptions(chapter.children, prefix + key + '-', indent + '  ');
                    }
                });
            }

            addOptions(tableOfContents);
        }

        // ìƒˆ ì±•í„° ID ìƒì„±
        function generateNewChapterId(parentId) {
            if (!parentId) {
                // ìµœìƒìœ„ ë ˆë²¨
                const keys = Object.keys(tableOfContents);
                let maxNum = 0;
                keys.forEach(key => {
                    if (key.startsWith('new')) {
                        const num = parseInt(key.replace('new', '')) || 0;
                        maxNum = Math.max(maxNum, num);
                    }
                });
                return 'new' + (maxNum + 1);
            } else {
                // í•˜ìœ„ ë ˆë²¨
                const parent = getChapterById(parentId);
                if (!parent || !parent.children) return 'new1';
                
                const keys = Object.keys(parent.children);
                let maxNum = 0;
                keys.forEach(key => {
                    const num = parseInt(key) || 0;
                    maxNum = Math.max(maxNum, num);
                });
                return String(maxNum + 1);
            }
        }

        // IDë¡œ ì±•í„° ì°¾ê¸°
        function getChapterById(chapterId) {
            const parts = chapterId.split('-');
            let current = tableOfContents;
            
            for (let i = 0; i < parts.length; i++) {
                if (!current[parts[i]]) return null;
                if (i === parts.length - 1) {
                    return current[parts[i]];
                }
                current = current[parts[i]].children;
                if (!current) return null;
            }
            return null;
        }

        // IDë¡œ ì±•í„° ì‚­ì œ
        function removeChapterById(chapterId) {
            const parts = chapterId.split('-');
            
            if (parts.length === 1) {
                // ìµœìƒìœ„ ë ˆë²¨
                delete tableOfContents[chapterId];
                return;
            }

            // í•˜ìœ„ ë ˆë²¨
            let current = tableOfContents;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!current[parts[i]] || !current[parts[i]].children) return;
                current = current[parts[i]].children;
            }
            delete current[parts[parts.length - 1]];
        }

        // TOCë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        function saveTOCToLocalStorage() {
            localStorage.setItem('tableOfContents', JSON.stringify(tableOfContents));
            updateProgress(); // ì§„í–‰ë¥ ë„ ì—…ë°ì´íŠ¸
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ TOC ë¶ˆëŸ¬ì˜¤ê¸°
        function loadTOCFromLocalStorage() {
            const saved = localStorage.getItem('tableOfContents');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    Object.assign(tableOfContents, loaded);
                    console.log('âœ… ì €ì¥ëœ ëª©ì°¨ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                } catch (e) {
                    console.error('âŒ ëª©ì°¨ ë¡œë“œ ì‹¤íŒ¨:', e);
                }
            }
        }

    </script>
</body>
    <!-- ì œëª© í¸ì§‘ í†µí•© - ëª¨ë“  í•¨ìˆ˜ ì •ì˜ í›„ ë¡œë“œ -->\r\n    <script src="title-integration.js"></script>
    <!-- í¸ì§‘ê¸° ê°œì„  íŒ¨ì¹˜ -->
    <script src="editor-improvements.js"></script>
</html>
