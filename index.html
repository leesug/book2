<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ììœ ì˜ì§€ ì˜ˆì¸¡ - ì§‘í•„ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* ì§„í–‰ë¥  ìƒíƒœ ë°” */
        .progress-bar-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .progress-info h2 {
            font-size: 18px;
            margin: 0;
            font-weight: 600;
        }

        .progress-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .progress-stat {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 500;
        }

        .progress-bar-wrapper {
            flex: 1;
            max-width: 400px;
            margin: 0 30px;
        }

        .progress-bar-bg {
            background: rgba(255,255,255,0.3);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .progress-percentage {
            font-size: 20px;
            font-weight: 700;
            min-width: 60px;
            text-align: right;
        }

        .container {
            display: flex;
            height: calc(100vh - 54px);
        }

        /* ì‚¬ì´ë“œë°” - ëª©ì°¨ */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            flex-shrink: 0;
        }

        .sidebar h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .chapter-tree {
            list-style: none;
        }

        .chapter-item {
            margin: 5px 0;
        }

        .chapter-item-header {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            background: transparent;
            border: 1px solid #ccc;
            border-radius: 3px;
            transition: all 0.2s;
            flex-shrink: 0;
            user-select: none;
        }

        .toggle-btn:hover {
            background: #e0e0e0;
            color: #333;
            border-color: #999;
        }

        .toggle-btn.collapsed::before {
            content: '+';
        }

        .toggle-btn.expanded::before {
            content: 'âˆ’';
        }

        .chapter-link {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #333;
            border-radius: 5px;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }

        .chapter-link:hover {
            background: #f0f0f0;
        }

        .chapter-link.active {
            background: #4CAF50;
            color: white;
        }

        .chapter-link.has-content {
            font-weight: 600;
            color: #4CAF50;
        }

        .chapter-link.has-content.active {
            color: white;
        }

        .sub-chapter {
            margin-left: 25px;
            overflow: hidden;
            max-height: 5000px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .sub-chapter.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        .sub-sub-chapter {
            margin-left: 25px;
            font-size: 13px;
            overflow: hidden;
            max-height: 5000px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .sub-sub-chapter.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
            min-width: 0;
        }

        /* ê¸€ì“°ê¸° ê°€ì´ë“œ íŒ¨ë„ */
        .guide-panel {
            width: 350px;
            background: #f9f9f9;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            flex-shrink: 0;
            display: none;
        }

        .guide-panel.active {
            display: block;
        }

        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }

        .guide-header h3 {
            font-size: 18px;
            color: #333;
            margin: 0;
        }

        .guide-content {
            line-height: 1.8;
            font-size: 14px;
            color: #555;
        }

        .guide-content h4 {
            font-size: 16px;
            color: #4CAF50;
            margin: 20px 0 10px 0;
        }

        .guide-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .guide-content li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .guide-loading {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .guide-loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .btn-guide {
            background: #9C27B0;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-guide:hover {
            background: #7B1FA2;
        }

        .content-header {
            padding: 20px 30px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-header h2 {
            font-size: 22px;
            color: #333;
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-small {
            padding: 5px 12px;
            font-size: 12px;
            background: #607D8B;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: #546E7A;
        }

        /* í¸ì§‘ê¸° ì˜ì—­ */
        .editor-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .view-mode {
            line-height: 1.8;
            font-size: 15px;
            color: #333;
        }

        .view-mode h1 {
            font-size: 28px;
            margin: 30px 0 20px 0;
            color: #222;
        }

        .view-mode h2 {
            font-size: 24px;
            margin: 25px 0 15px 0;
            color: #333;
        }

        .view-mode h3 {
            font-size: 20px;
            margin: 20px 0 10px 0;
            color: #444;
        }

        .view-mode p {
            margin: 15px 0;
        }

        .view-mode hr {
            margin: 30px 0;
            border: none;
            border-top: 2px solid #ddd;
        }

        .view-mode img {
            width: 80%;
            height: auto;
            margin: 20px auto;
            display: block;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .view-mode table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .view-mode table th,
        .view-mode table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .view-mode table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .toolbar {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .toolbar button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .toolbar button:hover {
            background: #f0f0f0;
        }

        #contentEditor {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
            line-height: 1.8;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            resize: vertical;
        }

        .content-editor-editable {
            background: white;
            overflow-y: auto;
            max-height: 600px;
        }

        .content-editor-editable:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .content-editor-editable img {
            width: 80%;
            height: auto;
            margin: 20px auto;
            display: block;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .content-editor-editable p {
            margin: 10px 0;
        }

        .content-editor-editable h1,
        .content-editor-editable h2,
        .content-editor-editable h3 {
            margin: 20px 0 10px 0;
        }

        .content-editor-editable table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .content-editor-editable table th,
        .content-editor-editable table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .content-editor-editable table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        #editorWrapper {
            position: relative;
        }

        #dropOverlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(76, 175, 80, 0.1);
            border: 3px dashed #4CAF50;
            border-radius: 5px;
            z-index: 100;
            pointer-events: none;
        }

        .attachments {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .attachments h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .attachment-list {
            list-style: none;
        }

        .attachment-item {
            padding: 10px;
            background: #f9f9f9;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attachment-item a {
            color: #2196F3;
            text-decoration: none;
        }

        .attachment-item a:hover {
            text-decoration: underline;
        }

        .file-upload-area {
            margin-top: 15px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: #4CAF50;
            background: #f9f9f9;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #999;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .status-message.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
    <!-- ëª©ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ -->
    <script src="toc-manager.js"></script>

</head>
<body>
    <!-- ì§„í–‰ë¥  ìƒíƒœ ë°” -->
    <div class="progress-bar-container">
        <div class="progress-info">
            <h2>ğŸ“š ììœ ì˜ì§€ ì˜ˆì¸¡</h2>
            <div class="progress-stats">
                <span class="progress-stat" id="pagesWritten">0 / 500 í˜ì´ì§€</span>
                <span class="progress-stat" id="chaptersCompleted">0 / 0 ì±•í„°</span>
                <span class="progress-stat" id="totalChars">0 / 337,500 ì</span>
            </div>
        </div>
        <div class="progress-bar-wrapper">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;">
                    <span id="progressBarText"></span>
                </div>
            </div>
        </div>
        <div class="progress-percentage" id="progressPercentage">0%</div>
    </div>

    <div class="container">
        <!-- ì‚¬ì´ë“œë°” - ëª©ì°¨ -->
        <div class="sidebar">
            <h1>ğŸ“– ììœ ì˜ì§€ ì˜ˆì¸¡</h1>
            <div style="margin-bottom: 15px; text-align: right;">
                <button id="collapseAllBtn" class="btn btn-small" style="font-size: 12px; padding: 5px 12px;">
                    âˆ’ ëª¨ë‘ ì ‘ê¸°
                </button>
            </div>
            <ul class="chapter-tree" id="chapterTree">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </ul>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <div class="content-header">
                <h2 id="contentTitle">ì±•í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
                <div class="content-actions" id="contentActions" style="display: none;">
                    <button class="btn btn-secondary" id="editBtn" style="display: none;">ìˆ˜ì •</button>
                    <button class="btn btn-primary" id="saveBtn" style="display: none;">ì €ì¥</button>
                    <button class="btn btn-danger" id="cancelBtn" style="display: none;">ì·¨ì†Œ</button>
                </div>
            </div>

            <div class="editor-area" id="editorArea">
                <div class="empty-state">
                    <h3>ğŸ“ ì§‘í•„ì„ ì‹œì‘í•˜ì„¸ìš”</h3>
                    <p>ì™¼ìª½ ëª©ì°¨ì—ì„œ ì±•í„°ë¥¼ ì„ íƒí•˜ë©´ ë‚´ìš©ì„ ì‘ì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <!-- ê¸€ì“°ê¸° ê°€ì´ë“œ íŒ¨ë„ -->
        <div class="guide-panel" id="guidePanel">
            <div class="guide-header">
                <h3>âœï¸ ê¸€ì“°ê¸° ê°€ì´ë“œ</h3>
                <button class="btn-guide" id="regenerateGuideBtn" onclick="regenerateGuide()">ğŸ”„ ì¬ê°€ì´ë“œ ìƒì„±</button>
            </div>
            <div class="guide-content" id="guideContent">
                <p style="color: #999; text-align: center; padding: 40px 20px;">ì±•í„°ë¥¼ ì„ íƒí•˜ë©´ ê¸€ì“°ê¸° ê°€ì´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <script>
        // API Base URL ì„¤ì • (ë¡œì»¬/í”„ë¡œë•ì…˜ ìë™ ê°ì§€)
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : window.location.origin;
        
        console.log('ğŸ”— API Base URL:', API_BASE_URL);
        
        // ëª©ì°¨ ë°ì´í„°
        const tableOfContents = {
            "bookInfo": {
                title: "ğŸ“‹ ì±… ê¸°ë³¸ ì •ë³´",
                isSpecial: true
            },
            "prologue": {
                title: "í”„ë¡¤ë¡œê·¸: ì¸ë¥˜ì˜ ìˆ™ëª…, ì˜ˆì¸¡ì— ëŒ€í•œ ê°ˆë§",
                children: {
                    "p1": { title: "ì™œ ìš°ë¦¬ëŠ” ì˜ˆì¸¡í•˜ë ¤ í•˜ëŠ”ê°€?" },
                    "p2": { title: "ì˜ˆì¸¡ì˜ ë³¸ëŠ¥: ìƒì¡´ê³¼ ë²ˆì˜ì„ ìœ„í•œ ì¸ë¥˜ì˜ ì—­ì‚¬" },
                    "p3": { title: "ì˜ˆì¸¡ì´ ì„±ê³µí–ˆì„ ë•Œì˜ ë³´ìƒ: ì—­ì‚¬ ì† ì‚¬ë¡€ì™€ í˜„ëŒ€ ì‚¬íšŒì˜ ê°€ì¹˜" },
                    "p4": { title: "ê°™ì€ ì‹¤ìˆ˜ë¥¼ ë°˜ë³µí•˜ëŠ” ì´ìœ : ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥ì„±ì´ ì£¼ëŠ” ì¢Œì ˆê³¼ í˜¼ë€" },
                    "p5": { title: "ì˜ˆì¸¡ì˜ ë‹¹ìœ„ì„±: ë” ë‚˜ì€ ì‚¶ì„ ìœ„í•œ í•„ìˆ˜ì ì¸ ì§€í˜œ" },
                    "p6": { title: "ì˜ˆì¸¡ì„ ìœ„í•œ ì¸ë¥˜ì˜ ë„êµ¬ë“¤: ê³¼í•™ê¸°ìˆ ì—ì„œ ë™ì–‘ì˜ ì§€í˜œê¹Œì§€" },
                    "p7": { title: "ì‹œê°„ê³¼ ê³µê°„ì„ ì½ì–´ë‚´ëŠ” ë„êµ¬: ì‹œê³„, ë‹¬ë ¥, ì²œë¬¸í•™" },
                    "p8": { title: "ìì—° í˜„ìƒ ì˜ˆì¸¡: ë‚ ì”¨ ì˜ˆì¸¡ì˜ ì—­ì‚¬ì™€ ë°œì „" },
                    "p9": { title: "ì‚¬íšŒ í˜„ìƒ ì˜ˆì¸¡: ì—­ì‚¬ì˜ ë°˜ë³µ, ìœ í–‰ì˜ ìˆœí™˜ (íŒ¨ì…˜, ìŒì•…)" },
                    "p10": { title: "ë¹…ë°ì´í„°ì™€ AI: ëª¨ë“  ê³¼í•™ê¸°ìˆ ì€ ì˜ˆì¸¡ì„ í–¥í•œë‹¤" },
                    "p11": { title: "ì˜ˆì¸¡ë§Œì„ ìœ„í•œ í•™ë¬¸: ë™ì–‘ì˜ ì ìˆ ê³¼ ì‚¬ì£¼ëª…ë¦¬" },
                    "p12": { title: "ê³¼í•™ê¸°ìˆ ë¡œ ì„¤ëª…í•  ìˆ˜ ì—†ëŠ” ê¸°í˜¸ì™€ ì˜ì§€ì˜ ë¬¸ì œ" },
                    "p13": { title: "ê²°ê³¼ì™€ ê³¼ì •: ì ìˆ /ì‚¬ì£¼ëª…ë¦¬ê°€ ê°€ì§„ ë…íŠ¹í•œ ì„¤ë“ë ¥" },
                    "p14": { title: "'ë‘ë£¨ë­‰ìˆ í•œ' ì˜ˆì¸¡ì˜ ì˜¤í•´ì™€ 'êµ¬ì²´í™”ëœ' ì˜ˆì¸¡ì˜ ì •í™•ì„±" },
                    "p15": { title: "í•œêµ­, ì˜ˆì¸¡ì˜ íŠ¹ì´ì : ì ìˆ  ì‹œì¥ì˜ ë¹„ë°€" },
                    "p16": { title: "ì „ ì„¸ê³„ ì¸êµ¬ ëŒ€ë¹„ ì••ë„ì ì¸ í•œêµ­ì˜ ì ìˆ  ì‹œì¥" },
                    "p17": { title: "í•œêµ­ ì ìˆ ì˜ íŠ¹ì´ì„±: 'ê³¼ê±° í•´ì†Œ'ë³´ë‹¤ 'ë¯¸ë˜ ì˜ˆì¸¡'ì— ì§‘ì¤‘í•˜ëŠ” ë¬¸í™”" },
                    "p18": { title: "'ì‹ ë“¤ì˜ ë‚˜ë¼' í•œêµ­ì´ ì ìˆ ì— ì—´ê´‘í•˜ëŠ” ì´ìœ " },
                    "p19": { title: "ì ìˆ ê³¼ ì‚¬ì£¼ëª…ë¦¬ì˜ ê²½ê³„, ê·¸ë¦¬ê³  'ì—­ì‚¬ì£¼'ì˜ ë“±ì¥" },
                    "p20": { title: "ì˜ˆì¸¡ íˆ´ë¡œì„œì˜ ì ìˆ ê³¼ ì‚¬ì£¼ëª…ë¦¬ì˜ ê³µí†µì ê³¼ ì°¨ì´ì " },
                    "p21": { title: "ì‚¬ì£¼ëª…ë¦¬: ë‹¬ë ¥ì˜ ì›ë¦¬ì— ê¸°ë°˜í•œ ì—­í•™" },
                    "p22": { title: "ì ìˆ ì˜ ë‘ ê°ˆë˜: ì‚¬ì£¼ëª…ë¦¬ì˜ ë¯¸ë¶„(ì„¸ë¶„í™”) ê°œë…ê³¼ ì‹ ì ‘(ç¥æ¥)ì˜ ì„¸ê³„" },
                    "p23": { title: "ë¹„ê³¼í•™ì  ê·¼ê±°ì— ëŒ€í•œ ë¹„íŒê³¼ ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ë¯¿ëŠ” ì´ìœ " },
                    "p24": { title: "ì˜ˆì¸¡ë¥ ì˜ í•œê³„: 70%ì™€ 55%, ë¯¿ì„ ìˆ˜ ì—†ëŠ” ì˜ˆì¸¡ê³¼ ì†Œë¦„ ë‹ëŠ” ì˜ˆì¸¡" },
                    "p25": { title: "ì‚¬ì£¼ëª…ë¦¬, ì˜¤ë˜ëœ ê¸°ìˆ ì´ ëœ ì´ìœ " },
                    "p26": { title: "ë°˜ë§Œë…„ ì—­ì‚¬ ì†ì—ì„œ 'ì›ë¦¬'ë³´ë‹¤ 'ê¸°ìˆ 'ë¡œ ì „ìˆ˜ëœ ì§€í˜œ" },
                    "p27": { title: "ì–´ì„¤í”„ê²Œ ë§ì§€ë§Œ, ì™œ ë§ëŠ”ì§€ëŠ” ëª°ëë˜ ê³¼ê±°ì˜ í•œê³„" },
                    "p28": { title: "'ë¹„ê¸‰'ê³¼ 'ë¹„ë°€': ì˜ˆì¸¡ì˜ ê°€ì¹˜ê°€ ë§Œë“¤ì–´ë‚¸ íì‡„ì„±" },
                    "p29": { title: "ìƒˆë¡œìš´ ì˜ˆì¸¡ì˜ ì‹œëŒ€: 'ì—­ì‚¬ì£¼'ì˜ íƒ„ìƒ ë°°ê²½" },
                    "p30": { title: "ê³¼ê±°ì˜ ì‹¤ë§ì„ ë„˜ì–´ì„  ìƒˆë¡œìš´ ì‹œë„" },
                    "p31": { title: "'ì˜¤í–‰ì˜ ì •ì²´'ì™€ 'ìš´, ê¸°'ì˜ í˜„ëŒ€ì  ì¬í•´ì„" },
                    "p32": { title: "ì‹œê°„ê³¼ ì—ë„ˆì§€: 'ì—­ì‚¬ì£¼'ê°€ ì˜ˆì¸¡ì˜ ìƒˆë¡œìš´ ì§€í‰ì„ ì—´ë‹¤" }
                }
            },
            "part1": {
                title: "ì œ1ë¶€. 'ì—­ì‚¬ì£¼'ì˜ ê·¼ê°„: ìŒì–‘ì˜¤í–‰, ë³€í™”í•˜ëŠ” ì—ë„ˆì§€",
                children: {
                    "1-1": {
                        title: "ë¬´ê·¹ì—ì„œ ìŒì–‘ìœ¼ë¡œ: ëª¨ë“  ê²ƒì˜ ì‹œì‘",
                        children: {
                            "1-1-1": { title: "ë¬´ê·¹ì˜ ìƒíƒœì™€ ì‹œê°„ì˜ ë°œìƒ" },
                            "1-1-2": { title: "ì—ë„ˆì§€ì™€ ì‹œê°„: ì•„ì¸ìŠˆíƒ€ì¸ì˜ ë°©ì •ì‹ìœ¼ë¡œ ë³¸ ê´€ê³„" },
                            "1-1-3": { title: "ìŒì–‘ì˜ ë°œìƒ: ì—ë„ˆì§€ ì°¨ì´ì— ì˜í•œ í¸ì°¨" },
                            "1-1-4": { title: "ìŒì–‘ì—ì„œ ì˜¤í–‰ìœ¼ë¡œ: ì—ë„ˆì§€ì˜ íë¦„ê³¼ ê· í˜•" },
                            "1-1-5": { title: "ì˜¤í–‰ì˜ ë¶„í™”ì™€ ì—ë„ˆì§€ ì¤€ìœ„" },
                            "1-1-6": { title: "ì˜¤í–‰ì˜ íŠ¹ì„±: ëª©, í™”, í† , ê¸ˆ, ìˆ˜" }
                        }
                    },
                    "1-2": {
                        title: "ê³ ì •ì ì´ì§€ ì•Šì€ ì˜¤í–‰: ë¶ˆë³€í•˜ì§€ ì•Šê³  ë³€í™”í•˜ë©° ìƒëŒ€ì ì¸ ì˜¤í–‰",
                        children: {
                            "1-2-1": { title: "ì‹­ê°„(åå¹²): ë³€í™”í•˜ëŠ” ì˜¤í–‰ì˜ í‘œí˜„" },
                            "1-2-2": { title: "ì²œê°„ì˜ ìŒì–‘ê³¼ ì˜¤í–‰ ë¶„ë¥˜" },
                            "1-2-3": { title: "ì‹­ê°„ì˜ ë¬¼ë¦¬ì /ìì—°ì  íŠ¹ì§•ê³¼ ëŒ€í‘œ ë¬¼ìƒ" }
                        }
                    },
                    "1-3": {
                        title: "ì˜¤í–‰ì˜ ìƒí˜¸ì‘ìš©: ìƒ(ç”Ÿ), ê·¹(å‰‹), ì¶©(æ²–), í•©(åˆ)",
                        children: {
                            "1-3-1": { title: "ì¶©ê³¼ í•©ì˜ íŒŒë™ì  ì¦ëª…: ë³´ê°• ê°„ì„­ê³¼ ìƒì‡„ ê°„ì„­" },
                            "1-3-2": { title: "ì˜¤í–‰ì˜ í•©í™” í˜„ìƒ (êµ´ì ˆ, ì—­í™”)" }
                        }
                    },
                    "1-4": {
                        title: "ì‹­ì„±(åæ˜Ÿ): ì¸ê°„ ë³¸ì—°ì˜ ìš•êµ¬ì™€ ì—ë„ˆì§€",
                        children: {
                            "1-4-1": { title: "ì‹­ì„±ì´ë€ ë¬´ì—‡ì´ë©°, ì™œ ë‚˜íƒ€ë‚˜ëŠ”ê°€" },
                            "1-4-2": { title: "ë³¸ì›(ê¸°ì¤€ ì˜¤í–‰)ê³¼ ì‹­ì„±: ë‚˜ì™€ ì˜¤í–‰ì˜ ê´€ê³„ (ìœ¡ì¹œ)" },
                            "1-4-3": { title: "ì‹­ì„±ì˜ ì›ë¦¬: ì—ë„ˆì§€ ì¤€ìœ„ì™€ ì‹¬ë¦¬ì /í–‰ë™ì  íŠ¹ì„±" }
                        }
                    },
                    "1-5": { title: "í† ì²´(ì§ˆëŸ‰ì²´)ë¥¼ ì§€ë‚˜ëŠ” ì‹­ê°„ì˜ ì§€ì—° í˜„ìƒ: 12ì§€ì§€ì˜ íƒ„ìƒ ì›ë¦¬" }
                }
            },
            "part2": {
                title: "ì œ2ë¶€. ìš´ê³¼ ê¸°: ì‹œê°„ê³¼ ì—ë„ˆì§€ì˜ ì‹¤ì²´ì  ë°œí˜„",
                children: {
                    "2-1": {
                        title: "ìš´(é‹)ê³¼ ê¸°(æ°£)ì˜ ëª…ëª…: ì²œê°„ê³¼ ì§€ì§€",
                        children: {
                            "2-1-1": { title: "ìš´(ì²œê°„): ë•Œ, ì‹œì , ì£¼ê¸°ì  ë³€í™”" },
                            "2-1-2": { title: "ê¸°(ì§€ì§€): ê¸°ì„¸, ì—ë„ˆì§€, í˜, ì£¼ë³€ í™˜ê²½ì˜ ì˜í–¥" },
                            "2-1-3": { title: "ìš´ê¸°(é‹æ°£)ì˜ ì‹¤ì œ: ì²œê°„ì€ ê¸°ë¥¼ ë‹´ëŠ” ê·¸ë¦‡" }
                        }
                    },
                    "2-2": {
                        title: "ìš´ê¸°ì˜ ìì—° í˜„ìƒ: ê³¼í•™ì  ì—°ê²°ê³ ë¦¬",
                        children: {
                            "2-2-1": { title: "ì›ìì˜ ì „ì ì˜¤ë¹„íƒˆê³¼ ì±„ì›€ ìˆœì„œ" },
                            "2-2-2": { title: "ë„íŒŒë¯¼ê³¼ ë„íŒŒë¯¼ ìˆ˜ìš©ì²´" },
                            "2-2-3": { title: "í˜¸ë¥´ëª¬ê³¼ í˜¸ë¥´ëª¬ ìˆ˜ìš©ì²´" },
                            "2-2-4": { title: "ê°ì¢… ë°”ì´ëŸ¬ìŠ¤ì™€ ì ‘ì´‰ ìˆ˜ìš©ì²´" },
                            "2-2-5": { title: "ë‚¨ìì™€ ì—¬ìì˜ ì„±ê¸° ëª¨ìŠµ ì°¨ì´: ìš´ê¸°ì™€ ì§ˆëŸ‰ì²´ì˜ ê´€ê³„" }
                        }
                    },
                    "2-3": {
                        title: "60ê°‘ì: ìš´ê¸°ì˜ ê¸°ë³¸ êµ¬ì„± ì›ë¦¬",
                        children: {
                            "2-3-1": { title: "60ê°‘ìì˜ ì¢…ë¥˜ì™€ ìì²´ íˆ¬ê°„" }
                        }
                    },
                    "2-4": {
                        title: "ì§€ì§€(åœ°æ”¯)ì™€ ì§€ì¥ê°„(åœ°è—å¹²): ìš´ê¸° ë°œí˜„ì˜ ê¹Šì´",
                        children: {
                            "2-4-1": { title: "12ì§€ì§€ì˜ êµ¬ì„±ê³¼ ì§€ì¥ê°„ì˜ ë°œí˜„ ìˆœì„œ" },
                            "2-4-2": { title: "ì§€ì¥ê°„ì˜ ìˆ˜ì¹˜: ê¸°ì˜ í¬ê¸°" }
                        }
                    },
                    "2-5": {
                        title: "íˆ¬ê°„(é€å¹²): ì§€ì¥ê°„ì˜ ì—ë„ˆì§€ê°€ ì²œê°„ìœ¼ë¡œ ë°œí˜„ë˜ëŠ” í˜„ìƒ",
                        children: {
                            "2-5-1": { title: "ì‹ ê°•(èº«å¼º)ê³¼ ì‹ ì•½(èº«å¼±)ì˜ ì¬í•´ì„" }
                        }
                    },
                    "2-6": {
                        title: "ì‚¬ì£¼íŒ”ì: ì‚¶ì˜ ìš´ê¸° êµ¬ì¡°",
                        children: {
                            "2-6-1": { title: "ë…„ì›”ì¼ì‹œ ì‚¬ì£¼ì˜ êµ¬ì„±ê³¼ ì˜ë¯¸" },
                            "2-6-2": { title: "ì‚¬ì£¼ì˜ ê¸°ì : ì¶œìƒ ì‹œì ì— ì •í•´ì§€ëŠ” ìš´ê¸°" },
                            "2-6-3": { title: "ì¼ìƒìƒí™œì—ì„œ ì‚¬ì£¼ì˜ ì‘ë™ ì›ë¦¬ ê²½í—˜" }
                        }
                    },
                    "2-7": {
                        title: "í˜„ìš´(ç¾é‹): ì˜¤ëŠ˜ì˜ ìš´ì„¸ì™€ ì‚¬ì£¼ì˜ ìƒí˜¸ì‘ìš©",
                        children: {
                            "2-7-1": { title: "ì—¬ëŸ¬ ìš´ê¸°ì˜ ë™ì‹œ ì‘ìš© ê³„ì‚°: ìŒì–‘ ì‚¼í•©ë¡ " },
                            "2-7-2": { title: "ìš´ê¸°ì˜ ì‘ë™ ëª¨ë¸: í™€ë¤ ê²Œì„ ë¹„ìœ " }
                        }
                    }
                }
            },
            "part3": {
                title: "ì œ3ë¶€. 'ì—­ì‚¬ì£¼' í•µì‹¬ ì´ë¡ : ë³¸ì› ì´ë™, ìˆ˜ìš©ìš´, í•©í™”",
                children: {
                    "3-1": {
                        title: "ë³¸ì›(æœ¬æº) ì´ë™ë¡ : ì‚¶ì˜ ë³€í™”ë¥¼ ì½ëŠ” ìƒˆë¡œìš´ ê¸°ì¤€ì ",
                        children: {
                            "3-1-1": { title: "ê·¼ë¬˜í™”ì‹¤(æ ¹è‹—èŠ±å¯¦) ì›ë¦¬ë¶€í„° ì‹œì‘í•˜ëŠ” ë³¸ì›ì˜ ë³€í™”" },
                            "3-1-2": { title: "ë³¸ì›ì´ë™ì˜ ì‹œê¸°: 18ë…„ ì£¼ê¸°ì™€ ê·¸ ì¦ê±°" },
                            "3-1-3": { title: "ë‚˜ì´ê°€ ë“¤ìˆ˜ë¡ ì£½ìŒì— ì´ë¥´ëŠ” ê³¼ì •: ìƒëª…ì€ ì†Œìš©ëŒì´ì™€ ê°™ë‹¤" }
                        }
                    },
                    "3-2": {
                        title: "ìˆ˜ìš©ìš´(å—å®¹é‹)ë¡ : ì‹­ê°„ ì›€ì§ì„ì˜ ì›ë¦¬",
                        children: {
                            "3-2-1": { title: "ìŒì–‘ì˜¤í–‰ ì›ë¦¬ì˜ ì„¸ë¶„í™”" },
                            "3-2-2": { title: "í† ì²´(ì§ˆëŸ‰ì²´)ì— ëŒ€í•œ ì§€ì²´ ë° ë³µì‚¬ í˜„ìƒ" },
                            "3-2-3": { title: "ì´ì„±ì§ˆì²´(ì§ìˆ˜): ì˜¤ë¥¸ìª½ ë‚˜ì„ ë§Œ ì¡´ì¬í•˜ëŠ” ì„¸ìƒ" },
                            "3-2-4": { title: "ì²œê°„ì˜ ê°œìˆ˜ ì¦ê°€ê°€ ìš´ì˜ ê°ì†Œë¥¼ ì˜ë¯¸í•˜ëŠ” ì´ìœ " },
                            "3-2-5": { title: "ì§€ì¥ê°„ì˜ í¬ê¸°ì™€ ìš´ì˜ í¬ê¸° ë° ëŠ¥ë ¥" }
                        }
                    },
                    "3-3": {
                        title: "í•©í™”(åˆåŒ–)ë¡ : ìš´ê¸°ì˜ ë¡œë Œì¸  ë‚˜ë¹„ ê³¡ì„ ",
                        children: {
                            "3-3-1": { title: "ì˜¤í–‰ì˜ í•©í™”: ë³¸ë˜ì˜ ì˜¤í–‰ì„ ë²„ë¦¬ê³  ë‹¤ë¥¸ ì˜¤í–‰ìœ¼ë¡œ ë°”ë€ŒëŠ” í˜„ìƒ" },
                            "3-3-2": { title: "ì§€ì¥ê°„ì˜ í¬ê¸°ì™€ í•©í™”: ì˜¤ìš´ì˜ ë‚˜ë¹„" },
                            "3-3-3": { title: "ë¡œë Œì¸ ì˜ ë‚˜ë¹„ ê³¡ì„ ê³¼ í•©í™” í˜„ìƒì˜ ìœ ì‚¬ì„±" }
                        }
                    }
                }
            },
            "part4": {
                title: "ì œ4ë¶€. 'ì—­ì‚¬ì£¼'ì˜ ë‹¤ì–‘í•œ ìš´: ì‚¶ì˜ ì—ë„ˆì§€ë¥¼ ì½ë‹¤",
                children: {
                    "4-1": {
                        title: "ì¸ì²´ì˜ ìš´ê¸°: ì¤‘ìš´(ä¸­é‹)",
                        children: {
                            "4-1-1": { title: "ì¸ë¥˜ ë³´í¸ì˜ ì‹ ì²´ì  íŠ¹ì§•ê³¼ ìš´ê¸° ë³€í™”ì˜ ê´€ê³„" },
                            "4-1-2": { title: "5ë…„ ì£¼ê¸° ì²´ì¤‘ìš´ì˜ ì‹œì‘ê³¼ ë³€í™”" },
                            "4-1-3": { title: "ê²½ë½ì„ í†µí•œ ìš´ê¸°ì˜ ëŠë‚Œ" },
                            "4-1-4": { title: "ê²½ë½ì˜ ìƒì„±ê³¼ ì˜¤í–‰ ë°˜ì‘" },
                            "4-1-5": { title: "ì˜¤í–‰ë³„ ì²´ì§ˆê³¼ íŠ¹ì§•" },
                            "4-1-6": { title: "ì˜¤í–‰ê³¼ í‘œì •: ìš´ê¸°ê°€ ê°ì •ì— ë¯¸ì¹˜ëŠ” ì˜í–¥" }
                        }
                    },
                    "4-2": {
                        title: "ì‚¶ì˜ í° íë¦„: ì²´ì¥ìš´ê³¼ ëŒ€ìš´",
                        children: {
                            "4-2-1": { title: "ëŒ€ìš´: ì›”ìš´ì˜ 10ë…„ ì£¼ê¸° ë³€í™”" },
                            "4-2-2": { title: "ì²´ëŒ€ìš´: ê·¼ë¬˜í™”ì‹¤ì˜ ì›ë¦¬ì— ì˜í•œ 18ë…„ ì£¼ê¸° ë³€í™”" },
                            "4-2-3": { title: "ì—ë„ˆì§€ íë¦„ì— ë”°ë¥¸ ì°¨ì´ ì¸ì‹" }
                        }
                    },
                    "4-3": {
                        title: "í˜„ì¬ì˜ ìš´: í˜„ìš´(ç¾é‹)",
                        children: {
                            "4-3-1": { title: "í˜„ìš´: í˜„ì¬ì˜ ë…„ì›”ì¼ì‹œ ìš´ê¸°" },
                            "4-3-2": { title: "í˜„ìš´ì˜ ë‹¤ì–‘ì„±ê³¼ ê³µí†µ ì ìš©" },
                            "4-3-3": { title: "ì‚¬ì£¼ì™€ í˜„ìš´ì˜ í•©ì³ì§„ í•´ì„ì˜ ì¤‘ìš”ì„±" }
                        }
                    },
                    "4-4": {
                        title: "ì¥ì†Œì˜ ìš´ê¸°: ì§€ìš´ê³¼ ì¥ìš´",
                        children: {
                            "4-4-1": { title: "ì§€ìš´: ì§€êµ¬ì˜ ê²½ë„ë³„/ìœ„ë„ë³„ ì˜¤í–‰ ì„¤ì •ê³¼ ì‘ìš©" },
                            "4-4-2": { title: "ì§€ìš´ì˜ ì‹œê¸°ë³„ ë³€í™”: íƒœì–‘ì˜ ê³ ë„ì™€ ì—ë„ˆì§€ ë³´ì •" },
                            "4-4-3": { title: "ì¥ìš´: 20ë…„ ì£¼ê¸°ì˜ ìš´, í’ìˆ˜ì§€ë¦¬ì™€ ì „ìŸ/ì •ë³µì˜ ì—­ì‚¬" },
                            "4-4-4": { title: "ì§€ìš´ì˜ íŠ¹ì§• ë° ê°œìš´ë²• í™œìš©" }
                        }
                    }
                }
            },
            "part5": {
                title: "ì œ5ë¶€. 'ì—­ì‚¬ì£¼' ì˜ˆì¸¡ì˜ ì™„ì„±: ì¸ìƒ ê·¸ë˜í”„ì™€ ê°œìš´ ì „ëµ",
                children: {
                    "5-1": {
                        title: "ì¸ìƒ ê·¸ë˜í”„ì˜ ë„ì¶œê³¼ ê¸°ë³¸ í•´ì„",
                        children: {
                            "5-1-1": { title: "'ì—­ì‚¬ì£¼' ì¸ìƒ ê·¸ë˜í”„ì˜ ì—­í• " },
                            "5-1-2": { title: "ì¶©ì˜ ì ìš©ê³¼ ê·¸ë˜í”„ í•´ì„" },
                            "5-1-3": { title: "ì‹­ì„±ê³¼ í•©í™”ë¡œ ê·¸ë˜í”„ ë³´ëŠ” ë°©ë²•" }
                        }
                    },
                    "5-2": {
                        title: "ì˜ˆì¸¡ì˜ ì •í™•ì„±ì„ ë†’ì´ëŠ” ì˜¤ì°¨ ìˆ˜ì •",
                        children: {
                            "5-2-1": { title: "ê· ì‹œì°¨ì™€ íƒœì–‘ì‹œ" },
                            "5-2-2": { title: "ë‹¬ë ¥ ì˜¤ì°¨: ì§€êµ¬ ê³µì „ì¼ê³¼ ìœ¤ë…„ì˜ ì˜í–¥" },
                            "5-2-3": { title: "ì¼, ì›”, ë…„ì´ ë°”ë€ŒëŠ” í¬ì¸íŠ¸" },
                            "5-2-4": { title: "ìš´ê¸°ì˜ ë¶ˆí™•ì‹¤ì„±: ë¯¸ë°œê²¬ ìš´ê¸° ë° ì˜ˆì¸¡ì˜ í•œê³„" }
                        }
                    },
                    "5-3": {
                        title: "'ì—­ì‚¬ì£¼' ì‹¤ì „ í•´ì„ ì‚¬ë¡€",
                        children: {
                            "5-3-1": { title: "ì‹¤ì œ ì¸ìƒ ê·¸ë˜í”„ì™€ ì‚¬ë¡€ë¥¼ í†µí•œ í•´ì„ ë°©ë²•" },
                            "5-3-2": { title: "ì‚¬ê³  ì‚¬ë¡€ ë¶„ì„: ìš´ê¸° ì‘ìš© ê³¼ì •" },
                            "5-3-3": { title: "ê¶í•© ì‚¬ë¡€ ë¶„ì„" }
                        }
                    },
                    "5-4": {
                        title: "'ì—­ì‚¬ì£¼'ë¥¼ í†µí•œ ê°œìš´ ì „ëµ",
                        children: {
                            "5-4-1": { title: "ìš´ê¸°ì˜ ì‘ë™ ê³¼ì •: ì™¸ë¶€ ìš´, ê³ ìœ  ìš´, ì„ íƒê³¼ ì˜ì§€" },
                            "5-4-2": { title: "ìš´ì„¸ì˜ ë³€ìˆ˜ ì¡°ì •" },
                            "5-4-3": { title: "ì¢‹ì€ ìš´ì˜ ê·¹ëŒ€í™”ì™€ ë‚˜ìœ ìš´ì˜ íšŒí”¼ ì „ëµ" },
                            "5-4-4": { title: "ê²°í˜¼, ì‚¬ì—…, ì·¨ì—… ë“±ì— ìš´ê¸°ê°€ ë¯¸ì¹˜ëŠ” ì˜í–¥ê³¼ í™œìš©" }
                        }
                    }
                }
            },
            "epilogue": {
                title: "ì—í•„ë¡œê·¸: AI ì‹œëŒ€, 'ì—­ì‚¬ì£¼'ì™€ ìƒìƒí•˜ë‹¤",
                children: {
                    "e1": { title: "AIì™€ì˜ ê²½ìŸê³¼ ìƒìƒ: ì¸ê°„ ì˜ˆì¸¡ì˜ ê°€ì¹˜" },
                    "e2": { title: "'ì—­ì‚¬ì£¼'ê°€ ì œì‹œí•˜ëŠ” ì‚¶ì˜ ìƒˆë¡œìš´ ì§€ë„ì™€ í†µì°°" },
                    "e3": { title: "'ì—­ì‚¬ì£¼' ê³µë¶€ì˜ ì˜ë¯¸ì™€ í™œìš© ë°©ì•ˆ" },
                    "e4": { title: "'ì—­ì‚¬ì£¼'ì˜ í•œê³„ì™€ ê°œìš´ì˜ ê°€ëŠ¥ì„±" }
                }
            }
        };

        let currentChapterId = null;
        let isEditMode = false;
        let originalContent = '';
        let chapterData = {};

        const TOTAL_PAGES = 500;
        const CHARS_PER_PAGE = 675; // A5 ê¸°ì¤€, 25í–‰ Ã— 27ì = 675ì

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            await loadChapterData();
            renderChapterTree();
            updateProgress();
            
            // ëª¨ë‘ ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            const collapseBtn = document.getElementById('collapseAllBtn');
            let isAllCollapsed = false;
            
            collapseBtn.addEventListener('click', () => {
                const allToggles = document.querySelectorAll('.toggle-btn');
                const allSubLists = document.querySelectorAll('.sub-chapter, .sub-sub-chapter');
                
                if (isAllCollapsed) {
                    // ëª¨ë‘ í¼ì¹˜ê¸°
                    allToggles.forEach(btn => {
                        btn.classList.remove('collapsed');
                        btn.classList.add('expanded');
                    });
                    allSubLists.forEach(ul => {
                        ul.classList.remove('collapsed');
                    });
                    collapseBtn.textContent = 'âˆ’ ëª¨ë‘ ì ‘ê¸°';
                    isAllCollapsed = false;
                } else {
                    // ëª¨ë‘ ì ‘ê¸°
                    allToggles.forEach(btn => {
                        btn.classList.remove('expanded');
                        btn.classList.add('collapsed');
                    });
                    allSubLists.forEach(ul => {
                        ul.classList.add('collapsed');
                    });
                    collapseBtn.textContent = '+ ëª¨ë‘ í¼ì¹˜ê¸°';
                    isAllCollapsed = true;
                }
            });
        });

        // ì§„í–‰ë¥  ê³„ì‚°
        function calculateProgress() {
            let totalChars = 0;
            let completedChapters = 0;
            let totalChapters = 0;

            // ëª¨ë“  ì±•í„° ìˆœíšŒ
            function countChapters(obj, prefix = '') {
                Object.keys(obj).forEach(key => {
                    if (key === 'bookInfo') return; // ì±… ê¸°ë³¸ ì •ë³´ëŠ” ì œì™¸
                    
                    const fullKey = prefix ? `${prefix}-${key}` : key;
                    const item = obj[key];

                    if (item.children) {
                        countChapters(item.children, fullKey);
                    } else {
                        totalChapters++;
                        const data = chapterData[fullKey];
                        if (data && data.content) {
                            // HTML íƒœê·¸ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ì¹´ìš´íŠ¸
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = data.content;
                            const textContent = tempDiv.textContent || tempDiv.innerText || '';
                            const chars = textContent.trim().length;
                            
                            if (chars > 0) {
                                totalChars += chars;
                                if (chars >= 100) { // ìµœì†Œ 100ì ì´ìƒì´ë©´ ì™„ë£Œë¡œ ê°„ì£¼
                                    completedChapters++;
                                }
                            }
                        }
                    }
                });
            }

            countChapters(tableOfContents);

            const pagesWritten = Math.floor(totalChars / CHARS_PER_PAGE);
            const percentage = Math.min(100, (pagesWritten / TOTAL_PAGES) * 100);

            return {
                pagesWritten,
                totalPages: TOTAL_PAGES,
                percentage: percentage.toFixed(1),
                completedChapters,
                totalChapters,
                totalChars
            };
        }

        // ì§„í–‰ë¥  UI ì—…ë°ì´íŠ¸
        function updateProgress() {
            const progress = calculateProgress();

            document.getElementById('pagesWritten').textContent = 
                `${progress.pagesWritten} / ${progress.totalPages} í˜ì´ì§€`;
            
            document.getElementById('chaptersCompleted').textContent = 
                `${progress.completedChapters} / ${progress.totalChapters} ì±•í„°`;
            
            // ì´ ê¸€ììˆ˜ í‘œì‹œ (ì²œ ë‹¨ìœ„ ì‰¼í‘œ ì¶”ê°€)
            document.getElementById('totalChars').textContent = 
                `${progress.totalChars.toLocaleString()} / 337,500 ì`;
            
            document.getElementById('progressPercentage').textContent = 
                `${progress.percentage}%`;
            
            const fillElement = document.getElementById('progressBarFill');
            fillElement.style.width = `${progress.percentage}%`;
            
            // ì§„í–‰ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
            const percentage = parseFloat(progress.percentage);
            let gradientColor;
            if (percentage < 30) {
                gradientColor = 'linear-gradient(90deg, #f44336 0%, #e91e63 100%)'; // ë¹¨ê°•
            } else if (percentage < 70) {
                gradientColor = 'linear-gradient(90deg, #FF9800 0%, #FFC107 100%)'; // ë…¸ë‘
            } else {
                gradientColor = 'linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%)'; // ì´ˆë¡
            }
            fillElement.style.background = gradientColor;
            
            if (progress.percentage > 5) {
                document.getElementById('progressBarText').textContent = 
                    `${progress.percentage}%`;
            } else {
                document.getElementById('progressBarText').textContent = '';
            }
        }

        // ì±•í„° ë°ì´í„° ë¡œë“œ
        async function loadChapterData() {
            try {
                const response = await fetch('/api/chapters');
                chapterData = await response.json();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            }
        }

        // ëª©ì°¨ íŠ¸ë¦¬ ë Œë”ë§
        function renderChapterTree() {
            const treeElement = document.getElementById('chapterTree');
            treeElement.innerHTML = '';

            Object.keys(tableOfContents).forEach(key => {
                const chapter = tableOfContents[key];
                const li = document.createElement('li');
                li.className = 'chapter-item';

                // í—¤ë” ì»¨í…Œì´ë„ˆ ìƒì„±
                const header = document.createElement('div');
                header.className = 'chapter-item-header';

                // ìì‹ì´ ìˆìœ¼ë©´ í† ê¸€ ë²„íŠ¼ ì¶”ê°€
                if (chapter.children) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn expanded';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleChapter(toggleBtn);
                    };
                    header.appendChild(toggleBtn);
                }

                const link = document.createElement('a');
                link.className = 'chapter-link' + (chapterData[key]?.content ? ' has-content' : '');
                link.textContent = chapter.title;
                link.onclick = () => selectChapter(key);

                header.appendChild(link);
                li.appendChild(header);

                if (chapter.children) {
                    const subUl = document.createElement('ul');
                    subUl.className = 'chapter-tree sub-chapter';
                    renderSubChapters(chapter.children, subUl, key);
                    li.appendChild(subUl);
                }

                treeElement.appendChild(li);
            });
        }

        // í•˜ìœ„ ì±•í„° ë Œë”ë§
        function renderSubChapters(children, parentElement, prefix) {
            Object.keys(children).forEach(key => {
                const child = children[key];
                const fullKey = prefix + '-' + key;
                
                const li = document.createElement('li');
                li.className = 'chapter-item';

                // í—¤ë” ì»¨í…Œì´ë„ˆ ìƒì„±
                const header = document.createElement('div');
                header.className = 'chapter-item-header';

                // ìì‹ì´ ìˆìœ¼ë©´ í† ê¸€ ë²„íŠ¼ ì¶”ê°€
                if (child.children) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn expanded';
                    toggleBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleChapter(toggleBtn);
                    };
                    header.appendChild(toggleBtn);
                }

                const link = document.createElement('a');
                link.className = 'chapter-link' + (chapterData[fullKey]?.content ? ' has-content' : '');
                link.textContent = child.title;
                link.onclick = () => selectChapter(fullKey);

                header.appendChild(link);
                li.appendChild(header);

                if (child.children) {
                    const subUl = document.createElement('ul');
                    subUl.className = 'chapter-tree sub-sub-chapter';
                    renderSubChapters(child.children, subUl, fullKey);
                    li.appendChild(subUl);
                }

                parentElement.appendChild(li);
            });
        }

        // ì±•í„° í† ê¸€ (ì ‘ê¸°/í¼ì¹˜ê¸°)
        function toggleChapter(button) {
            const li = button.closest('.chapter-item');
            const subList = li.querySelector('ul');
            
            if (!subList) return;

            if (button.classList.contains('expanded')) {
                // ì ‘ê¸°
                button.classList.remove('expanded');
                button.classList.add('collapsed');
                subList.classList.add('collapsed');
            } else {
                // í¼ì¹˜ê¸°
                button.classList.remove('collapsed');
                button.classList.add('expanded');
                subList.classList.remove('collapsed');
            }
        }

        // ì±•í„° ì„ íƒ
        async function selectChapter(chapterId) {
            if (isEditMode && currentChapterId !== chapterId) {
                if (!confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }

            currentChapterId = chapterId;
            
            // ëª¨ë“  ë§í¬ì—ì„œ active ì œê±°
            document.querySelectorAll('.chapter-link').forEach(link => {
                link.classList.remove('active');
            });

            // í˜„ì¬ ë§í¬ì— active ì¶”ê°€
            event.target.classList.add('active');

            // ì±•í„° ë°ì´í„° ë¡œë“œ
            await loadChapterContent(chapterId);
            
            // ê°€ì´ë“œ íŒ¨ë„ í‘œì‹œ ë° ê°€ì´ë“œ ìƒì„±
            showGuidePanel();
            await generateGuide(chapterId);
        }

        // ì±•í„° ë‚´ìš© ë¡œë“œ
        async function loadChapterContent(chapterId) {
            try {
                const response = await fetch(`/api/chapters/${chapterId}`);
                const data = await response.json();

                const title = getChapterTitle(chapterId);
                document.getElementById('contentTitle').textContent = title;
                document.getElementById('contentActions').style.display = 'flex';

                if (data.content) {
                    // ë‚´ìš©ì´ ìˆìœ¼ë©´ ë·° ëª¨ë“œë¡œ í‘œì‹œ
                    renderViewMode(data);
                } else {
                    // ë‚´ìš©ì´ ì—†ìœ¼ë©´ ë°”ë¡œ í¸ì§‘ ëª¨ë“œ
                    enterEditMode({ content: '', attachments: [] });
                }
            } catch (error) {
                console.error('ì±•í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ì±•í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            }
        }

        // ì±•í„° ì œëª© ê°€ì ¸ì˜¤ê¸°
        function getChapterTitle(chapterId) {
            const parts = chapterId.split('-');
            
            if (parts.length === 1) {
                return tableOfContents[parts[0]]?.title || '';
            } else if (parts.length === 2) {
                return tableOfContents[parts[0]]?.children[parts[1]]?.title || '';
            } else if (parts.length === 3) {
                return tableOfContents[parts[0]]?.children[parts[1]]?.children[parts[2]]?.title || '';
            }
            
            return '';
        }

        // ë·° ëª¨ë“œ ë Œë”ë§
        function renderViewMode(data) {
            isEditMode = false;
            document.getElementById('editBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';

            const editorArea = document.getElementById('editorArea');
            editorArea.innerHTML = `
                <div class="view-mode">
                    ${data.content}
                </div>
                ${renderAttachments(data.attachments || [], false)}
            `;
        }

        // í¸ì§‘ ëª¨ë“œ ì§„ì…
        function enterEditMode(data) {
            isEditMode = true;
            originalContent = data.content;
            
            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'inline-block';

            const editorArea = document.getElementById('editorArea');
            editorArea.innerHTML = `
                <div class="toolbar">
                    <button onclick="insertFormat('h1')">ì œëª© 1</button>
                    <button onclick="insertFormat('h2')">ì œëª© 2</button>
                    <button onclick="insertFormat('h3')">ì œëª© 3</button>
                    <button onclick="insertFormat('hr')">êµ¬ë¶„ì„ </button>
                    <button onclick="insertFormat('table')">í‘œ ì‚½ì…</button>
                    <button onclick="insertFormat('bold')">êµµê²Œ</button>
                    <button onclick="insertFormat('italic')">ê¸°ìš¸ì„</button>
                    <button onclick="document.getElementById('imageInput').click()" style="background: #FF9800; color: white;">ğŸ–¼ï¸ ì´ë¯¸ì§€</button>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="insertImage(this)">
                </div>
                <div id="editorWrapper" style="position: relative;">
                    <div id="contentEditor" contenteditable="true" class="content-editor-editable">${data.content || '<p>ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...</p>'}</div>
                    <div id="dropOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(76, 175, 80, 0.1); border: 3px dashed #4CAF50; border-radius: 5px; display: flex; align-items: center; justify-content: center; pointer-events: none;">
                        <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h3 style="color: #4CAF50; margin: 0;">ğŸ–¼ï¸ ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”</h3>
                        </div>
                    </div>
                </div>
                ${renderAttachments(data.attachments || [], true)}
            `;

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì„¤ì •
            setupDragAndDrop();
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDragAndDrop() {
            const editor = document.getElementById('contentEditor');
            const overlay = document.getElementById('dropOverlay');
            let dragCounter = 0;

            editor.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter++;
                if (overlay) {
                    overlay.style.display = 'flex';
                }
            });

            editor.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter--;
                if (dragCounter === 0 && overlay) {
                    overlay.style.display = 'none';
                }
            });

            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            editor.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter = 0;
                if (overlay) {
                    overlay.style.display = 'none';
                }

                const files = e.dataTransfer.files;
                if (files.length === 0) return;

                // ì´ë¯¸ì§€ íŒŒì¼ë§Œ í•„í„°ë§
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                
                if (imageFiles.length === 0) {
                    showMessage('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ë“œë¡­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', true);
                    return;
                }

                // ê° ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì‚½ì…
                for (const file of imageFiles) {
                    await uploadAndInsertImageAtCursor(file);
                }
            });
        }

        // ì»¤ì„œ ìœ„ì¹˜ì— ì´ë¯¸ì§€ ì‚½ì…
        async function uploadAndInsertImageAtCursor(file) {
            showMessage('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const editor = document.getElementById('contentEditor');
                    const imageHTML = `<br><br><img src="${result.path}" alt="${result.originalname}" style="width: 80%; height: auto; margin: 20px auto; display: block;"><br><br>`;
                    
                    if (editor.contentEditable === 'true') {
                        // contenteditableì˜ ê²½ìš° í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…
                        editor.focus();
                        document.execCommand('insertHTML', false, imageHTML);
                    } else {
                        // textareaì˜ ê²½ìš° (í•˜ìœ„ í˜¸í™˜ì„±)
                        const cursorPos = editor.selectionStart;
                        editor.value = editor.value.substring(0, cursorPos) + imageHTML + editor.value.substring(cursorPos);
                        editor.focus();
                        editor.selectionStart = editor.selectionEnd = cursorPos + imageHTML.length;
                    }
                    
                    showMessage('ì´ë¯¸ì§€ê°€ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return true;
                } else {
                    showMessage('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                    return false;
                }
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                return false;
            }
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì‚½ì… (ê³µí†µ í•¨ìˆ˜)
        async function uploadAndInsertImage(file, cursorPos) {
            showMessage('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const editor = document.getElementById('contentEditor');
                    // ì¤„ë°”ê¿ˆ 2ê°œì”© ì¶”ê°€í•˜ì—¬ ì´ë¯¸ì§€ ì•ë’¤ë¡œ ì—¬ë°± ìƒì„±, ê°€ë¡œ 80%ë¡œ ì„¤ì •
                    const imageTag = `<br><br><img src="${result.path}" alt="${result.originalname}" style="width: 80%; height: auto; margin: 20px auto; display: block;"><br><br>`;
                    
                    // contenteditable divì¸ ê²½ìš°
                    if (editor.contentEditable === 'true') {
                        const imgElement = document.createElement('div');
                        imgElement.innerHTML = imageTag;
                        
                        // í˜„ì¬ ì„ íƒ ì˜ì—­ì— ì‚½ì…
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            range.deleteContents();
                            range.insertNode(imgElement.firstChild);
                        }
                    } else {
                        // textareaì¸ ê²½ìš° (í•˜ìœ„ í˜¸í™˜ì„±)
                        editor.value = editor.value.substring(0, cursorPos) + imageTag + editor.value.substring(cursorPos);
                        editor.focus();
                        editor.selectionStart = editor.selectionEnd = cursorPos + imageTag.length;
                    }
                    
                    showMessage('ì´ë¯¸ì§€ê°€ ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return true;
                } else {
                    showMessage('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                    return false;
                }
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                return false;
            }
        }

        // ì„œì‹ ì‚½ì…
        function insertFormat(type) {
            const editor = document.getElementById('contentEditor');
            
            // contenteditable divì¸ ê²½ìš°
            if (editor.contentEditable === 'true') {
                editor.focus();
                
                switch(type) {
                    case 'h1':
                        document.execCommand('formatBlock', false, '<h1>');
                        break;
                    case 'h2':
                        document.execCommand('formatBlock', false, '<h2>');
                        break;
                    case 'h3':
                        document.execCommand('formatBlock', false, '<h3>');
                        break;
                    case 'hr':
                        document.execCommand('insertHTML', false, '<hr>');
                        break;
                    case 'table':
                        const tableHTML = `<table>
    <tr>
        <th>í—¤ë”1</th>
        <th>í—¤ë”2</th>
        <th>í—¤ë”3</th>
    </tr>
    <tr>
        <td>ë°ì´í„°1</td>
        <td>ë°ì´í„°2</td>
        <td>ë°ì´í„°3</td>
    </tr>
</table><br>`;
                        document.execCommand('insertHTML', false, tableHTML);
                        break;
                    case 'bold':
                        document.execCommand('bold', false, null);
                        break;
                    case 'italic':
                        document.execCommand('italic', false, null);
                        break;
                }
            } else {
                // textareaì¸ ê²½ìš° (í•˜ìœ„ í˜¸í™˜ì„±)
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const selectedText = editor.value.substring(start, end);
                let insertText = '';

                switch(type) {
                    case 'h1':
                        insertText = `<h1>${selectedText || 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'}</h1>\n`;
                        break;
                    case 'h2':
                        insertText = `<h2>${selectedText || 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'}</h2>\n`;
                        break;
                    case 'h3':
                        insertText = `<h3>${selectedText || 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'}</h3>\n`;
                        break;
                    case 'hr':
                        insertText = '<hr>\n';
                        break;
                    case 'table':
                        insertText = `<table>
    <tr>
        <th>í—¤ë”1</th>
        <th>í—¤ë”2</th>
        <th>í—¤ë”3</th>
    </tr>
    <tr>
        <td>ë°ì´í„°1</td>
        <td>ë°ì´í„°2</td>
        <td>ë°ì´í„°3</td>
    </tr>
</table>\n`;
                        break;
                    case 'bold':
                        insertText = `<strong>${selectedText || 'êµµê²Œ'}</strong>`;
                        break;
                    case 'italic':
                        insertText = `<em>${selectedText || 'ê¸°ìš¸ì„'}</em>`;
                        break;
                }

                editor.value = editor.value.substring(0, start) + insertText + editor.value.substring(end);
                editor.focus();
            }
        }

        // ì²¨ë¶€íŒŒì¼ ë Œë”ë§
        function renderAttachments(attachments, editMode) {
            if (!attachments || attachments.length === 0) {
                if (!editMode) return '';
            }

            let html = '<div class="attachments"><h3>ğŸ“ ì²¨ë¶€íŒŒì¼</h3>';
            
            if (attachments.length > 0) {
                html += '<ul class="attachment-list">';
                attachments.forEach((file, index) => {
                    html += `
                        <li class="attachment-item">
                            <a href="${file.path}" target="_blank">${file.originalname}</a>
                            ${editMode ? `<button class="btn btn-danger" onclick="removeAttachment(${index})">ì‚­ì œ</button>` : ''}
                        </li>
                    `;
                });
                html += '</ul>';
            }

            if (editMode) {
                html += `
                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" onchange="uploadFile(this)" multiple>
                        <p>ğŸ“ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”</p>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // ì´ë¯¸ì§€ ì‚½ì… (ë²„íŠ¼ í´ë¦­)
        async function insertImage(input) {
            if (!input.files || input.files.length === 0) return;

            const file = input.files[0];
            
            // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
            if (!file.type.startsWith('image/')) {
                showMessage('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì‚½ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', true);
                input.value = '';
                return;
            }

            await uploadAndInsertImageAtCursor(file);
            input.value = '';
        }

        // íŒŒì¼ ì—…ë¡œë“œ (ì²¨ë¶€íŒŒì¼ìš©)
        async function uploadFile(input) {
            if (!input.files || input.files.length === 0) return;

            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // í˜„ì¬ ì±•í„° ë°ì´í„°ì— ì²¨ë¶€íŒŒì¼ ì¶”ê°€
                    const data = await fetch(`/api/chapters/${currentChapterId}`).then(r => r.json());
                    if (!data.attachments) data.attachments = [];
                    data.attachments.push({
                        filename: result.filename,
                        originalname: result.originalname,
                        path: result.path
                    });

                    // UI ì—…ë°ì´íŠ¸
                    enterEditMode(data);
                } else {
                    showMessage('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                }
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            }

            input.value = '';
        }

        // ì²¨ë¶€íŒŒì¼ ì‚­ì œ
        function removeAttachment(index) {
            if (!confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            // í˜„ì¬ ë°ì´í„°ì—ì„œ ì²¨ë¶€íŒŒì¼ ì œê±°
            fetch(`/api/chapters/${currentChapterId}`)
                .then(r => r.json())
                .then(data => {
                    data.attachments.splice(index, 1);
                    enterEditMode(data);
                    showMessage('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                });
        }

        // ì €ì¥
        async function saveContent() {
            const editor = document.getElementById('contentEditor');
            // contenteditable divì¸ ê²½ìš° innerHTML, textareaì¸ ê²½ìš° value ì‚¬ìš©
            const content = editor.contentEditable === 'true' ? editor.innerHTML : editor.value;
            
            const response = await fetch(`/api/chapters/${currentChapterId}`);
            const currentData = await response.json();

            try {
                const saveResponse = await fetch(`/api/chapters/${currentChapterId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        attachments: currentData.attachments || []
                    })
                });

                const result = await saveResponse.json();
                
                if (result.success) {
                    showMessage('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await loadChapterData();
                    renderChapterTree();
                    await loadChapterContent(currentChapterId);
                } else {
                    showMessage('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
                }
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                showMessage('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            }
        }

        // ì·¨ì†Œ
        function cancelEdit() {
            if (confirm('ë³€ê²½ì‚¬í•­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                loadChapterContent(currentChapterId);
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(message, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'status-message' + (isError ? ' error' : '');
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ê°€ì´ë“œ íŒ¨ë„ í‘œì‹œ
        function showGuidePanel() {
            document.getElementById('guidePanel').classList.add('active');
        }

        // ê°€ì´ë“œ ìƒì„±
        async function generateGuide(chapterId, existingContent = '') {
            const guideContent = document.getElementById('guideContent');
            guideContent.innerHTML = '<div class="guide-loading">AIê°€ ê¸€ì“°ê¸° ê°€ì´ë“œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>';

            try {
                const title = getChapterTitle(chapterId);
                const bookContext = `
ë„ì„œ ì œëª©: ììœ ì˜ì§€ ì˜ˆì¸¡
ë„ì„œ ì£¼ì œ: ëª…ë¦¬ ì´ë¡ ì— ëŒ€í•œ ìƒˆë¡œìš´ ì ‘ê·¼ ë°©ë²• (ì—­ì‚¬ì£¼)
íƒ€ê²Ÿ ë…ì: 45-60ì„¸, 25-30ì„¸ ë…ì
ë¬¸ì²´: ì „ë¬¸ì„±ê³¼ ì§„ì¤‘í•¨ì„ ìœ ì§€í•˜ë©´ì„œë„ ì´í•´í•˜ê¸° ì‰¬ìš´ ë¹„ë¬¸í•™ ìŠ¤íƒ€ì¼
`;

                // ì „ì²´ ëª©ì°¨ë¥¼ ì½ê¸° ì‰¬ìš´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                const tocText = generateTableOfContentsText();

                const response = await fetch('/api/generate-guide', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        existingContent: existingContent,
                        bookContext: bookContext,
                        tableOfContents: tocText,
                        currentChapterId: chapterId
                    })
                });

                const data = await response.json();
                
                if (data.success && data.guide) {
                    guideContent.innerHTML = data.guide;
                } else {
                    guideContent.innerHTML = `<p style="color: #f44336;">ê°€ì´ë“œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">
                        â€» AI ê°€ì´ë“œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Anthropic API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
                        ì„œë²„ ì‹¤í–‰ ì‹œ í™˜ê²½ë³€ìˆ˜ ANTHROPIC_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.<br>
                        ìì„¸í•œ ë‚´ìš©ì€ API_KEY_SETUP.md íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.
                    </p>`;
                }
            } catch (error) {
                console.error('ê°€ì´ë“œ ìƒì„± ì‹¤íŒ¨:', error);
                guideContent.innerHTML = `<p style="color: #f44336;">ê°€ì´ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 12px; color: #999; margin-top: 10px;">
                    ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
                </p>`;
            }
        }

        // ì „ì²´ ëª©ì°¨ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        function generateTableOfContentsText() {
            let text = '';
            
            Object.keys(tableOfContents).forEach(key => {
                const chapter = tableOfContents[key];
                text += `\n${chapter.title}\n`;
                
                if (chapter.children) {
                    Object.keys(chapter.children).forEach(subKey => {
                        const subChapter = chapter.children[subKey];
                        text += `  - ${subChapter.title}\n`;
                        
                        if (subChapter.children) {
                            Object.keys(subChapter.children).forEach(subSubKey => {
                                const subSubChapter = subChapter.children[subSubKey];
                                text += `    â€¢ ${subSubChapter.title}\n`;
                            });
                        }
                    });
                }
            });
            
            return text;
        }

        // ì¬ê°€ì´ë“œ ìƒì„±
        async function regenerateGuide() {
            if (!currentChapterId) {
                showMessage('ì±•í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', true);
                return;
            }

            const editor = document.getElementById('contentEditor');
            let currentContent = '';
            
            if (editor) {
                // í¸ì§‘ ëª¨ë“œì¸ ê²½ìš°
                currentContent = editor.contentEditable === 'true' ? editor.innerHTML : editor.value;
            } else {
                // ë·° ëª¨ë“œì¸ ê²½ìš° - ì €ì¥ëœ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                try {
                    const response = await fetch(`/api/chapters/${currentChapterId}`);
                    const data = await response.json();
                    currentContent = data.content || '';
                } catch (error) {
                    console.error('ë‚´ìš© ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            // HTML íƒœê·¸ ì œê±°í•˜ì—¬ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ (ë¶„ì„ìš©)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentContent;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';

            // ë‚´ìš©ì´ ìˆë“  ì—†ë“  ê°€ì´ë“œ ìƒì„±
            // ë‚´ìš©ì´ ìˆìœ¼ë©´: ë‚´ìš© ë¶„ì„ + ë³´ì¶©/ìˆ˜ì • ì œì•ˆ
            // ë‚´ìš©ì´ ì—†ìœ¼ë©´: ëª©ì°¨ ê¸°ë°˜ ì‘ì„± ê°€ì´ë“œ
            if (textContent.trim().length > 0) {
                showMessage('ì‘ì„±ëœ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ì¬ê°€ì´ë“œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            } else {
                showMessage('ì±•í„° ì œëª©ê³¼ ëª©ì°¨ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°€ì´ë“œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
            }
            
            await generateGuide(currentChapterId, textContent.trim());
        }

        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('editBtn').addEventListener('click', async () => {
            const response = await fetch(`/api/chapters/${currentChapterId}`);
            const data = await response.json();
            enterEditMode(data);
        });

        document.getElementById('saveBtn').addEventListener('click', saveContent);
        document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
    </script>
</body>
    <!-- ì œëª© í¸ì§‘ í†µí•© - ëª¨ë“  í•¨ìˆ˜ ì •ì˜ í›„ ë¡œë“œ -->\r\n    <script src="title-integration.js"></script>
</html>
